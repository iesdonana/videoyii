<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="language" content="en" />
        <link href="./assets/90d046f2/css/bootstrap.css" rel="stylesheet">
<link href="./assets/c6368d94/solarized_light.css" rel="stylesheet">
<link href="./assets/9f5cdd92/style.css" rel="stylesheet">
<script src="./assets/a6e53573/jquery.js"></script>
<script src="./assets/90d046f2/js/bootstrap.js"></script>
<script src="./assets/218ce2e5/jssearch.js"></script>    <title>Query Builder - Làm việc với Databases - The Definitive Guide to Yii 2.0</title>
</head>
<body>

<div class="wrap">
    <nav id="w11932" class="navbar-inverse navbar-fixed-top navbar" role="navigation"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#w11932-collapse"><span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span></button><a class="navbar-brand" href="./guide-index.html">The Definitive Guide to Yii 2.0</a></div><div id="w11932-collapse" class="collapse navbar-collapse"><ul id="w11933" class="navbar-nav nav"><li><a href="./guide-README.html">Guide</a></li></ul><div class="navbar-form navbar-left" role="search">
  <div class="form-group">
    <input id="searchbox" type="text" class="form-control" placeholder="Search">
  </div>
</div>
</div></nav>
    <div id="search-resultbox" style="display: none;" class="modal-content">
        <ul id="search-results">
        </ul>
    </div>

    
<div class="row">
    <div class="col-md-2">
                <div id="navigation" class="list-group"><a class="list-group-item" href="#navigation-11916" data-toggle="collapse" data-parent="#navigation">Giới thiệu <b class="caret"></b></a><div id="navigation-11916" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-intro-yii.html">Về Yii</a>
<a class="list-group-item" href="./guide-intro-upgrade-from-v1.html">Nâng cấp lên từ phiên bản 1.1</a></div>
<a class="list-group-item" href="#navigation-11917" data-toggle="collapse" data-parent="#navigation">Bắt đầu <b class="caret"></b></a><div id="navigation-11917" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-start-installation.html">Cài đặt Yii</a>
<a class="list-group-item" href="./guide-start-workflow.html">Thực hiện chạy ứng dụng</a>
<a class="list-group-item" href="./guide-start-hello.html">Viết lời chào đầu tiên</a>
<a class="list-group-item" href="./guide-start-forms.html">Làm việc với Forms</a>
<a class="list-group-item" href="./guide-start-databases.html">Làm việc với Databases</a>
<a class="list-group-item" href="./guide-start-gii.html">Sử dụng Gii để sinh code</a>
<a class="list-group-item" href="./guide-start-looking-ahead.html">Mức cao hơn</a></div>
<a class="list-group-item" href="#navigation-11918" data-toggle="collapse" data-parent="#navigation">Kiến trúc ứng dụng (Application Structure) <b class="caret"></b></a><div id="navigation-11918" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-structure-overview.html">Tổng quan về kiến trúc ứng dụng</a>
<a class="list-group-item" href="./guide-structure-entry-scripts.html">Mục Scripts</a>
<a class="list-group-item" href="./guide-structure-applications.html">Ứng dụng (Applications)</a>
<a class="list-group-item" href="./guide-structure-application-components.html">Thành phần ứng dụng</a>
<a class="list-group-item" href="./guide-structure-controllers.html">Bộ điều khiển (Controllers)</a>
<a class="list-group-item" href="./guide-structure-models.html">Models</a>
<a class="list-group-item" href="./guide-structure-views.html">Views</a>
<a class="list-group-item" href="./guide-structure-modules.html">Modules</a>
<a class="list-group-item" href="./guide-structure-filters.html">Bộ lọc (Filters)</a>
<a class="list-group-item" href="./guide-structure-widgets.html">Widgets</a>
<a class="list-group-item" href="./guide-structure-assets.html">Assets</a>
<a class="list-group-item" href="./guide-structure-extensions.html">Phần mở rộng (Extensions)</a></div>
<a class="list-group-item" href="#navigation-11919" data-toggle="collapse" data-parent="#navigation">Yêu cầu xử lý (Handling Requests) <b class="caret"></b></a><div id="navigation-11919" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-runtime-overview.html">Tổng quan</a>
<a class="list-group-item" href="./guide-runtime-bootstrapping.html">Bootstrapping</a>
<a class="list-group-item" href="./guide-runtime-routing.html">Routing và URL Creation</a>
<a class="list-group-item" href="./guide-runtime-requests.html">Yêu cầu (Requests)</a>
<a class="list-group-item" href="./guide-runtime-responses.html">Responses</a>
<a class="list-group-item" href="./guide-runtime-sessions-cookies.html">Sessions và Cookies</a>
<a class="list-group-item" href="./guide-runtime-handling-errors.html">Xử lý lỗi (Handling Error)</a>
<a class="list-group-item" href="./guide-runtime-logging.html">Logging</a></div>
<a class="list-group-item" href="#navigation-11920" data-toggle="collapse" data-parent="#navigation">Các khái niệm chính <b class="caret"></b></a><div id="navigation-11920" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-concept-components.html">Thành phần (Components)</a>
<a class="list-group-item" href="./guide-concept-properties.html">Thuộc tính (Properties)</a>
<a class="list-group-item" href="./guide-concept-events.html">Sự kiện (Events)</a>
<a class="list-group-item" href="./guide-concept-behaviors.html">Hành vi (Behaviors)</a>
<a class="list-group-item" href="./guide-concept-configurations.html">Cấu hình (Configurations)</a>
<a class="list-group-item" href="./guide-concept-aliases.html">Bí danh (Aliases)</a>
<a class="list-group-item" href="./guide-concept-autoloading.html">Lớp tự động nạp (Autoloading)</a>
<a class="list-group-item" href="./guide-concept-service-locator.html">Service Locator</a>
<a class="list-group-item" href="./guide-concept-di-container.html">Dependency Injection Container</a></div>
<a class="list-group-item active" href="#navigation-11921" data-toggle="collapse" data-parent="#navigation">Làm việc với Databases <b class="caret"></b></a><div id="navigation-11921" class="submenu panel-collapse collapse in"><a class="list-group-item" href="./guide-db-dao.html">Data Access Objects</a>
<a class="list-group-item active" href="./guide-db-query-builder.html">Query Builder</a>
<a class="list-group-item" href="./guide-db-active-record.html">Active Record</a>
<a class="list-group-item" href="./guide-db-migrations.html">Migrations</a>
<a class="list-group-item" href="./guide-db-sphinx.html">Sphinx</a>
<a class="list-group-item" href="./guide-db-redis.html">Redis</a>
<a class="list-group-item" href="./guide-db-mongodb.html">MongoDB</a>
<a class="list-group-item" href="./guide-db-elasticsearch.html">ElasticSearch</a></div>
<a class="list-group-item" href="#navigation-11922" data-toggle="collapse" data-parent="#navigation">Nhận dữ liệu từ user <b class="caret"></b></a><div id="navigation-11922" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-input-forms.html">Tạo mới Forms</a>
<a class="list-group-item" href="./guide-input-validation.html">Kiểm tra dữ liệu đầu vào (Validating Input)</a>
<a class="list-group-item" href="./guide-input-file-upload.html">File Upload</a>
<a class="list-group-item" href="./guide-input-tabular-input.html">Thu thập dữ liệu từ danh sách đầu vào (Đang phát triển)</a>
<a class="list-group-item" href="./guide-input-multiple-models.html">Lấy dữ liệu cho nhiều Models (Chưa giải quyết)</a></div>
<a class="list-group-item" href="#navigation-11923" data-toggle="collapse" data-parent="#navigation">Hiển thị dữ liệu <b class="caret"></b></a><div id="navigation-11923" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-output-formatter.html">Định dạng dữ liệu (Data Formatting)</a>
<a class="list-group-item" href="./guide-output-pagination.html">Phân trang (Pagination)</a>
<a class="list-group-item" href="./guide-output-sorting.html">Sắp xếp (Sorting)</a>
<a class="list-group-item" href="./guide-output-data-providers.html">Cung cấp dữ liệu ra (Data Providers)</a>
<a class="list-group-item" href="./guide-output-data-widgets.html">Dữ liệu Widgets</a>
<a class="list-group-item" href="./guide-output-client-scripts.html">làm việc với Client Scripts</a>
<a class="list-group-item" href="./guide-output-theming.html">Giao diện (Theming)</a></div>
<a class="list-group-item" href="#navigation-11924" data-toggle="collapse" data-parent="#navigation">Bảo mật (Security) <b class="caret"></b></a><div id="navigation-11924" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-security-authentication.html">Xác thực (Authentication)</a>
<a class="list-group-item" href="./guide-security-authorization.html">Quyền (Authorization)</a>
<a class="list-group-item" href="./guide-security-passwords.html">Các thao tác xử lý với Passwords (Đang phát triển)</a>
<a class="list-group-item" href="./guide-security-auth-clients.html">Auth Clients</a>
<a class="list-group-item" href="./guide-security-best-practices.html">Best Practices</a></div>
<a class="list-group-item" href="#navigation-11925" data-toggle="collapse" data-parent="#navigation">Bộ nhớ Cache <b class="caret"></b></a><div id="navigation-11925" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-caching-overview.html">Tổng quan</a>
<a class="list-group-item" href="./guide-caching-data.html">Cache dữ liệu</a>
<a class="list-group-item" href="./guide-caching-fragment.html">Fragment Caching</a>
<a class="list-group-item" href="./guide-caching-page.html">Page Caching</a>
<a class="list-group-item" href="./guide-caching-http.html">HTTP Caching</a></div>
<a class="list-group-item" href="#navigation-11926" data-toggle="collapse" data-parent="#navigation">RESTful Web Services <b class="caret"></b></a><div id="navigation-11926" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-rest-quick-start.html">Bắt đầu</a>
<a class="list-group-item" href="./guide-rest-resources.html">Tài nguyên (Resources)</a>
<a class="list-group-item" href="./guide-rest-controllers.html">Bộ điều khiển (Controllers)</a>
<a class="list-group-item" href="./guide-rest-routing.html">Routing</a>
<a class="list-group-item" href="./guide-rest-response-formatting.html">Định dạng thông điệp gửi đi (Response Formatting)</a>
<a class="list-group-item" href="./guide-rest-authentication.html">Xác thực (Authentication)</a>
<a class="list-group-item" href="./guide-rest-rate-limiting.html">Rate Limiting</a>
<a class="list-group-item" href="./guide-rest-versioning.html">Phiên bản (Version)</a>
<a class="list-group-item" href="./guide-rest-error-handling.html">Error Handling</a></div>
<a class="list-group-item" href="#navigation-11927" data-toggle="collapse" data-parent="#navigation">Công cụ phát triển (Development Tools) <b class="caret"></b></a><div id="navigation-11927" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-tool-debugger.html">Thanh công cụ gỡ lỗi và sửa lỗi (Debug Toolbar và Debugger)</a>
<a class="list-group-item" href="./guide-tool-gii.html">Sử dụng Gii để tạo code</a>
<a class="list-group-item" href="./guide-tool-api-doc.html">Tạo tài liệu về API </a></div>
<a class="list-group-item" href="#navigation-11928" data-toggle="collapse" data-parent="#navigation">Testing <b class="caret"></b></a><div id="navigation-11928" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-test-overview.html">Tổng quan</a>
<a class="list-group-item" href="./guide-test-environment-setup.html">Thiết lập môi trường</a>
<a class="list-group-item" href="./guide-test-unit.html">Unit Tests</a>
<a class="list-group-item" href="./guide-test-functional.html">Kiểm tra chức năng (Functional Tests)</a>
<a class="list-group-item" href="./guide-test-acceptance.html">Acceptance Tests</a>
<a class="list-group-item" href="./guide-test-fixtures.html">Fixtures</a></div>
<a class="list-group-item" href="#navigation-11929" data-toggle="collapse" data-parent="#navigation">Chủ đề năng cao <b class="caret"></b></a><div id="navigation-11929" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-tutorial-advanced-app.html">Advanced Application Template</a>
<a class="list-group-item" href="./guide-tutorial-start-from-scratch.html">Building Application from Scratch</a>
<a class="list-group-item" href="./guide-tutorial-console.html">Giao diện dòng lệnh (Console Commands)</a>
<a class="list-group-item" href="./guide-tutorial-core-validators.html">Core Validators</a>
<a class="list-group-item" href="./guide-tutorial-i18n.html">Quốc tế hóa (Internationalization)</a>
<a class="list-group-item" href="./guide-tutorial-mailing.html">Thư (Mailing)</a>
<a class="list-group-item" href="./guide-tutorial-performance-tuning.html">Tối ưu hiệu năng ứng dụng (Performance Tuning)</a>
<a class="list-group-item" href="./guide-tutorial-shared-hosting.html">Shared Hosting Environment</a>
<a class="list-group-item" href="./guide-tutorial-template-engines.html">Template Engines</a>
<a class="list-group-item" href="./guide-tutorial-yii-integration.html">Working with Third-Party Code</a></div>
<a class="list-group-item" href="#navigation-11930" data-toggle="collapse" data-parent="#navigation">Widgets <b class="caret"></b></a><div id="navigation-11930" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-widget-bootstrap.html">Bootstrap Widgets</a>
<a class="list-group-item" href="./guide-widget-jui.html">jQuery UI Widgets</a></div>
<a class="list-group-item" href="#navigation-11931" data-toggle="collapse" data-parent="#navigation">Helpers <b class="caret"></b></a><div id="navigation-11931" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-helper-overview.html">Tổng quan</a>
<a class="list-group-item" href="./guide-helper-array.html">ArrayHelper</a>
<a class="list-group-item" href="./guide-helper-html.html">Html</a>
<a class="list-group-item" href="./guide-helper-url.html">Url</a></div></div>    </div>
    <div class="col-md-9 guide-content" role="main">
        <h1>クエリビルダ <span id="kueribiruda"></span><a href="#kueribiruda" class="hashlink">&para;</a></h1>
<div class="toc"><ol><li><a href="#building-queries">クエリを構築する</a></li>
<li><a href="#query-methods">クエリメソッド</a></li>
<li><a href="#indexing-query-results">クエリ結果をインデックスする</a></li>
<li><a href="#batch-query">バッチクエリ</a></li></ol></div>
<p><a href="guide-db-dao.html">データベースアクセスオブジェクト</a> の上に構築されているクエリビルダは、SQL クエリをプログラム的に、かつ、DBMS の違いを意識せずに作成することを可能にしてくれます。
クエリビルダを使うと、生の SQL 文を書くことに比べて、より読みやすい SQL 関連のコードを書き、より安全な SQL 文を生成することが容易になります。</p>
<p>通常、クエリビルダの使用は、二つのステップから成ります。</p>
<ol>
<li>SELECT SQL 文のさまざまな部分 (例えば、<code>SELECT</code>、<code>FROM</code>) を表現する <span class="broken-link">yii\db\Query</span> オブジェクトを構築する。</li>
<li><span class="broken-link">yii\db\Query</span> のクエリメソッド (例えば <code>all()</code>) を実行して、データベースからデータを取得する。</li>
</ol>
<p>次のコードは、クエリビルダを使用する典型的な方法を示すものです。</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$rows</span> = (<span class="hljs-keyword">new</span> \yii\db\Query())
    -&gt;select([<span class="hljs-string">'id'</span>, <span class="hljs-string">'email'</span>])
    -&gt;from(<span class="hljs-string">'user'</span>)
    -&gt;where([<span class="hljs-string">'last_name'</span> =&gt; <span class="hljs-string">'Smith'</span>])
    -&gt;limit(<span class="hljs-number">10</span>)
    -&gt;all();
</code></pre>
<p>上記のコードは、次の SQL クエリを生成して実行します。
ここでは、<code>:last_name</code> パラメータは <code>'Smith'</code> という文字列にバインドされています。</p>
<pre><code class="hljs sql language-sql"><span class="hljs-operator"><span class="hljs-keyword">SELECT</span> <span class="hljs-string">`id`</span>, <span class="hljs-string">`email`</span> 
<span class="hljs-keyword">FROM</span> <span class="hljs-string">`user`</span>
<span class="hljs-keyword">WHERE</span> <span class="hljs-string">`last_name`</span> = :last_name
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>
</span></code></pre>
<blockquote class="info"><p><strong>Info: </strong>通常は、<span class="broken-link">yii\db\QueryBuilder</span> ではなく、主として <span class="broken-link">yii\db\Query</span> を使用します。
  前者は、クエリメソッドの一つを呼ぶときに、後者によって黙示的に起動されます。
  <span class="broken-link">yii\db\QueryBuilder</span> は、DBMS に依存しない <span class="broken-link">yii\db\Query</span> オブジェクトから、DBMS に依存する SQL 文を生成する (例えば、テーブルやカラムの名前を DBMS ごとに違う方法で引用符で囲む) 役割を負っているクラスです。</p>
</blockquote>
<h2>クエリを構築する  <span id="building-queries"></span><a href="#building-queries" class="hashlink">&para;</a></h2><p><span class="broken-link">yii\db\Query</span> オブジェクトを構築するために、さまざまなクエリ構築メソッドを呼んで、SQL クエリのさまざまな部分を定義します。
これらのメソッドの名前は、SQL 文の対応する部分に使われる SQL キーワードに似たものになっています。
例えば、SQL クエリの <code>FROM</code> の部分を定義するためには、<code>from()</code> メソッドを呼び出します。
クエリ構築メソッドは、すべて、クエリオブジェクトそのものを返しますので、複数の呼び出しをチェーンしてまとめることが出来ます。</p>
<p>以下で、それぞれのクエリ構築メソッドの使用方法を説明しましょう。</p>
<h3><span class="broken-link">yii\db\Query::select()</span>  <span id="select"></span><a href="#select" class="hashlink">&para;</a></h3><p><span class="broken-link">yii\db\Query::select()</span> メソッドは、SQL 文の <code>SELECT</code> 句を定義します。
選択されるカラムは、次のように、配列または文字列として指定することが出来ます。
選択されるカラムの名前は、クエリオブジェクトから SQL 文が生成されるときに、自動的に引用符で囲まれます。</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;select([<span class="hljs-string">'id'</span>, <span class="hljs-string">'email'</span>]);

<span class="hljs-comment">// 次と等価</span>

<span class="hljs-variable">$query</span>-&gt;select(<span class="hljs-string">'id, email'</span>);
</code></pre>
<p>選択されるカラム名は、生の SQL クエリを書くときにするように、テーブル接頭辞 および/または カラムのエイリアスを含むことが出来ます。
例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;select([<span class="hljs-string">'user.id AS user_id'</span>, <span class="hljs-string">'email'</span>]);

<span class="hljs-comment">// 次と等価</span>

<span class="hljs-variable">$query</span>-&gt;select(<span class="hljs-string">'user.id AS user_id, email'</span>);
</code></pre>
<p>カラムを指定するのに配列形式を使っている場合は、配列のキーを使ってカラムのエイリアスを指定することも出来ます。
例えば、上記のコードは次のように書くことが出来ます。</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;select([<span class="hljs-string">'user_id'</span> =&gt; <span class="hljs-string">'user.id'</span>, <span class="hljs-string">'email'</span>]);
</code></pre>
<p>クエリを構築するときに <span class="broken-link">yii\db\Query::select()</span> メソッドを呼ばなかった場合は、<code>*</code> がセレクトされます。
すなわち、<em>全て</em> のカラムが選択されることになります。</p>
<p>カラム名に加えて、DB 式をセレクトすることも出来ます。
カンマを含む DB 式をセレクトする場合は、自動的に引用符で囲む機能が誤動作しないように、配列形式を使わなければなりません。
例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;select([<span class="hljs-string">"CONCAT(first_name, ' ', last_name) AS full_name"</span>, <span class="hljs-string">'email'</span>]); 
</code></pre>
<p>生の SQL が使われる場所ではどこでもそうですが、セレクトに DB 式を書く場合には、テーブルやカラムの名前を表すために
<a href="guide-db-dao.html#quoting-table-and-column-names">特定のデータベースに依存しない引用符の構文</a> を使うことが出来ます。</p>
<p>バージョン 2.0.1 以降では、サブクエリもセレクトすることが出来ます。
各サブクエリは、<span class="broken-link">yii\db\Query</span> オブジェクトの形で指定しなければなりません。
例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$subQuery</span> = (<span class="hljs-keyword">new</span> Query())-&gt;select(<span class="hljs-string">'COUNT(*)'</span>)-&gt;from(<span class="hljs-string">'user'</span>);

<span class="hljs-comment">// SELECT `id`, (SELECT COUNT(*) FROM `user`) AS `count` FROM `post`</span>
<span class="hljs-variable">$query</span> = (<span class="hljs-keyword">new</span> Query())-&gt;select([<span class="hljs-string">'id'</span>, <span class="hljs-string">'count'</span> =&gt; <span class="hljs-variable">$subQuery</span>])-&gt;from(<span class="hljs-string">'post'</span>);
</code></pre>
<p>重複行を除外してセレクトするためには、次のように、<span class="broken-link">yii\db\Query::distinct()</span> を呼ぶことが出来ます。</p>
<pre><code class="hljs php language-php"><span class="hljs-comment">// SELECT DISTINCT `user_id` ...</span>
<span class="hljs-variable">$query</span>-&gt;select(<span class="hljs-string">'user_id'</span>)-&gt;distinct();
</code></pre>
<h3><span class="broken-link">yii\db\Query::from()</span>  <span id="from"></span><a href="#from" class="hashlink">&para;</a></h3><p><span class="broken-link">yii\db\Query::from()</span> メソッドは、SQL 文の <code>FROM</code> 句を定義します。例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-comment">// SELECT * FROM `user`</span>
<span class="hljs-variable">$query</span>-&gt;from(<span class="hljs-string">'user'</span>);
</code></pre>
<p>セレクトの対象になる (一つまたは複数の) テーブルは、文字列または配列として指定することが出来ます。
テーブル名は、生の SQL 文を書くときにするように、スキーマ接頭辞 および/または テーブルエイリアスを含むことが出来ます。例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;from([<span class="hljs-string">'public.user u'</span>, <span class="hljs-string">'public.post p'</span>]);

<span class="hljs-comment">// 次と等価</span>

<span class="hljs-variable">$query</span>-&gt;from(<span class="hljs-string">'public.user u, public.post p'</span>);
</code></pre>
<p>配列形式を使う場合は、次のように、配列のキーを使ってテーブルエイリアスを指定することも出来ます。</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;from([<span class="hljs-string">'u'</span> =&gt; <span class="hljs-string">'public.user'</span>, <span class="hljs-string">'p'</span> =&gt; <span class="hljs-string">'public.post'</span>]);
</code></pre>
<p>テーブル名の他に、<span class="broken-link">yii\db\Query</span> オブジェクトの形で指定することによって、サブクエリをセレクトの対象とすることも出来ます。
例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$subQuery</span> = (<span class="hljs-keyword">new</span> Query())-&gt;select(<span class="hljs-string">'id'</span>)-&gt;from(<span class="hljs-string">'user'</span>)-&gt;where(<span class="hljs-string">'status=1'</span>);

<span class="hljs-comment">// SELECT * FROM (SELECT `id` FROM `user` WHERE status=1) u </span>
<span class="hljs-variable">$query</span>-&gt;from([<span class="hljs-string">'u'</span> =&gt; <span class="hljs-variable">$subQuery</span>]);
</code></pre>
<h3><span class="broken-link">yii\db\Query::where()</span>  <span id="where"></span><a href="#where" class="hashlink">&para;</a></h3><p><span class="broken-link">yii\db\Query::where()</span> メソッドは、SQL クエリの <code>WHERE</code> 句を定義します。
<code>WHERE</code> の条件を指定するために、次の三つの形式から一つを選んで使うことが出来ます。</p>
<ul>
<li>文字列形式、例えば、<code>'status=1'</code></li>
<li>ハッシュ形式、例えば、<code>['status' =&gt; 1, 'type' =&gt; 2]</code></li>
<li>演算子形式、例えば、<code>['like', 'name', 'test']</code></li>
</ul>
<h4>文字列形式  <span id="string-format"></span><a href="#string-format" class="hashlink">&para;</a></h4><p>文字列形式は、非常に単純な条件を定義する場合や、DBMS の組み込み関数を使う必要がある場合に最適です。
これは、生の SQL を書いている場合と同じように動作します。
例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;where(<span class="hljs-string">'status=1'</span>);

<span class="hljs-comment">// あるいは、パラメータバインディングを使って、動的にパラメータをバインドする</span>
<span class="hljs-variable">$query</span>-&gt;where(<span class="hljs-string">'status=:status'</span>, [<span class="hljs-string">':status'</span> =&gt; <span class="hljs-variable">$status</span>]);

<span class="hljs-comment">// date フィールドに対して MySQL の YEAR() 関数を使う生の SQL</span>
<span class="hljs-variable">$query</span>-&gt;where(<span class="hljs-string">'YEAR(somedate) = 2015'</span>);
</code></pre>
<p>次のように、条件式に変数を直接に埋め込んではいけません。
特に、変数の値がユーザの入力に由来する場合、あなたのアプリケーションを SQL インジェクション攻撃にさらすことになりますので、してはいけません。</p>
<pre><code class="hljs php language-php"><span class="hljs-comment">// 危険! $status が整数であることが絶対に確実でなければ、してはいけない。</span>
<span class="hljs-variable">$query</span>-&gt;where(<span class="hljs-string">"status=$status"</span>);
</code></pre>
<p>パラメータバインディングを使う場合は、<span class="broken-link">yii\db\Query::params()</span> または <span class="broken-link">yii\db\Query::addParams()</span> を使って、パラメータの指定を分離することが出来ます。</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;where(<span class="hljs-string">'status=:status'</span>)
    -&gt;addParams([<span class="hljs-string">':status'</span> =&gt; <span class="hljs-variable">$status</span>]);
</code></pre>
<p>生の SQL が使われる場所ではどこでもそうですが、文字列形式で条件を書く場合には、テーブルやカラムの名前を表すために
<a href="guide-db-dao.html#quoting-table-and-column-names">特定のデータベースに依存しない引用符の構文</a> を使うことが出来ます。</p>
<h4>ハッシュ形式  <span id="hash-format"></span><a href="#hash-format" class="hashlink">&para;</a></h4><p>値が等しいことを要求する単純な条件をいくつか <code>AND</code> で結合する場合は、ハッシュ形式を使うのが最適です。
個々の条件を表す配列の各要素は、キーをカラム名、値をそのカラムが持つべき値とします。
例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-comment">// ...WHERE (`status` = 10) AND (`type` IS NULL) AND (`id` IN (4, 8, 15))</span>
<span class="hljs-variable">$query</span>-&gt;where([
    <span class="hljs-string">'status'</span> =&gt; <span class="hljs-number">10</span>,
    <span class="hljs-string">'type'</span> =&gt; <span class="hljs-keyword">null</span>,
    <span class="hljs-string">'id'</span> =&gt; [<span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">15</span>],
]);
</code></pre>
<p>ご覧のように、クエリビルダは頭が良いので、null や配列である値も、適切に処理します。</p>
<p>次のように、サブクエリをハッシュ形式で使うことも出来ます。</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$userQuery</span> = (<span class="hljs-keyword">new</span> Query())-&gt;select(<span class="hljs-string">'id'</span>)-&gt;from(<span class="hljs-string">'user'</span>);

<span class="hljs-comment">// ...WHERE `id` IN (SELECT `id` FROM `user`)</span>
<span class="hljs-variable">$query</span>-&gt;where([<span class="hljs-string">'id'</span> =&gt; <span class="hljs-variable">$userQuery</span>]);
</code></pre>
<p>ハッシュ形式を使う場合、Yii は内部的にパラメータバインディングを使用します。
従って、<a href="#string-format">文字列形式</a> とは対照的に、ここでは手動でパラメータを追加する必要はありません。</p>
<h4>演算子形式  <span id="operator-format"></span><a href="#operator-format" class="hashlink">&para;</a></h4><p>演算子形式を使うと、任意の条件をプログラム的な方法で指定することが出来ます。
これは次の形式を取るものです。</p>
<pre><code class="hljs php language-php">[演算子, オペランド1, オペランド2, ...]
</code></pre>
<p>ここで、各オペランドは、文字列形式、ハッシュ形式、あるいは、再帰的に演算子形式として指定することが出来ます。
そして、演算子には、次のどれか一つを使うことが出来ます。</p>
<ul>
<li><p><code>and</code>: 二つのオペランドが <code>AND</code> を使って結合されます。例えば、<code>['and', 'id=1', 'id=2']</code> は <code>id=1 AND id=2</code> を生成します。
オペランドが配列である場合は、ここで説明されている規則に従って文字列に変換されます。
例えば、<code>['and', 'type=1', ['or', 'id=1', 'id=2']]</code> は <code>type=1 AND (id=1 OR id=2)</code> を生成します。
このメソッドは、文字列を引用符で囲ったりエスケープしたりしません。</p>
</li>
<li><p><code>or</code>: 二つのオペランドが <code>OR</code> を使って結合されること以外は <code>and</code> 演算子と同じです。</p>
</li>
<li><p><code>between</code>: オペランド 1 はカラム名、オペランド 2 と 3 はカラムの値が属すべき範囲の開始値と終了値としなければなりません。
例えば、<code>['between', 'id', 1, 10]</code> は <code>id BETWEEN 1 AND 10</code> を生成します。</p>
</li>
<li><p><code>not between</code>: 生成される条件において <code>BETWEEN</code> が <code>NOT BETWEEN</code> に置き換えられる以外は、<code>between</code> と同じです。</p>
</li>
<li><p><code>in</code>: オペランド 1 はカラム名または DB 式でなければなりません。
オペランド 2 は、配列または <code>Query</code> オブジェクトのどちらかを取ることが出来ます。
オペランド 2 が配列である場合は、その配列は、カラムまたは DB 式が該当すべき値域を表すものとされます。
オペランド 2 が <code>Query</code> オブジェクトである場合は、サブクエリが生成されて、カラムまたは DB 式の値域として使われます。
例えば、<code>['in', 'id', [1, 2, 3]]</code> は <code>id IN (1, 2, 3)</code> を生成します。
このメソッドは、カラム名を適切に引用符で囲み、値域の値をエスケープします。
<code>in</code> 演算子はまた複合カラムをもサポートしています。
その場合、オペランド 1 はカラム名の配列とし、オペランド 2 は配列の配列、または、複合カラムの値域を表す <code>Query</code> オブジェクトでなければなりません。</p>
</li>
<li><p><code>not in</code>: 生成される条件において <code>IN</code> が <code>NOT IN</code> に置き換えられる以外は、<code>in</code> と同じです。</p>
</li>
<li><p><code>like</code>: オペランド 1 はカラム名または DB 式、オペランド 2 はカラムまたは DB 式がマッチすべき値を示す文字列または配列でなければなりません。
例えば、<code>['like', 'name', 'tester']</code> は <code>name LIKE '%tester%'</code> を生成します。
値域が配列として与えられた場合は、複数の <code>LIKE</code> 述語が生成されて 'AND' によって結合されます。
例えば、<code>['like', 'name', ['test', 'sample']]</code> は <code>name LIKE '%test%' AND name LIKE '%sample%'</code> を生成します。
さらに、オプションである三番目のオペランドによって、値の中の特殊文字をエスケープする方法を指定することも出来ます。
このオペランド 3 は、特殊文字とそのエスケープ結果のマッピングを示す配列でなければなりません。
このオペランドが提供されない場合は、デフォルトのエスケープマッピングが使用されます。
<code>false</code> または空の配列を使って、値が既にエスケープ済みであり、それ以上エスケープを適用すべきでないことを示すことが出来ます。
エスケープマッピングを使用する場合 (または第三のオペランドが与えられない場合) は、値が自動的に一組のパーセント記号によって囲まれることに注意してください。</p>
<blockquote class="note"><p><strong>Note: </strong>PostgreSQL を使っている場合は、<code>like</code> の代りに、大文字と小文字を区別しない比較のための <a href="http://www.postgresql.org/docs/8.3/static/functions-matching.html#FUNCTIONS-LIKE"><code>ilike</code></a> を使うことも出来ます。</p>
</blockquote>
</li>
<li><p><code>or like</code>: オペランド 2 が配列である場合に <code>LIKE</code> 述語が <code>OR</code> によって結合される以外は、<code>like</code> 演算子と同じです。</p>
</li>
<li><p><code>not like</code>: 生成される条件において <code>LIKE</code> が <code>NOT LIKE</code> に置き換えられる以外は、<code>like</code> 演算子と同じです。</p>
</li>
<li><p><code>or not like</code>: <code>NOT LIKE</code> 述語が <code>OR</code> によって結合される以外は、<code>not like</code> 演算子と同じです。</p>
</li>
<li><p><code>exists</code>: 要求される一つだけのオペランドは、サブクエリを表す <span class="broken-link">yii\db\Query</span> のインスタンスでなければなりません。
これは <code>EXISTS (sub-query)</code> という式を構築します。</p>
</li>
<li><p><code>not exists</code>: <code>exists</code> 演算子と同じで、<code>NOT EXISTS (sub-query)</code> という式を構築します。</p>
</li>
<li><p><code>&gt;</code>、<code>&lt;=</code>、その他、二つのオペランドを取る有効な DB 演算子全て: 最初のオペランドはカラム名、第二のオペランドは値でなければなりません。
例えば、<code>['&gt;', 'age', 10]</code> は <code>age&gt;10</code> を生成します。</p>
</li>
</ul>
<p>演算子形式を使う場合、Yii は内部的にパラメータバインディングを使用します。
従って、<a href="#string-format">文字列形式</a> とは対照的に、ここでは手動でパラメータを追加する必要はありません。</p>
<h4>条件を追加する  <span id="appending-conditions"></span><a href="#appending-conditions" class="hashlink">&para;</a></h4><p><span class="broken-link">yii\db\Query::andWhere()</span> または <span class="broken-link">yii\db\Query::orWhere()</span> を使って、既存の条件に別の条件を追加することが出来ます。
これらのメソッドを複数回呼んで、複数の条件を別々に追加することが出来ます。
例えば、</p>
<p>条件の一部を動的に構築しようとする場合は、<code>andWhere()</code> と <code>orWhere()</code> を使うのが非常に便利です。</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$status</span> = <span class="hljs-number">10</span>;
<span class="hljs-variable">$search</span> = <span class="hljs-string">'yii'</span>;

<span class="hljs-variable">$query</span>-&gt;where([<span class="hljs-string">'status'</span> =&gt; <span class="hljs-variable">$status</span>]);

<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$search</span>)) {
    <span class="hljs-variable">$query</span>-&gt;andWhere([<span class="hljs-string">'like'</span>, <span class="hljs-string">'title'</span>, <span class="hljs-variable">$search</span>]);
}
</code></pre>
<p><code>$search</code> が空でない場合は次の <code>WHERE</code> 条件 が生成されます。</p>
<pre><code class="hljs sql language-sql">WHERE (`status` = 10) AND (`title` LIKE '%yii%')
</code></pre>
<h4>フィルタ条件  <span id="filter-conditions"></span><a href="#filter-conditions" class="hashlink">&para;</a></h4><p>ユーザの入力に基づいて <code>WHERE</code> の条件を構築する場合、普通は、空の入力値は無視したいものです。
例えば、ユーザ名とメールアドレスによる検索が可能な検索フォームにおいては、ユーザが username/email のインプットフィールドに何も入力しなかった場合は、username/email の条件を無視したいでしょう。
<span class="broken-link">yii\db\Query::filterWhere()</span> メソッドを使うことによって、この目的を達することが出来ます。</p>
<pre><code class="hljs php language-php"><span class="hljs-comment">// $username と $email はユーザの入力による</span>
<span class="hljs-variable">$query</span>-&gt;filterWhere([
    <span class="hljs-string">'username'</span> =&gt; <span class="hljs-variable">$username</span>,
    <span class="hljs-string">'email'</span> =&gt; <span class="hljs-variable">$email</span>,
]);
</code></pre>
<p><span class="broken-link">yii\db\Query::filterWhere()</span> と <span class="broken-link">yii\db\Query::where()</span> の唯一の違いは、前者は <a href="#hash-format">ハッシュ形式</a> の条件において提供された空の値を無視する、という点です。
従って、<code>$email</code> が空で <code>$sername</code> がそうではない場合は、上記のコードは、結果として <code>WHERE username=:username</code> という SQL 条件になります。</p>
<blockquote class="info"><p><strong>Info: </strong>値が空であると見なされるのは、null、空の配列、空の文字列、または空白のみを含む文字列である場合です。</p>
</blockquote>
<p><span class="broken-link">yii\db\Query::andWhere()</span> または <span class="broken-link">yii\db\Query::orWhere()</span> と同じように、<span class="broken-link">yii\db\Query::andFilterWhere()</span> または <span class="broken-link">yii\db\Query::orFilterWhere()</span> を使って、既存の条件に別のフィルタ条件を追加することも出来ます。</p>
<p>さらに加えて、値の方に含まれている比較演算子を適切に判断してくれる <span class="broken-link">yii\db\Query::andFilterCompare()</span> があります。</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;andFilterCompare(<span class="hljs-string">'name'</span>, <span class="hljs-string">'John Doe'</span>);
<span class="hljs-variable">$query</span>-&gt;andFilterCompare(<span class="hljs-string">'rating'</span>, <span class="hljs-string">'&gt;9'</span>);
<span class="hljs-variable">$query</span>-&gt;andFilterCompare(<span class="hljs-string">'value'</span>, <span class="hljs-string">'&lt;=100'</span>);
</code></pre>
<p>比較演算子を明示的に指定することも可能です。</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;andFilterCompare(<span class="hljs-string">'name'</span>, <span class="hljs-string">'Doe'</span>, <span class="hljs-string">'like'</span>);
</code></pre>
<h3><span class="broken-link">yii\db\Query::orderBy()</span>  <span id="order-by"></span><a href="#order-by" class="hashlink">&para;</a></h3><p><span class="broken-link">yii\db\Query::orderBy()</span> メソッドは SQL クエリの <code>ORDER BY</code> 句を指定します。例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-comment">// ... ORDER BY `id` ASC, `name` DESC</span>
<span class="hljs-variable">$query</span>-&gt;orderBy([
    <span class="hljs-string">'id'</span> =&gt; SORT_ASC,
    <span class="hljs-string">'name'</span> =&gt; SORT_DESC,
]);
</code></pre>
<p>上記のコードにおいて、配列のキーはカラム名であり、配列の値は並べ替えの方向です。
PHP の定数 <code>SORT_ASC</code> は昇順、<code>SORT_DESC</code> は降順を指定するものです。</p>
<p><code>ORDER BY</code> が単純なカラム名だけを含む場合は、生の SQL 文を書くときにするように、文字列を使って指定することが出来ます。
例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;orderBy(<span class="hljs-string">'id ASC, name DESC'</span>);
</code></pre>
<blockquote class="note"><p><strong>Note: </strong><code>ORDER BY</code> が何らかの DB 式を含む場合は、配列形式を使わなければなりません。</p>
</blockquote>
<p><span class="broken-link">yii\db\Query::addOrderBy()</span> を呼んで、`ORDER BY' 句にカラムを追加することが出来ます。
例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;orderBy(<span class="hljs-string">'id ASC'</span>)
    -&gt;addOrderBy(<span class="hljs-string">'name DESC'</span>);
</code></pre>
<h3><span class="broken-link">yii\db\Query::groupBy()</span>  <span id="group-by"></span><a href="#group-by" class="hashlink">&para;</a></h3><p><span class="broken-link">yii\db\Query::groupBy()</span> メソッドは SQL クエリの <code>GROUP BY</code> 句を指定します。
例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-comment">// ... GROUP BY `id`, `status`</span>
<span class="hljs-variable">$query</span>-&gt;groupBy([<span class="hljs-string">'id'</span>, <span class="hljs-string">'status'</span>]);
</code></pre>
<p><code>GROUP BY</code> が単純なカラム名だけを含む場合は、生の SQL 文を書くときにするように、文字列を使って指定することが出来ます。
例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;groupBy(<span class="hljs-string">'id, status'</span>);
</code></pre>
<blockquote class="note"><p><strong>Note: </strong><code>GROUP BY</code> が何らかの DB 式を含む場合は、配列形式を使わなければなりません。</p>
</blockquote>
<p><span class="broken-link">yii\db\Query::addGroupBy()</span> を呼んで、<code>GROUP BY</code> 句にカラムを追加することが出来ます。
例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;groupBy([<span class="hljs-string">'id'</span>, <span class="hljs-string">'status'</span>])
    -&gt;addGroupBy(<span class="hljs-string">'age'</span>);
</code></pre>
<h3><span class="broken-link">yii\db\Query::having()</span>  <span id="having"></span><a href="#having" class="hashlink">&para;</a></h3><p><span class="broken-link">yii\db\Query::having()</span> メソッドは SQL クエリの <code>HAVING</code> 句を指定します。
このメソッドが取る条件は、<a href="#where">where()</a> と同じ方法で指定することが出来ます。
例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-comment">// ... HAVING `status` = 1</span>
<span class="hljs-variable">$query</span>-&gt;having([<span class="hljs-string">'status'</span> =&gt; <span class="hljs-number">1</span>]);
</code></pre>
<p>条件を指定する方法の詳細については、<a href="#where">where()</a> のドキュメントを参照してください。</p>
<p><span class="broken-link">yii\db\Query::andHaving()</span> または <span class="broken-link">yii\db\Query::orHaving()</span> を呼んで、<code>HAVING</code> 句に条件を追加することが出来ます。
例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-comment">// ... HAVING (`status` = 1) AND (`age` &gt; 30)</span>
<span class="hljs-variable">$query</span>-&gt;having([<span class="hljs-string">'status'</span> =&gt; <span class="hljs-number">1</span>])
    -&gt;andHaving([<span class="hljs-string">'&gt;'</span>, <span class="hljs-string">'age'</span>, <span class="hljs-number">30</span>]);
</code></pre>
<h3><span class="broken-link">yii\db\Query::limit()</span> と <span class="broken-link">yii\db\Query::offset()</span>  <span id="limit-offset"></span><a href="#limit-offset" class="hashlink">&para;</a></h3><p><span class="broken-link">yii\db\Query::limit()</span> と <span class="broken-link">yii\db\Query::offset()</span> のメソッドは、SQL クエリの <code>LIMIT</code> 句と <code>OFFSET</code> 句を指定します。
例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-comment">// ... LIMIT 10 OFFSET 20</span>
<span class="hljs-variable">$query</span>-&gt;limit(<span class="hljs-number">10</span>)-&gt;offset(<span class="hljs-number">20</span>);
</code></pre>
<p>無効な上限やオフセット (例えば、負の数) を指定した場合は、無視されます。</p>
<blockquote class="info"><p><strong>Info: </strong><code>LIMIT</code> と <code>OFFSET</code> をサポートしていない DBMS (例えば MSSQL) に対しては、クエリビルダが <code>LIMIT</code>/<code>OFFSET</code> の振る舞いをエミュレートする SQL 文を生成します。</p>
</blockquote>
<h3><span class="broken-link">yii\db\Query::join()</span>  <span id="join"></span><a href="#join" class="hashlink">&para;</a></h3><table class="table table-bordered table-striped">
<thead>
<tr><th><span class="broken-link">yii\db\Query::join()</span> メソッドは SQL クエリの <code>JOIN</code> 句を指定します。例えば、</th></tr>
</thead>
<tbody>
<tr><td><code>`</code>php</td></tr>
<tr><td>// ... LEFT JOIN <code>post</code> ON <code>post</code>.<code>user_id</code> = <code>user</code>.<code>id</code></td></tr>
<tr><td>$query-&gt;join('LEFT JOIN', 'post', 'post.user_id = user.id');</td></tr>
<tr><td><code>`</code></td></tr>
</tbody>
</table>
<table class="table table-bordered table-striped">
<thead>
<tr><th><span class="broken-link">yii\db\Query::join()</span> メソッドは、四つのパラメータを取ります。</th></tr>
</thead>
<tbody>
<tr><td>- <code>$type</code>: 結合のタイプ、例えば、<code>'INNER JOIN'</code>、<code>'LEFT JOIN'</code>。</td></tr>
<tr><td>- <code>$table</code>: 結合されるテーブルの名前。</td></tr>
<tr><td>- <code>$on</code>: オプション。結合条件、すなわち、<code>ON</code> 句。</td></tr>
<tr><td>条件の指定方法の詳細については、<a href="#where">where()</a> を参照してください。</td></tr>
<tr><td>カラムに基づく条件を指定する場合は、配列記法は<strong>使えない</strong>ことに注意してください。</td></tr>
<tr><td>例えば、<code>['user.id' =&gt; 'comment.userId']</code> は、user の id が <code>'comment.userId'</code> という文字列でなければならない、という条件に帰結します。</td></tr>
<tr><td>配列記法ではなく文字列記法を使って、<code>'user.id = comment.userId'</code> という条件を指定しなければなりません。</td></tr>
<tr><td>- <code>$params</code>: オプション。結合条件にバインドされるパラメータ。</td></tr>
</tbody>
</table>
<p><code>INNER JOIN</code>、<code>LEFT JOIN</code> および <code>RIGHT JOIN</code> を指定するためには、それぞれ、次のショートカットメソッドを使うことが出来ます。</p>
<ul>
<li><span class="broken-link">yii\db\Query::innerJoin()</span></li>
<li><span class="broken-link">yii\db\Query::leftJoin()</span></li>
<li><span class="broken-link">yii\db\Query::rightJoin()</span></li>
</ul>
<p>例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;leftJoin(<span class="hljs-string">'post'</span>, <span class="hljs-string">'post.user_id = user.id'</span>);
</code></pre>
<p>複数のテーブルを結合するためには、テーブルごとに一回ずつ、上記の結合メソッドを複数回呼び出します。</p>
<p>テーブルを結合することに加えて、サブクエリを結合することも出来ます。
そうするためには、結合されるべきサブクエリを <span class="broken-link">yii\db\Query</span> オブジェクトとして指定します。
例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$subQuery</span> = (<span class="hljs-keyword">new</span> \yii\db\Query())-&gt;from(<span class="hljs-string">'post'</span>);
<span class="hljs-variable">$query</span>-&gt;leftJoin([<span class="hljs-string">'u'</span> =&gt; <span class="hljs-variable">$subQuery</span>], <span class="hljs-string">'u.id = author_id'</span>);
</code></pre>
<p>この場合、サブクエリを配列に入れて、配列のキーを使ってエイリアスを指定しなければなりません。</p>
<h3><span class="broken-link">yii\db\Query::union()</span>  <span id="union"></span><a href="#union" class="hashlink">&para;</a></h3><p><span class="broken-link">yii\db\Query::union()</span> メソッドは SQL クエリの <code>UNION</code> 句を指定します。例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query1</span> = (<span class="hljs-keyword">new</span> \yii\db\Query())
    -&gt;select(<span class="hljs-string">"id, category_id AS type, name"</span>)
    -&gt;from(<span class="hljs-string">'post'</span>)
    -&gt;limit(<span class="hljs-number">10</span>);

<span class="hljs-variable">$query2</span> = (<span class="hljs-keyword">new</span> \yii\db\Query())
    -&gt;select(<span class="hljs-string">'id, type, name'</span>)
    -&gt;from(<span class="hljs-string">'user'</span>)
    -&gt;limit(<span class="hljs-number">10</span>);

<span class="hljs-variable">$query1</span>-&gt;union(<span class="hljs-variable">$query2</span>);
</code></pre>
<p><span class="broken-link">yii\db\Query::union()</span> を複数回呼んで、<code>UNION</code> 句をさらに追加することが出来ます。</p>
<h2>クエリメソッド  <span id="query-methods"></span><a href="#query-methods" class="hashlink">&para;</a></h2><p><span class="broken-link">yii\db\Query</span> は、さまざまな目的のクエリのために、一揃いのメソッドを提供しています。</p>
<ul>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li><span class="broken-link">yii\db\Query::count()</span>: <code>COUNT</code> クエリの結果を返す。</li>
<li>その他の集計クエリ、すなわち、<span class="broken-link">yii\db\Query::sum()</span>, <span class="broken-link">yii\db\Query::average()</span>,
<span class="broken-link">yii\db\Query::max()</span>, <span class="broken-link">yii\db\Query::min()</span>.
これらのメソッドでは、<code>$q</code> パラメータは必須であり、カラム名または DB 式とすることが出来る。</li>
</ul>
<p>上記のメソッドの全ては、オプションで、DB クエリの実行に使用されるべき <span class="broken-link">yii\db\Connection</span> を表す <code>$db</code> パラメータを取ることが出来ます。
このパラメータを省略した場合は、DB 接続として <code>db</code> <a href="guide-structure-application-components.html">アプリケーションコンポーネント</a> が使用されます。
次に <span class="broken-link">yii\db\Query::count()</span> クエリメソッドを使う例をもう一つ挙げます。</p>
<pre><code class="hljs php language-php"><span class="hljs-comment">// 実行される SQL: SELECT COUNT(*) FROM `user` WHERE `last_name`=:last_name</span>
<span class="hljs-variable">$count</span> = (<span class="hljs-keyword">new</span> \yii\db\Query())
    -&gt;from(<span class="hljs-string">'user'</span>)
    -&gt;where([<span class="hljs-string">'last_name'</span> =&gt; <span class="hljs-string">'Smith'</span>])
    -&gt;count();
</code></pre>
<p>あなたが <span class="broken-link">yii\db\Query</span> のクエリメソッドを呼び出すと、実際には、内部的に次の仕事がなされます。</p>
<ul>
<li><span class="broken-link">yii\db\QueryBuilder</span> を呼んで、<span class="broken-link">yii\db\Query</span> の現在の構成に基づいた SQL 文を生成する。</li>
<li>生成された SQL 文で <span class="broken-link">yii\db\Command</span> オブジェクトを作成する。</li>
<li><span class="broken-link">yii\db\Command</span> のクエリメソッド (例えば <span class="broken-link">yii\db\Command::queryAll()</span>) を呼んで、SQL 文を実行し、データを取得する。</li>
</ul>
<p>場合によっては、<span class="broken-link">yii\db\Query</span> オブジェクトから構築された SQL 文を調べたり使ったりしたいことがあるでしょう。
次のコードを使って、その目的を達することが出来ます。</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$command</span> = (<span class="hljs-keyword">new</span> \yii\db\Query())
    -&gt;select([<span class="hljs-string">'id'</span>, <span class="hljs-string">'email'</span>])
    -&gt;from(<span class="hljs-string">'user'</span>)
    -&gt;where([<span class="hljs-string">'last_name'</span> =&gt; <span class="hljs-string">'Smith'</span>])
    -&gt;limit(<span class="hljs-number">10</span>)
    -&gt;createCommand();
    
<span class="hljs-comment">// SQL 文を表示する</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$command</span>-&gt;sql;
<span class="hljs-comment">// バインドされるパラメータを表示する</span>
print_r(<span class="hljs-variable">$command</span>-&gt;params);

<span class="hljs-comment">// クエリ結果の全ての行を返す</span>
<span class="hljs-variable">$rows</span> = <span class="hljs-variable">$command</span>-&gt;queryAll();
</code></pre>
<h2>クエリ結果をインデックスする  <span id="indexing-query-results"></span><a href="#indexing-query-results" class="hashlink">&para;</a></h2><p><span class="broken-link">yii\db\Query::all()</span> を呼ぶと、結果の行は連続した整数でインデックスされた配列で返されます。
場合によっては、違う方法でインデックスしたいことがあるでしょう。
例えば、特定のカラムの値や、何らかの式の値によってインデックスするなどです。
この目的は、<span class="broken-link">yii\db\Query::all()</span> の前に <span class="broken-link">yii\db\Query::indexBy()</span> を呼ぶことによって達成することが出来ます。
例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-comment">// [100 =&gt; ['id' =&gt; 100, 'username' =&gt; '...', ...], 101 =&gt; [...], 103 =&gt; [...], ...] を返す</span>
<span class="hljs-variable">$query</span> = (<span class="hljs-keyword">new</span> \yii\db\Query())
    -&gt;from(<span class="hljs-string">'user'</span>)
    -&gt;limit(<span class="hljs-number">10</span>)
    -&gt;indexBy(<span class="hljs-string">'id'</span>)
    -&gt;all();
</code></pre>
<p>式の値によってインデックスするためには、<span class="broken-link">yii\db\Query::indexBy()</span> メソッドに無名関数を渡します。</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span> = (<span class="hljs-keyword">new</span> \yii\db\Query())
    -&gt;from(<span class="hljs-string">'user'</span>)
    -&gt;indexBy(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(<span class="hljs-variable">$row</span>)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$row</span>[<span class="hljs-string">'id'</span>] . <span class="hljs-variable">$row</span>[<span class="hljs-string">'username'</span>];
    })-&gt;all();
</code></pre>
<p>この無名関数は、現在の行データを含む <code>$row</code> というパラメータを取り、現在の行のインデックス値として使われるスカラ値を返さなくてはなりません。</p>
<blockquote class="note"><p><strong>Note: </strong><span class="broken-link">yii\db\Query::groupBy()</span> や <span class="broken-link">yii\db\Query::orderBy()</span>
のようなクエリメソッドが SQL に変換されてクエリの一部となるのとは対照的に、
このメソッドはデータベースからデータが取得された後で動作します。
このことは、クエリの SELECT に含まれるカラム名だけを使うことが出来る、ということを意味します。
また、テーブルプレフィックスを付けてカラムを選択した場合、例えば <code>customer.id</code> を選択した場合は、
リザルトセットのカラム名は <code>id</code> しか含みませんので、テーブルプレフィックス無しで <code>-&gt;indexBy('id')</code> と呼ぶ必要があります。</p>
</blockquote>
<h2>バッチクエリ  <span id="batch-query"></span><a href="#batch-query" class="hashlink">&para;</a></h2><p>大量のデータを扱う場合は、<span class="broken-link">yii\db\Query::all()</span> のようなメソッドは適していません。
なぜなら、それらのメソッドは、全てのデータをメモリ上に読み込むことを必要とするためです。
必要なメモリ量を低く抑えるために、Yii はいわゆるバッチクエリのサポートを提供しています。
バッチクエリはデータカーソルを利用して、バッチモードでデータを取得します。</p>
<p>バッチクエリは次のようにして使うことが出来ます。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">use</span> <span class="hljs-title">yii</span>\<span class="hljs-title">db</span>\<span class="hljs-title">Query</span>;

<span class="hljs-variable">$query</span> = (<span class="hljs-keyword">new</span> Query())
    -&gt;from(<span class="hljs-string">'user'</span>)
    -&gt;orderBy(<span class="hljs-string">'id'</span>);

<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$query</span>-&gt;batch() <span class="hljs-keyword">as</span> <span class="hljs-variable">$users</span>) {
    <span class="hljs-comment">// $users は user テーブルから取得した 100 以下の行の配列</span>
}

<span class="hljs-comment">// または、一行ずつ反復したい場合は</span>
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$query</span>-&gt;each() <span class="hljs-keyword">as</span> <span class="hljs-variable">$user</span>) {
    <span class="hljs-comment">// $user は user テーブルから取得した一つの行を表す</span>
}
</code></pre>
<p><span class="broken-link">yii\db\Query::batch()</span> メソッドと <span class="broken-link">yii\db\Query::each()</span> メソッドは <span class="broken-link">yii\db\BatchQueryResult</span> オブジェクトを返します。
このオブジェクトは <code>Iterator</code> インタフェイスを実装しており、従って、<code>foreach</code> 構文の中で使うことが出来ます。
初回の反復の際に、データベースに対する SQL クエリが作成されます。データは、その後、反復のたびにバッチモードで取得されます。
デフォルトでは、バッチサイズは 100 であり、各バッチにおいて 100 行のデータが取得されます。
<code>batch()</code> または <code>each()</code> メソッドに最初のパラメータを渡すことによって、バッチサイズを変更することが出来ます。</p>
<p><span class="broken-link">yii\db\Query::all()</span> とは対照的に、バッチクエリは一度に 100 行のデータしかメモリに読み込みません。
データを処理した後、すぐにデータを破棄するようにすれば、バッチクエリの助けを借りてメモリ消費量を削減することが出来ます。</p>
<p><span class="broken-link">yii\db\Query::indexBy()</span> によってクエリ結果をあるカラムでインデックスするように指定している場合でも、バッチクエリは正しいインデックスを保持します。
例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span> = (<span class="hljs-keyword">new</span> \yii\db\Query())
    -&gt;from(<span class="hljs-string">'user'</span>)
    -&gt;indexBy(<span class="hljs-string">'username'</span>);

<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$query</span>-&gt;batch() <span class="hljs-keyword">as</span> <span class="hljs-variable">$users</span>) {
    <span class="hljs-comment">// $users は "username" カラムでインデックスされている</span>
}

<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$query</span>-&gt;each() <span class="hljs-keyword">as</span> <span class="hljs-variable">$username</span> =&gt; <span class="hljs-variable">$user</span>) {
    <span class="hljs-comment">// ...</span>
}
</code></pre>
        <div class="toplink"><a href="#" class="h1" title="go to top"><span class="glyphicon glyphicon-arrow-up"></a></div>
    </div>
</div>


</div>

<footer class="footer">
        <p class="pull-right"><small>Page generated on Tue, 27 Dec 2016 22:28:43 +0000</small></p>
    Powered by <a href="http://www.yiiframework.com/" rel="external">Yii Framework</a></footer>

<script type="text/javascript">jQuery(document).ready(function () {
    var shiftWindow = function () { scrollBy(0, -50) };
    if (location.hash) setTimeout(shiftWindow, 1);
    window.addEventListener("hashchange", shiftWindow);
var element = document.createElement("script");
element.src = "./jssearch.index.js";
document.body.appendChild(element);

var searchBox = $('#searchbox');

// search when typing in search field
searchBox.on("keyup", function(event) {
    var query = $(this).val();

    if (query == '' || event.which == 27) {
        $('#search-resultbox').hide();
        return;
    } else if (event.which == 13) {
        var selectedLink = $('#search-resultbox a.selected');
        if (selectedLink.length != 0) {
            document.location = selectedLink.attr('href');
            return;
        }
    } else if (event.which == 38 || event.which == 40) {
        $('#search-resultbox').show();

        var selected = $('#search-resultbox a.selected');
        if (selected.length == 0) {
            $('#search-results').find('a').first().addClass('selected');
        } else {
            var next;
            if (event.which == 40) {
                next = selected.parent().next().find('a').first();
            } else {
                next = selected.parent().prev().find('a').first();
            }
            if (next.length != 0) {
                var resultbox = $('#search-results');
                var position = next.position();

//              TODO scrolling is buggy and jumps around
//                resultbox.scrollTop(Math.floor(position.top));
//                console.log(position.top);

                selected.removeClass('selected');
                next.addClass('selected');
            }
        }

        return;
    }
    $('#search-resultbox').show();
    $('#search-results').html('<li><span class="no-results">No results</span></li>');

    var result = jssearch.search(query);

    if (result.length > 0) {
        var i = 0;
        var resHtml = '';

        for (var key in result) {
            if (i++ > 20) {
                break;
            }
            resHtml = resHtml +
            '<li><a href="' + result[key].file.u.substr(3) +'"><span class="title">' + result[key].file.t + '</span>' +
            '<span class="description">' + result[key].file.d + '</span></a></li>';
        }
        $('#search-results').html(resHtml);
    }
});

// hide the search results on ESC
$(document).on("keyup", function(event) { if (event.which == 27) { $('#search-resultbox').hide(); } });
// hide search results on click to document
$(document).bind('click', function (e) { $('#search-resultbox').hide(); });
// except the following:
searchBox.bind('click', function(e) { e.stopPropagation(); });
$('#search-resultbox').bind('click', function(e) { e.stopPropagation(); });

});</script></body>
</html>
