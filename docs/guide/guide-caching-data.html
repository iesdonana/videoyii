<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="language" content="en" />
        <link href="./assets/90d046f2/css/bootstrap.css" rel="stylesheet">
<link href="./assets/c6368d94/solarized_light.css" rel="stylesheet">
<link href="./assets/9f5cdd92/style.css" rel="stylesheet">
<script src="./assets/a6e53573/jquery.js"></script>
<script src="./assets/90d046f2/js/bootstrap.js"></script>
<script src="./assets/218ce2e5/jssearch.js"></script>    <title>Cache dữ liệu - Bộ nhớ Cache - The Definitive Guide to Yii 2.0</title>
</head>
<body>

<div class="wrap">
    <nav id="w12436" class="navbar-inverse navbar-fixed-top navbar" role="navigation"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#w12436-collapse"><span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span></button><a class="navbar-brand" href="./guide-index.html">The Definitive Guide to Yii 2.0</a></div><div id="w12436-collapse" class="collapse navbar-collapse"><ul id="w12437" class="navbar-nav nav"><li><a href="./guide-README.html">Guide</a></li></ul><div class="navbar-form navbar-left" role="search">
  <div class="form-group">
    <input id="searchbox" type="text" class="form-control" placeholder="Search">
  </div>
</div>
</div></nav>
    <div id="search-resultbox" style="display: none;" class="modal-content">
        <ul id="search-results">
        </ul>
    </div>

    
<div class="row">
    <div class="col-md-2">
                <div id="navigation" class="list-group"><a class="list-group-item" href="#navigation-12420" data-toggle="collapse" data-parent="#navigation">Giới thiệu <b class="caret"></b></a><div id="navigation-12420" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-intro-yii.html">Về Yii</a>
<a class="list-group-item" href="./guide-intro-upgrade-from-v1.html">Nâng cấp lên từ phiên bản 1.1</a></div>
<a class="list-group-item" href="#navigation-12421" data-toggle="collapse" data-parent="#navigation">Bắt đầu <b class="caret"></b></a><div id="navigation-12421" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-start-installation.html">Cài đặt Yii</a>
<a class="list-group-item" href="./guide-start-workflow.html">Thực hiện chạy ứng dụng</a>
<a class="list-group-item" href="./guide-start-hello.html">Viết lời chào đầu tiên</a>
<a class="list-group-item" href="./guide-start-forms.html">Làm việc với Forms</a>
<a class="list-group-item" href="./guide-start-databases.html">Làm việc với Databases</a>
<a class="list-group-item" href="./guide-start-gii.html">Sử dụng Gii để sinh code</a>
<a class="list-group-item" href="./guide-start-looking-ahead.html">Mức cao hơn</a></div>
<a class="list-group-item" href="#navigation-12422" data-toggle="collapse" data-parent="#navigation">Kiến trúc ứng dụng (Application Structure) <b class="caret"></b></a><div id="navigation-12422" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-structure-overview.html">Tổng quan về kiến trúc ứng dụng</a>
<a class="list-group-item" href="./guide-structure-entry-scripts.html">Mục Scripts</a>
<a class="list-group-item" href="./guide-structure-applications.html">Ứng dụng (Applications)</a>
<a class="list-group-item" href="./guide-structure-application-components.html">Thành phần ứng dụng</a>
<a class="list-group-item" href="./guide-structure-controllers.html">Bộ điều khiển (Controllers)</a>
<a class="list-group-item" href="./guide-structure-models.html">Models</a>
<a class="list-group-item" href="./guide-structure-views.html">Views</a>
<a class="list-group-item" href="./guide-structure-modules.html">Modules</a>
<a class="list-group-item" href="./guide-structure-filters.html">Bộ lọc (Filters)</a>
<a class="list-group-item" href="./guide-structure-widgets.html">Widgets</a>
<a class="list-group-item" href="./guide-structure-assets.html">Assets</a>
<a class="list-group-item" href="./guide-structure-extensions.html">Phần mở rộng (Extensions)</a></div>
<a class="list-group-item" href="#navigation-12423" data-toggle="collapse" data-parent="#navigation">Yêu cầu xử lý (Handling Requests) <b class="caret"></b></a><div id="navigation-12423" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-runtime-overview.html">Tổng quan</a>
<a class="list-group-item" href="./guide-runtime-bootstrapping.html">Bootstrapping</a>
<a class="list-group-item" href="./guide-runtime-routing.html">Routing và URL Creation</a>
<a class="list-group-item" href="./guide-runtime-requests.html">Yêu cầu (Requests)</a>
<a class="list-group-item" href="./guide-runtime-responses.html">Responses</a>
<a class="list-group-item" href="./guide-runtime-sessions-cookies.html">Sessions và Cookies</a>
<a class="list-group-item" href="./guide-runtime-handling-errors.html">Xử lý lỗi (Handling Error)</a>
<a class="list-group-item" href="./guide-runtime-logging.html">Logging</a></div>
<a class="list-group-item" href="#navigation-12424" data-toggle="collapse" data-parent="#navigation">Các khái niệm chính <b class="caret"></b></a><div id="navigation-12424" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-concept-components.html">Thành phần (Components)</a>
<a class="list-group-item" href="./guide-concept-properties.html">Thuộc tính (Properties)</a>
<a class="list-group-item" href="./guide-concept-events.html">Sự kiện (Events)</a>
<a class="list-group-item" href="./guide-concept-behaviors.html">Hành vi (Behaviors)</a>
<a class="list-group-item" href="./guide-concept-configurations.html">Cấu hình (Configurations)</a>
<a class="list-group-item" href="./guide-concept-aliases.html">Bí danh (Aliases)</a>
<a class="list-group-item" href="./guide-concept-autoloading.html">Lớp tự động nạp (Autoloading)</a>
<a class="list-group-item" href="./guide-concept-service-locator.html">Service Locator</a>
<a class="list-group-item" href="./guide-concept-di-container.html">Dependency Injection Container</a></div>
<a class="list-group-item" href="#navigation-12425" data-toggle="collapse" data-parent="#navigation">Làm việc với Databases <b class="caret"></b></a><div id="navigation-12425" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-db-dao.html">Data Access Objects</a>
<a class="list-group-item" href="./guide-db-query-builder.html">Query Builder</a>
<a class="list-group-item" href="./guide-db-active-record.html">Active Record</a>
<a class="list-group-item" href="./guide-db-migrations.html">Migrations</a>
<a class="list-group-item" href="./guide-db-sphinx.html">Sphinx</a>
<a class="list-group-item" href="./guide-db-redis.html">Redis</a>
<a class="list-group-item" href="./guide-db-mongodb.html">MongoDB</a>
<a class="list-group-item" href="./guide-db-elasticsearch.html">ElasticSearch</a></div>
<a class="list-group-item" href="#navigation-12426" data-toggle="collapse" data-parent="#navigation">Nhận dữ liệu từ user <b class="caret"></b></a><div id="navigation-12426" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-input-forms.html">Tạo mới Forms</a>
<a class="list-group-item" href="./guide-input-validation.html">Kiểm tra dữ liệu đầu vào (Validating Input)</a>
<a class="list-group-item" href="./guide-input-file-upload.html">File Upload</a>
<a class="list-group-item" href="./guide-input-tabular-input.html">Thu thập dữ liệu từ danh sách đầu vào (Đang phát triển)</a>
<a class="list-group-item" href="./guide-input-multiple-models.html">Lấy dữ liệu cho nhiều Models (Chưa giải quyết)</a></div>
<a class="list-group-item" href="#navigation-12427" data-toggle="collapse" data-parent="#navigation">Hiển thị dữ liệu <b class="caret"></b></a><div id="navigation-12427" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-output-formatter.html">Định dạng dữ liệu (Data Formatting)</a>
<a class="list-group-item" href="./guide-output-pagination.html">Phân trang (Pagination)</a>
<a class="list-group-item" href="./guide-output-sorting.html">Sắp xếp (Sorting)</a>
<a class="list-group-item" href="./guide-output-data-providers.html">Cung cấp dữ liệu ra (Data Providers)</a>
<a class="list-group-item" href="./guide-output-data-widgets.html">Dữ liệu Widgets</a>
<a class="list-group-item" href="./guide-output-client-scripts.html">làm việc với Client Scripts</a>
<a class="list-group-item" href="./guide-output-theming.html">Giao diện (Theming)</a></div>
<a class="list-group-item" href="#navigation-12428" data-toggle="collapse" data-parent="#navigation">Bảo mật (Security) <b class="caret"></b></a><div id="navigation-12428" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-security-authentication.html">Xác thực (Authentication)</a>
<a class="list-group-item" href="./guide-security-authorization.html">Quyền (Authorization)</a>
<a class="list-group-item" href="./guide-security-passwords.html">Các thao tác xử lý với Passwords (Đang phát triển)</a>
<a class="list-group-item" href="./guide-security-auth-clients.html">Auth Clients</a>
<a class="list-group-item" href="./guide-security-best-practices.html">Best Practices</a></div>
<a class="list-group-item active" href="#navigation-12429" data-toggle="collapse" data-parent="#navigation">Bộ nhớ Cache <b class="caret"></b></a><div id="navigation-12429" class="submenu panel-collapse collapse in"><a class="list-group-item" href="./guide-caching-overview.html">Tổng quan</a>
<a class="list-group-item active" href="./guide-caching-data.html">Cache dữ liệu</a>
<a class="list-group-item" href="./guide-caching-fragment.html">Fragment Caching</a>
<a class="list-group-item" href="./guide-caching-page.html">Page Caching</a>
<a class="list-group-item" href="./guide-caching-http.html">HTTP Caching</a></div>
<a class="list-group-item" href="#navigation-12430" data-toggle="collapse" data-parent="#navigation">RESTful Web Services <b class="caret"></b></a><div id="navigation-12430" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-rest-quick-start.html">Bắt đầu</a>
<a class="list-group-item" href="./guide-rest-resources.html">Tài nguyên (Resources)</a>
<a class="list-group-item" href="./guide-rest-controllers.html">Bộ điều khiển (Controllers)</a>
<a class="list-group-item" href="./guide-rest-routing.html">Routing</a>
<a class="list-group-item" href="./guide-rest-response-formatting.html">Định dạng thông điệp gửi đi (Response Formatting)</a>
<a class="list-group-item" href="./guide-rest-authentication.html">Xác thực (Authentication)</a>
<a class="list-group-item" href="./guide-rest-rate-limiting.html">Rate Limiting</a>
<a class="list-group-item" href="./guide-rest-versioning.html">Phiên bản (Version)</a>
<a class="list-group-item" href="./guide-rest-error-handling.html">Error Handling</a></div>
<a class="list-group-item" href="#navigation-12431" data-toggle="collapse" data-parent="#navigation">Công cụ phát triển (Development Tools) <b class="caret"></b></a><div id="navigation-12431" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-tool-debugger.html">Thanh công cụ gỡ lỗi và sửa lỗi (Debug Toolbar và Debugger)</a>
<a class="list-group-item" href="./guide-tool-gii.html">Sử dụng Gii để tạo code</a>
<a class="list-group-item" href="./guide-tool-api-doc.html">Tạo tài liệu về API </a></div>
<a class="list-group-item" href="#navigation-12432" data-toggle="collapse" data-parent="#navigation">Testing <b class="caret"></b></a><div id="navigation-12432" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-test-overview.html">Tổng quan</a>
<a class="list-group-item" href="./guide-test-environment-setup.html">Thiết lập môi trường</a>
<a class="list-group-item" href="./guide-test-unit.html">Unit Tests</a>
<a class="list-group-item" href="./guide-test-functional.html">Kiểm tra chức năng (Functional Tests)</a>
<a class="list-group-item" href="./guide-test-acceptance.html">Acceptance Tests</a>
<a class="list-group-item" href="./guide-test-fixtures.html">Fixtures</a></div>
<a class="list-group-item" href="#navigation-12433" data-toggle="collapse" data-parent="#navigation">Chủ đề năng cao <b class="caret"></b></a><div id="navigation-12433" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-tutorial-advanced-app.html">Advanced Application Template</a>
<a class="list-group-item" href="./guide-tutorial-start-from-scratch.html">Building Application from Scratch</a>
<a class="list-group-item" href="./guide-tutorial-console.html">Giao diện dòng lệnh (Console Commands)</a>
<a class="list-group-item" href="./guide-tutorial-core-validators.html">Core Validators</a>
<a class="list-group-item" href="./guide-tutorial-i18n.html">Quốc tế hóa (Internationalization)</a>
<a class="list-group-item" href="./guide-tutorial-mailing.html">Thư (Mailing)</a>
<a class="list-group-item" href="./guide-tutorial-performance-tuning.html">Tối ưu hiệu năng ứng dụng (Performance Tuning)</a>
<a class="list-group-item" href="./guide-tutorial-shared-hosting.html">Shared Hosting Environment</a>
<a class="list-group-item" href="./guide-tutorial-template-engines.html">Template Engines</a>
<a class="list-group-item" href="./guide-tutorial-yii-integration.html">Working with Third-Party Code</a></div>
<a class="list-group-item" href="#navigation-12434" data-toggle="collapse" data-parent="#navigation">Widgets <b class="caret"></b></a><div id="navigation-12434" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-widget-bootstrap.html">Bootstrap Widgets</a>
<a class="list-group-item" href="./guide-widget-jui.html">jQuery UI Widgets</a></div>
<a class="list-group-item" href="#navigation-12435" data-toggle="collapse" data-parent="#navigation">Helpers <b class="caret"></b></a><div id="navigation-12435" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-helper-overview.html">Tổng quan</a>
<a class="list-group-item" href="./guide-helper-array.html">ArrayHelper</a>
<a class="list-group-item" href="./guide-helper-html.html">Html</a>
<a class="list-group-item" href="./guide-helper-url.html">Url</a></div></div>    </div>
    <div class="col-md-9 guide-content" role="main">
        <h1>データキャッシュ <span id="detakyasshu"></span><a href="#detakyasshu" class="hashlink">&para;</a></h1>
<div class="toc"><ol><li><a href="#cache-components">キャッシュコンポーネント</a></li>
<li><a href="#cache-apis">キャッシュ API</a></li>
<li><a href="#query-caching">クエリキャッシュ</a></li></ol></div>
<p>データキャッシュは PHP の変数をキャッシュに格納し、あとでキャッシュからそれらを読み込みます。
これは、<a href="#query-caching">クエリキャッシュ</a> や <a href="guide-caching-page.html">ページキャッシュ</a> などの、より高度なキャッシュ機能の基礎でもあります。</p>
<p>以下のコードが、データキャッシュの典型的な利用パターンです。ここで、<code>$cache</code> は <a href="#cache-components">キャッシュコンポーネント</a> を指しています。</p>
<pre><code class="hljs php language-php"><span class="hljs-comment">// キャッシュから $data を取得しようと試みる</span>
<span class="hljs-variable">$data</span> = <span class="hljs-variable">$cache</span>-&gt;get(<span class="hljs-variable">$key</span>);

<span class="hljs-keyword">if</span> (<span class="hljs-variable">$data</span> === <span class="hljs-keyword">false</span>) {

    <span class="hljs-comment">// キャッシュの中に $data が見つからない場合は一から作る</span>

    <span class="hljs-comment">// 次回はそれを取得できるように $data をキャッシュに格納する</span>
    <span class="hljs-variable">$cache</span>-&gt;set(<span class="hljs-variable">$key</span>, <span class="hljs-variable">$data</span>);
}

<span class="hljs-comment">// $data はここで利用できる</span>
</code></pre>
<h2>キャッシュコンポーネント  <span id="cache-components"></span><a href="#cache-components" class="hashlink">&para;</a></h2><p>データキャッシュはメモリ、ファイル、データベースなどさまざまなキャッシュストレージを表す、いわゆる <em>キャッシュコンポーネント</em> に依存しています。</p>
<p>キャッシュコンポーネントは通常グローバルに設定しアクセスできるように <a href="guide-structure-application-components.html">アプリケーションコンポーネント</a> として登録されます。
以下のコードは、二台のキャッシュサーバを用いる <a href="http://memcached.org/">Memcached</a> を使うように <code>cache</code> アプリケーションコンポーネントを構成する方法を示すものです。</p>
<pre><code class="hljs php language-php"><span class="hljs-string">'components'</span> =&gt; [
    <span class="hljs-string">'cache'</span> =&gt; [
        <span class="hljs-string">'class'</span> =&gt; <span class="hljs-string">'yii\caching\MemCache'</span>,
        <span class="hljs-string">'servers'</span> =&gt; [
            [
                <span class="hljs-string">'host'</span> =&gt; <span class="hljs-string">'server1'</span>,
                <span class="hljs-string">'port'</span> =&gt; <span class="hljs-number">11211</span>,
                <span class="hljs-string">'weight'</span> =&gt; <span class="hljs-number">100</span>,
            ],
            [
                <span class="hljs-string">'host'</span> =&gt; <span class="hljs-string">'server2'</span>,
                <span class="hljs-string">'port'</span> =&gt; <span class="hljs-number">11211</span>,
                <span class="hljs-string">'weight'</span> =&gt; <span class="hljs-number">50</span>,
            ],
        ],
    ],
],
</code></pre>
<p>こうすると、上記のキャッシュコンポーネントに <code>Yii::$app-&gt;cache</code> という式でアクセスできるようになります。</p>
<p>すべてのキャッシュコンポーネントは同じ API をサポートしているので、アプリケーションの構成情報で設定しなおせば、キャッシュを使っているコードに変更を加えることなく、異なるキャッシュコンポーネントに入れ替えることができます。
例えば上記の構成を <span class="broken-link">yii\caching\ApcCache</span> を使うように変更する場合は以下のようにします:</p>
<pre><code class="hljs php language-php"><span class="hljs-string">'components'</span> =&gt; [
    <span class="hljs-string">'cache'</span> =&gt; [
        <span class="hljs-string">'class'</span> =&gt; <span class="hljs-string">'yii\caching\ApcCache'</span>,
    ],
],
</code></pre>
<blockquote class="tip"><p><strong>Tip: </strong>キャッシュコンポーネントは複数登録することができます。<code>cache</code> という名前のコンポーネントが、キャッシュに依存する多数のクラスによってデフォルトで使用されます (例えば <span class="broken-link">yii\web\UrlManager</span> など) 。</p>
</blockquote>
<h3>サポートされているキャッシュストレージ  <span id="supported-cache-storage"></span><a href="#supported-cache-storage" class="hashlink">&para;</a></h3><p>Yii はさまざまなキャッシュストレージをサポートしています。以下は概要です:</p>
<ul>
<li><span class="broken-link">yii\caching\ApcCache</span>: PHP の <a href="http://php.net/manual/ja/book.apc.php">APC</a> 拡張モジュールを使用します。
集中型の分厚いアプリケーションのキャッシュを扱うときには最速の一つとして考えることができます
(例えば、サーバが一台で、専用のロードバランサを持っていない、などの場合)。</li>
<li><span class="broken-link">yii\caching\DbCache</span>: キャッシュされたデータを格納するためにデータベースのテーブルを使用します。このキャッシュを使用するには <span class="broken-link">yii\caching\DbCache::cacheTable</span> で指定したテーブルを作成する必要があります。</li>
<li><p>このコンポーネントの目的は、キャッシュが利用できることをチェックするためのコードを簡略化することです。
たとえば、開発中やサーバに実際のキャッシュサポートがない場合に、このキャッシュを使用するようにキャッシュコンポーネントを構成することができます。
そして、実際のキャッシュサポートが有効になったときに、対応するキャッシュコンポーネントに切替えて使用します。
どちらの場合も、<code>Yii::$app-&gt;cache</code> が <code>null</code> かも知れないと心配せずに、データを取得するために同じコード <code>Yii::$app-&gt;cache-&gt;get($key)</code> を使用できます。</p>
</li>
<li></li>
<li><span class="broken-link">yii\caching\MemCache</span>: PHP の <a href="http://php.net/manual/ja/book.memcache.php">Memcache</a> と <a href="http://php.net/manual/ja/book.memcached.php">Memcached</a> 拡張モジュールを使用します。
分散型のアプリケーションでキャッシュを扱うときには最速の一つとして考えることができます (例えば、複数台のサーバで、ロードバランサがある、などの場合) 。</li>
<li><span class="broken-link">yii\redis\Cache</span>: <a href="http://redis.io/">Redis</a> の key-value ストアに基づいてキャッシュコンポーネントを実装しています。(Redis の バージョン 2.6.12 以降が必要です) 。</li>
<li><span class="broken-link">yii\caching\WinCache</span>: PHP の <a href="http://iis.net/downloads/microsoft/wincache-extension">WinCache</a> (<a href="http://php.net/manual/ja/book.wincache.php">関連リンク</a>) 拡張モジュールを使用します。</li>
<li><span class="broken-link">yii\caching\XCache</span>: PHP の <a href="http://xcache.lighttpd.net/">XCache</a> 拡張モジュールを使用します。</li>
<li><span class="broken-link">yii\caching\ZendDataCache</span>: キャッシュメディアして <a href="http://files.zend.com/help/Zend-Server-6/zend-server.htm#data_cache_component.htm">Zend Data Cache</a> を使用します。</li>
</ul>
<blockquote class="tip"><p><strong>Tip: </strong>同じアプリケーション内で異なるキャッシュを使用することもできます。一般的なやり方として、小さくとも常に使用されるデータ (例えば、統計データ) を格納する場合はメモリベースのキャッシュストレージを使用し、大きくて使用頻度の低いデータ (例えば、ページコンテント) を格納する場合はファイルベース、またはデータベースのキャッシュストレージを使用します  。</p>
</blockquote>
<h2>キャッシュ API  <span id="cache-apis"></span><a href="#cache-apis" class="hashlink">&para;</a></h2><p>すべてのキャッシュコンポーネントが同じ基底クラス <span class="broken-link">yii\caching\Cache</span> を持っているので、以下の API をサポートしています。</p>
<ul>
<li><span class="broken-link">yii\caching\Cache::get()</span>: 指定されたキーを用いてキャッシュからデータを取得します。データが見つからないか、もしくは有効期限が切れたり無効になったりしている場合は false を返します。</li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
</ul>
<blockquote class="note"><p><strong>Note: </strong><span class="broken-link">yii\caching\Cache::get()</span> メソッドは、データがキャッシュ内に見つからないことを示すために戻り値として false を使用しているので、直接 boolean 型の <code>false</code> をキャッシュしないでください。
代りに配列内に <code>false</code> を置いてキャッシュすることによって、この問題を回避できます。</p>
</blockquote>
<p>キャッシュされたデータを取得する際に発生するオーバーヘッドを減らすために、MemCache, APC などのいくつかのキャッシュストレージは、バッチモードで複数のキャッシュされた値を取得することをサポートしています。
<span class="broken-link">yii\caching\Cache::multiGet()</span> や <span class="broken-link">yii\caching\Cache::multiAdd()</span> などの API はこの機能を十分に引き出すために提供されています。
基礎となるキャッシュストレージがこの機能をサポートしていない場合には、シミュレートされます。</p>
<p><span class="broken-link">yii\caching\Cache</span> は <code>ArrayAccess</code> インターフェイスを継承しているので、キャッシュコンポーネントは配列のように扱うことができます。以下はいくつかの例です:</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$cache</span>[<span class="hljs-string">'var1'</span>] = <span class="hljs-variable">$value1</span>;  <span class="hljs-comment">// $cache-&gt;set('var1', $value1); と同等</span>
<span class="hljs-variable">$value2</span> = <span class="hljs-variable">$cache</span>[<span class="hljs-string">'var2'</span>];  <span class="hljs-comment">// $value2 = $cache-&gt;get('var2'); と同等</span>
</code></pre>
<h3>キャッシュのキー  <span id="cache-keys"></span><a href="#cache-keys" class="hashlink">&para;</a></h3><p>キャッシュに格納される各データは、一意のキーによって識別されます。
キャッシュ内にデータを格納するときはキーを指定する必要があります。
また、あとでキャッシュからデータを取得するときは、それに対応するキーを提供しなければなりません。</p>
<p>キャッシュのキーとしては、文字列または任意の値を使用することができます。キーが文字列でない場合は、自動的に文字列にシリアライズされます。</p>
<p>キャッシュのキーを定義する一般的なやり方として、全ての決定要素を配列の形で含めるという方方があります。
例えば <span class="broken-link">yii\db\Schema</span> はデータベーステーブルのスキーマ情報を以下のキーを使用してキャッシュしています。</p>
<pre><code class="hljs php language-php">[
    <span class="hljs-keyword">__CLASS__</span>,              <span class="hljs-comment">// クラス名</span>
    <span class="hljs-variable">$this</span>-&gt;db-&gt;dsn,         <span class="hljs-comment">// データベース接続のデータソース名</span>
    <span class="hljs-variable">$this</span>-&gt;db-&gt;username,    <span class="hljs-comment">// データベース接続のログインユーザ</span>
    <span class="hljs-variable">$name</span>,                  <span class="hljs-comment">// テーブル名</span>
];
</code></pre>
<p>見ての通り、キーは一意にデータベースのテーブルを指定するために必要なすべての情報を含んでいます。</p>
<p>同じキャッシュストレージが異なるアプリケーションによって使用されているときは、キャッシュのキーの競合を避けるために、各アプリケーションではユニークなキーの接頭辞を指定する必要があります。これは <span class="broken-link">yii\caching\Cache::keyPrefix</span> プロパティを設定することでできます。例えば、アプリケーションのコンフィギュレーションで以下のように書くことができます:</p>
<pre><code class="hljs php language-php"><span class="hljs-string">'components'</span> =&gt; [
    <span class="hljs-string">'cache'</span> =&gt; [
        <span class="hljs-string">'class'</span> =&gt; <span class="hljs-string">'yii\caching\ApcCache'</span>,
        <span class="hljs-string">'keyPrefix'</span> =&gt; <span class="hljs-string">'myapp'</span>,       <span class="hljs-comment">// ユニークなキャッシュのキーの接頭辞</span>
    ],
],
</code></pre>
<p>相互運用性を確保するために、英数字のみを使用する必要があります。</p>
<h3>キャッシュの有効期限  <span id="cache-expiration"></span><a href="#cache-expiration" class="hashlink">&para;</a></h3><p>キャッシュに格納されたデータは、何らかのキャッシュポリシー (例えば、キャッシュスペースがいっぱいになったときは最も古いデータが削除される、など) の実施で除去されない限り、永遠に残り続けます。
この動作を変えるために <span class="broken-link">yii\caching\Cache::set()</span> を呼んでデータアイテムを保存するときに、有効期限パラメータを指定することができます。
このパラメータは、データアイテムが何秒間有効なものとしてキャッシュ内に残ることが出来るかを示します。
<span class="broken-link">yii\caching\Cache::get()</span> でデータアイテムを取得する際に有効期限が切れていた場合は、キャッシュ内にデータが見つからなかったことを示す false が返されます。例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-comment">// 最大で 45 秒間キャッシュ内にデータを保持する</span>
<span class="hljs-variable">$cache</span>-&gt;set(<span class="hljs-variable">$key</span>, <span class="hljs-variable">$data</span>, <span class="hljs-number">45</span>);

sleep(<span class="hljs-number">50</span>);

<span class="hljs-variable">$data</span> = <span class="hljs-variable">$cache</span>-&gt;get(<span class="hljs-variable">$key</span>);
<span class="hljs-keyword">if</span> (<span class="hljs-variable">$data</span> === <span class="hljs-keyword">false</span>) {
    <span class="hljs-comment">// $data は有効期限が切れているか、またはキャッシュ内に見つからない</span>
}
</code></pre>
<h3>キャッシュの依存  <span id="cache-dependencies"></span><a href="#cache-dependencies" class="hashlink">&para;</a></h3><p>有効期限の設定に加えて、キャッシュされたデータは、いわゆる <em>キャッシュの依存</em> (キャッシュが依存している事物) の変化によって無効にすることもできます。
例えば <span class="broken-link">yii\caching\FileDependency</span> は、キャッシュがファイルの更新時刻に依存していることを表しています。
この依存が変化したときは、対応するファイルが更新されたことを意味します。
その結果、キャッシュ内で見つかった古いファイルのコンテントは、無効とされるべきであり <span class="broken-link">yii\caching\Cache::get()</span> は false を返さなければなりません。</p>
<p>キャッシュの依存は <span class="broken-link">yii\caching\Dependency</span> 子孫クラスのオブジェクトとして表現されます。
<span class="broken-link">yii\caching\Cache::set()</span> でキャッシュにデータアイテムを格納する際に、関連するキャッシュの依存のオブジェクトを一緒に渡すことができます。例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-comment">// example.txt ファイルの更新時刻への依存を作成します。</span>
<span class="hljs-variable">$dependency</span> = <span class="hljs-keyword">new</span> \yii\caching\FileDependency([<span class="hljs-string">'fileName'</span> =&gt; <span class="hljs-string">'example.txt'</span>]);

<span class="hljs-comment">// データは 30 秒で期限切れになります。</span>
<span class="hljs-comment">// さらに、example.txt が変更された場合、有効期限内でも無効になります。</span>
<span class="hljs-variable">$cache</span>-&gt;set(<span class="hljs-variable">$key</span>, <span class="hljs-variable">$data</span>, <span class="hljs-number">30</span>, <span class="hljs-variable">$dependency</span>);

<span class="hljs-comment">// キャッシュはデータの有効期限が切れているかをチェックします。</span>
<span class="hljs-comment">// 同時に、関連付けられた依存が変更されているかもチェックします。</span>
<span class="hljs-comment">// これらの条件のいずれかが満たされている場合は false を返します。</span>
<span class="hljs-variable">$data</span> = <span class="hljs-variable">$cache</span>-&gt;get(<span class="hljs-variable">$key</span>);
</code></pre>
<p>以下は利用可能なキャッシュの依存の概要です:</p>
<ul>
<li></li>
<li><span class="broken-link">yii\caching\DbDependency</span>: 指定された SQL 文のクエリ結果が変更された場合、依存が変更されます。</li>
<li><span class="broken-link">yii\caching\ExpressionDependency</span>: 指定された PHP の式の結果が変更された場合、依存が変更されます。</li>
<li></li>
<li><p><span class="broken-link">yii\caching\TagDependency::invalidate()</span> を呼び出すことによって、指定されたタグ (複数可) を持つキャッシュされたデータアイテムを無効にすることができます。</p>
</li>
</ul>
<blockquote class="note"><p><strong>Note: </strong>依存を有するキャッシュについて <span class="broken-link">yii\caching\Cache::exists()</span> メソッドを使用することは避けてください。
  このメソッドは、キャッシュされたデータに関連づけられた依存がある場合でも、依存が変化したかどうかをチェックしません。
  つまり、<span class="broken-link">yii\caching\Cache::exists()</span> が <code>true</code> を返しているのに、 <span class="broken-link">yii\caching\Cache::get()</span> が <code>false</code> を返すという場合があり得ます。</p>
</blockquote>
<h2>クエリキャッシュ  <span id="query-caching"></span><a href="#query-caching" class="hashlink">&para;</a></h2><p>クエリキャッシュは、データキャッシュ上に構築された特別なキャッシュ機能で、データベースのクエリ結果をキャッシュするために提供されています。</p>
<p>クエリキャッシュは <span class="broken-link">yii\db\Connection</span> と有効な <code>cache</code> <a href="#cache-components">アプリケーションコンポーネント</a> を必要とします。
<code>$db</code> を <span class="broken-link">yii\db\Connection</span> のインスタンスと仮定した場合、クエリキャッシュの基本的な使い方は以下のようになります:</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$result</span> = <span class="hljs-variable">$db</span>-&gt;cache(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(<span class="hljs-variable">$db</span>)</span> </span>{

    <span class="hljs-comment">// クエリキャッシュが有効で、かつクエリ結果がキャッシュ内にある場合、</span>
    <span class="hljs-comment">// SQL クエリ結果がキャッシュから提供されます</span>
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$db</span>-&gt;createCommand(<span class="hljs-string">'SELECT * FROM customer WHERE id=1'</span>)-&gt;queryOne();

});
</code></pre>
<p>クエリキャッシュは <a href="guide-db-dao.html">DAO</a> だけではなく <a href="guide-db-active-record.html">アクティブレコード</a> でも使用することができます。</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$result</span> = Customer::getDb()-&gt;cache(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(<span class="hljs-variable">$db</span>)</span> </span>{
    <span class="hljs-keyword">return</span> Customer::find()-&gt;where([<span class="hljs-string">'id'</span> =&gt; <span class="hljs-number">1</span>])-&gt;one();
});
</code></pre>
<blockquote class="info"><p><strong>Info: </strong>いくつかの DBMS (例えば <a href="http://dev.mysql.com/doc/refman/5.1/ja/query-cache.html">MySQL</a>) でもデータベースのサーバサイドのクエリキャッシュをサポートしています。
  どちらのクエリキャッシュメカニズムも選べますが、前述した Yii のクエリキャッシュにはキャッシュの依存を柔軟に指定できるという利点があり、潜在的にはより効率的でしょう。</p>
</blockquote>
<h3>キャッシュのフラッシュ <span id="cache-flushing"> <span id="kyasshunofurasshu"></span><a href="#kyasshunofurasshu" class="hashlink">&para;</a></h3><p>保存されている全てのキャッシュデータを無効化する必要がある場合は、<span class="broken-link">yii\caching\Cache::flush()</span> を呼ぶことが出来ます。</p>
<p>コンソールから <code>yii cache/flush</code> を呼ぶことによっても、キャッシュをフラッシュすることが出来ます。</p>
<ul>
<li><code>yii cache</code>: アプリケーションで利用可能なキャッシュのリストを表示します。</li>
<li><code>yii cache/flush cache1 cache2</code>: キャッシュコンポーネント <code>cache1</code> と <code>cache2</code> をフラッシュします
(複数のコンポーネント名をスペースで区切って渡すことが出来ます)</li>
<li><code>yii cache/flush-all</code>: アプリケーションの全てのキャッシュコンポーネントをフラッシュします。</li>
</ul>
<blockquote class="info"><p><strong>Info: </strong>デフォルトでは、コンソールアプリケーションは独立した構成情報ファイルを使用します。
正しい結果を得るためには、ウェブとコンソールのアプリケーション構成で同じキャッシュコンポーネントを使用していることを確認してください。</p>
</blockquote>
<h3>構成  <span id="query-caching-configs"></span><a href="#query-caching-configs" class="hashlink">&para;</a></h3><p>クエリキャッシュには <span class="broken-link">yii\db\Connection</span> を通して設定可能な三つのグローバルなオプションがあります:</p>
<ul>
<li><span class="broken-link">yii\db\Connection::enableQueryCache</span>: クエリキャッシュを可能にするかどうか。デフォルトは true です。
実効的にクエリキャッシュをオンにするには <span class="broken-link">yii\db\Connection::queryCache</span> によって指定される有効なキャッシュを持っている必要があることに注意してください。</li>
<li><p>クエリキャッシュを永遠にキャッシュに残したい場合は 0 を指定することができます。
このプロパティは <span class="broken-link">yii\db\Connection::cache()</span> が持続時間を指定せず呼び出されたときに使用されるデフォルト値です。</p>
</li>
<li><span class="broken-link">yii\db\Connection::queryCache</span>: これはキャッシュアプリケーションコンポーネントの ID を表します。
デフォルトは <code>'cache'</code> です。有効なキャッシュコンポーネントが存在する場合にのみ、クエリキャッシュが使用可能になります。</li>
</ul>
<h3>使い方  <span id="query-caching-usages"></span><a href="#query-caching-usages" class="hashlink">&para;</a></h3><p>クエリキャッシュを使用する必要がある複数の SQL クエリを持っている場合は <span class="broken-link">yii\db\Connection::cache()</span> を使用することができます。使い方としては以下のように、</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$duration</span> = <span class="hljs-number">60</span>;     <span class="hljs-comment">// クエリ結果を 60 秒間 キャッシュ</span>
<span class="hljs-variable">$dependency</span> = ...;  <span class="hljs-comment">// 依存のオプション</span>

<span class="hljs-variable">$result</span> = <span class="hljs-variable">$db</span>-&gt;cache(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(<span class="hljs-variable">$db</span>)</span> </span>{

    <span class="hljs-comment">// ... ここで SQL クエリを実行します ...</span>

    <span class="hljs-keyword">return</span> <span class="hljs-variable">$result</span>;

}, <span class="hljs-variable">$duration</span>, <span class="hljs-variable">$dependency</span>);
</code></pre>
<p>無名関数内の任意の SQL クエリは、指定した依存とともに指定された期間キャッシュされます。
もしキャッシュ内に有効なクエリ結果が見つかった場合は、クエリはスキップされ、代りに結果がキャッシュから提供されます。
<code>$duration</code> の指定がない場合 <span class="broken-link">yii\db\Connection::queryCacheDuration</span> で指定されている値が代りに使用されます。</p>
<p>また、<code>cache()</code> 内でいくつかの特定のクエリに対してクエリキャッシュを無効にすることもできます。この場合 <span class="broken-link">yii\db\Connection::noCache()</span> を使用します。</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$result</span> = <span class="hljs-variable">$db</span>-&gt;cache(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(<span class="hljs-variable">$db</span>)</span> </span>{

    <span class="hljs-comment">// クエリキャッシュを使用する SQL クエリ</span>

    <span class="hljs-variable">$db</span>-&gt;noCache(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(<span class="hljs-variable">$db</span>)</span> </span>{

        <span class="hljs-comment">// クエリキャッシュを使用しない SQL クエリ</span>

    });

    <span class="hljs-comment">// ...</span>

    <span class="hljs-keyword">return</span> <span class="hljs-variable">$result</span>;
});
</code></pre>
<p>単一のクエリのためにクエリキャッシュを使用する場合は、コマンドを構築するときに <span class="broken-link">yii\db\Command::cache()</span> を呼び出すことができます。例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-comment">// クエリキャッシュを使い、期間を 60 秒にセットする</span>
<span class="hljs-variable">$customer</span> = <span class="hljs-variable">$db</span>-&gt;createCommand(<span class="hljs-string">'SELECT * FROM customer WHERE id=1'</span>)-&gt;cache(<span class="hljs-number">60</span>)-&gt;queryOne();
</code></pre>
<p>また、一つのコマンドに対してクエリキャッシュを無効にするために <span class="broken-link">yii\db\Command::noCache()</span> を使用することもできます。例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$result</span> = <span class="hljs-variable">$db</span>-&gt;cache(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(<span class="hljs-variable">$db</span>)</span> </span>{

    <span class="hljs-comment">// クエリキャッシュを使用する SQL クエリ</span>

    <span class="hljs-comment">// このコマンドはクエリキャッシュを使用しない</span>
    <span class="hljs-variable">$customer</span> = <span class="hljs-variable">$db</span>-&gt;createCommand(<span class="hljs-string">'SELECT * FROM customer WHERE id=1'</span>)-&gt;noCache()-&gt;queryOne();

    <span class="hljs-comment">// ...</span>

    <span class="hljs-keyword">return</span> <span class="hljs-variable">$result</span>;
});
</code></pre>
<h3>制約  <span id="query-caching-limitations"></span><a href="#query-caching-limitations" class="hashlink">&para;</a></h3><p>リソースハンドラを返すようなクエリにはクエリキャッシュは働きません。
例えば、いくつかの DBMS において BLOB 型のカラムを用いる場合、クエリ結果はカラムデータに対するリソースハンドラを返します。</p>
<p>いくつかのキャッシュストレージはサイズに制約があります。例えば Memcache では、各エントリのサイズは 1MB が上限値です。そのためクエリ結果のサイズがこの制約を越える場合、キャッシュは失敗します。</p>
        <div class="toplink"><a href="#" class="h1" title="go to top"><span class="glyphicon glyphicon-arrow-up"></a></div>
    </div>
</div>


</div>

<footer class="footer">
        <p class="pull-right"><small>Page generated on Tue, 27 Dec 2016 22:28:43 +0000</small></p>
    Powered by <a href="http://www.yiiframework.com/" rel="external">Yii Framework</a></footer>

<script type="text/javascript">jQuery(document).ready(function () {
    var shiftWindow = function () { scrollBy(0, -50) };
    if (location.hash) setTimeout(shiftWindow, 1);
    window.addEventListener("hashchange", shiftWindow);
var element = document.createElement("script");
element.src = "./jssearch.index.js";
document.body.appendChild(element);

var searchBox = $('#searchbox');

// search when typing in search field
searchBox.on("keyup", function(event) {
    var query = $(this).val();

    if (query == '' || event.which == 27) {
        $('#search-resultbox').hide();
        return;
    } else if (event.which == 13) {
        var selectedLink = $('#search-resultbox a.selected');
        if (selectedLink.length != 0) {
            document.location = selectedLink.attr('href');
            return;
        }
    } else if (event.which == 38 || event.which == 40) {
        $('#search-resultbox').show();

        var selected = $('#search-resultbox a.selected');
        if (selected.length == 0) {
            $('#search-results').find('a').first().addClass('selected');
        } else {
            var next;
            if (event.which == 40) {
                next = selected.parent().next().find('a').first();
            } else {
                next = selected.parent().prev().find('a').first();
            }
            if (next.length != 0) {
                var resultbox = $('#search-results');
                var position = next.position();

//              TODO scrolling is buggy and jumps around
//                resultbox.scrollTop(Math.floor(position.top));
//                console.log(position.top);

                selected.removeClass('selected');
                next.addClass('selected');
            }
        }

        return;
    }
    $('#search-resultbox').show();
    $('#search-results').html('<li><span class="no-results">No results</span></li>');

    var result = jssearch.search(query);

    if (result.length > 0) {
        var i = 0;
        var resHtml = '';

        for (var key in result) {
            if (i++ > 20) {
                break;
            }
            resHtml = resHtml +
            '<li><a href="' + result[key].file.u.substr(3) +'"><span class="title">' + result[key].file.t + '</span>' +
            '<span class="description">' + result[key].file.d + '</span></a></li>';
        }
        $('#search-results').html(resHtml);
    }
});

// hide the search results on ESC
$(document).on("keyup", function(event) { if (event.which == 27) { $('#search-resultbox').hide(); } });
// hide search results on click to document
$(document).bind('click', function (e) { $('#search-resultbox').hide(); });
// except the following:
searchBox.bind('click', function(e) { e.stopPropagation(); });
$('#search-resultbox').bind('click', function(e) { e.stopPropagation(); });

});</script></body>
</html>
