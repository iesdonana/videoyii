<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="language" content="en" />
        <link href="./assets/90d046f2/css/bootstrap.css" rel="stylesheet">
<link href="./assets/c6368d94/solarized_light.css" rel="stylesheet">
<link href="./assets/9f5cdd92/style.css" rel="stylesheet">
<script src="./assets/a6e53573/jquery.js"></script>
<script src="./assets/90d046f2/js/bootstrap.js"></script>
<script src="./assets/218ce2e5/jssearch.js"></script>    <title>Quyền (Authorization) - Bảo mật (Security) - The Definitive Guide to Yii 2.0</title>
</head>
<body>

<div class="wrap">
    <nav id="w12148" class="navbar-inverse navbar-fixed-top navbar" role="navigation"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#w12148-collapse"><span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span></button><a class="navbar-brand" href="./guide-index.html">The Definitive Guide to Yii 2.0</a></div><div id="w12148-collapse" class="collapse navbar-collapse"><ul id="w12149" class="navbar-nav nav"><li><a href="./guide-README.html">Guide</a></li></ul><div class="navbar-form navbar-left" role="search">
  <div class="form-group">
    <input id="searchbox" type="text" class="form-control" placeholder="Search">
  </div>
</div>
</div></nav>
    <div id="search-resultbox" style="display: none;" class="modal-content">
        <ul id="search-results">
        </ul>
    </div>

    
<div class="row">
    <div class="col-md-2">
                <div id="navigation" class="list-group"><a class="list-group-item" href="#navigation-12132" data-toggle="collapse" data-parent="#navigation">Giới thiệu <b class="caret"></b></a><div id="navigation-12132" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-intro-yii.html">Về Yii</a>
<a class="list-group-item" href="./guide-intro-upgrade-from-v1.html">Nâng cấp lên từ phiên bản 1.1</a></div>
<a class="list-group-item" href="#navigation-12133" data-toggle="collapse" data-parent="#navigation">Bắt đầu <b class="caret"></b></a><div id="navigation-12133" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-start-installation.html">Cài đặt Yii</a>
<a class="list-group-item" href="./guide-start-workflow.html">Thực hiện chạy ứng dụng</a>
<a class="list-group-item" href="./guide-start-hello.html">Viết lời chào đầu tiên</a>
<a class="list-group-item" href="./guide-start-forms.html">Làm việc với Forms</a>
<a class="list-group-item" href="./guide-start-databases.html">Làm việc với Databases</a>
<a class="list-group-item" href="./guide-start-gii.html">Sử dụng Gii để sinh code</a>
<a class="list-group-item" href="./guide-start-looking-ahead.html">Mức cao hơn</a></div>
<a class="list-group-item" href="#navigation-12134" data-toggle="collapse" data-parent="#navigation">Kiến trúc ứng dụng (Application Structure) <b class="caret"></b></a><div id="navigation-12134" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-structure-overview.html">Tổng quan về kiến trúc ứng dụng</a>
<a class="list-group-item" href="./guide-structure-entry-scripts.html">Mục Scripts</a>
<a class="list-group-item" href="./guide-structure-applications.html">Ứng dụng (Applications)</a>
<a class="list-group-item" href="./guide-structure-application-components.html">Thành phần ứng dụng</a>
<a class="list-group-item" href="./guide-structure-controllers.html">Bộ điều khiển (Controllers)</a>
<a class="list-group-item" href="./guide-structure-models.html">Models</a>
<a class="list-group-item" href="./guide-structure-views.html">Views</a>
<a class="list-group-item" href="./guide-structure-modules.html">Modules</a>
<a class="list-group-item" href="./guide-structure-filters.html">Bộ lọc (Filters)</a>
<a class="list-group-item" href="./guide-structure-widgets.html">Widgets</a>
<a class="list-group-item" href="./guide-structure-assets.html">Assets</a>
<a class="list-group-item" href="./guide-structure-extensions.html">Phần mở rộng (Extensions)</a></div>
<a class="list-group-item" href="#navigation-12135" data-toggle="collapse" data-parent="#navigation">Yêu cầu xử lý (Handling Requests) <b class="caret"></b></a><div id="navigation-12135" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-runtime-overview.html">Tổng quan</a>
<a class="list-group-item" href="./guide-runtime-bootstrapping.html">Bootstrapping</a>
<a class="list-group-item" href="./guide-runtime-routing.html">Routing và URL Creation</a>
<a class="list-group-item" href="./guide-runtime-requests.html">Yêu cầu (Requests)</a>
<a class="list-group-item" href="./guide-runtime-responses.html">Responses</a>
<a class="list-group-item" href="./guide-runtime-sessions-cookies.html">Sessions và Cookies</a>
<a class="list-group-item" href="./guide-runtime-handling-errors.html">Xử lý lỗi (Handling Error)</a>
<a class="list-group-item" href="./guide-runtime-logging.html">Logging</a></div>
<a class="list-group-item" href="#navigation-12136" data-toggle="collapse" data-parent="#navigation">Các khái niệm chính <b class="caret"></b></a><div id="navigation-12136" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-concept-components.html">Thành phần (Components)</a>
<a class="list-group-item" href="./guide-concept-properties.html">Thuộc tính (Properties)</a>
<a class="list-group-item" href="./guide-concept-events.html">Sự kiện (Events)</a>
<a class="list-group-item" href="./guide-concept-behaviors.html">Hành vi (Behaviors)</a>
<a class="list-group-item" href="./guide-concept-configurations.html">Cấu hình (Configurations)</a>
<a class="list-group-item" href="./guide-concept-aliases.html">Bí danh (Aliases)</a>
<a class="list-group-item" href="./guide-concept-autoloading.html">Lớp tự động nạp (Autoloading)</a>
<a class="list-group-item" href="./guide-concept-service-locator.html">Service Locator</a>
<a class="list-group-item" href="./guide-concept-di-container.html">Dependency Injection Container</a></div>
<a class="list-group-item" href="#navigation-12137" data-toggle="collapse" data-parent="#navigation">Làm việc với Databases <b class="caret"></b></a><div id="navigation-12137" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-db-dao.html">Data Access Objects</a>
<a class="list-group-item" href="./guide-db-query-builder.html">Query Builder</a>
<a class="list-group-item" href="./guide-db-active-record.html">Active Record</a>
<a class="list-group-item" href="./guide-db-migrations.html">Migrations</a>
<a class="list-group-item" href="./guide-db-sphinx.html">Sphinx</a>
<a class="list-group-item" href="./guide-db-redis.html">Redis</a>
<a class="list-group-item" href="./guide-db-mongodb.html">MongoDB</a>
<a class="list-group-item" href="./guide-db-elasticsearch.html">ElasticSearch</a></div>
<a class="list-group-item" href="#navigation-12138" data-toggle="collapse" data-parent="#navigation">Nhận dữ liệu từ user <b class="caret"></b></a><div id="navigation-12138" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-input-forms.html">Tạo mới Forms</a>
<a class="list-group-item" href="./guide-input-validation.html">Kiểm tra dữ liệu đầu vào (Validating Input)</a>
<a class="list-group-item" href="./guide-input-file-upload.html">File Upload</a>
<a class="list-group-item" href="./guide-input-tabular-input.html">Thu thập dữ liệu từ danh sách đầu vào (Đang phát triển)</a>
<a class="list-group-item" href="./guide-input-multiple-models.html">Lấy dữ liệu cho nhiều Models (Chưa giải quyết)</a></div>
<a class="list-group-item" href="#navigation-12139" data-toggle="collapse" data-parent="#navigation">Hiển thị dữ liệu <b class="caret"></b></a><div id="navigation-12139" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-output-formatter.html">Định dạng dữ liệu (Data Formatting)</a>
<a class="list-group-item" href="./guide-output-pagination.html">Phân trang (Pagination)</a>
<a class="list-group-item" href="./guide-output-sorting.html">Sắp xếp (Sorting)</a>
<a class="list-group-item" href="./guide-output-data-providers.html">Cung cấp dữ liệu ra (Data Providers)</a>
<a class="list-group-item" href="./guide-output-data-widgets.html">Dữ liệu Widgets</a>
<a class="list-group-item" href="./guide-output-client-scripts.html">làm việc với Client Scripts</a>
<a class="list-group-item" href="./guide-output-theming.html">Giao diện (Theming)</a></div>
<a class="list-group-item active" href="#navigation-12140" data-toggle="collapse" data-parent="#navigation">Bảo mật (Security) <b class="caret"></b></a><div id="navigation-12140" class="submenu panel-collapse collapse in"><a class="list-group-item" href="./guide-security-authentication.html">Xác thực (Authentication)</a>
<a class="list-group-item active" href="./guide-security-authorization.html">Quyền (Authorization)</a>
<a class="list-group-item" href="./guide-security-passwords.html">Các thao tác xử lý với Passwords (Đang phát triển)</a>
<a class="list-group-item" href="./guide-security-auth-clients.html">Auth Clients</a>
<a class="list-group-item" href="./guide-security-best-practices.html">Best Practices</a></div>
<a class="list-group-item" href="#navigation-12141" data-toggle="collapse" data-parent="#navigation">Bộ nhớ Cache <b class="caret"></b></a><div id="navigation-12141" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-caching-overview.html">Tổng quan</a>
<a class="list-group-item" href="./guide-caching-data.html">Cache dữ liệu</a>
<a class="list-group-item" href="./guide-caching-fragment.html">Fragment Caching</a>
<a class="list-group-item" href="./guide-caching-page.html">Page Caching</a>
<a class="list-group-item" href="./guide-caching-http.html">HTTP Caching</a></div>
<a class="list-group-item" href="#navigation-12142" data-toggle="collapse" data-parent="#navigation">RESTful Web Services <b class="caret"></b></a><div id="navigation-12142" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-rest-quick-start.html">Bắt đầu</a>
<a class="list-group-item" href="./guide-rest-resources.html">Tài nguyên (Resources)</a>
<a class="list-group-item" href="./guide-rest-controllers.html">Bộ điều khiển (Controllers)</a>
<a class="list-group-item" href="./guide-rest-routing.html">Routing</a>
<a class="list-group-item" href="./guide-rest-response-formatting.html">Định dạng thông điệp gửi đi (Response Formatting)</a>
<a class="list-group-item" href="./guide-rest-authentication.html">Xác thực (Authentication)</a>
<a class="list-group-item" href="./guide-rest-rate-limiting.html">Rate Limiting</a>
<a class="list-group-item" href="./guide-rest-versioning.html">Phiên bản (Version)</a>
<a class="list-group-item" href="./guide-rest-error-handling.html">Error Handling</a></div>
<a class="list-group-item" href="#navigation-12143" data-toggle="collapse" data-parent="#navigation">Công cụ phát triển (Development Tools) <b class="caret"></b></a><div id="navigation-12143" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-tool-debugger.html">Thanh công cụ gỡ lỗi và sửa lỗi (Debug Toolbar và Debugger)</a>
<a class="list-group-item" href="./guide-tool-gii.html">Sử dụng Gii để tạo code</a>
<a class="list-group-item" href="./guide-tool-api-doc.html">Tạo tài liệu về API </a></div>
<a class="list-group-item" href="#navigation-12144" data-toggle="collapse" data-parent="#navigation">Testing <b class="caret"></b></a><div id="navigation-12144" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-test-overview.html">Tổng quan</a>
<a class="list-group-item" href="./guide-test-environment-setup.html">Thiết lập môi trường</a>
<a class="list-group-item" href="./guide-test-unit.html">Unit Tests</a>
<a class="list-group-item" href="./guide-test-functional.html">Kiểm tra chức năng (Functional Tests)</a>
<a class="list-group-item" href="./guide-test-acceptance.html">Acceptance Tests</a>
<a class="list-group-item" href="./guide-test-fixtures.html">Fixtures</a></div>
<a class="list-group-item" href="#navigation-12145" data-toggle="collapse" data-parent="#navigation">Chủ đề năng cao <b class="caret"></b></a><div id="navigation-12145" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-tutorial-advanced-app.html">Advanced Application Template</a>
<a class="list-group-item" href="./guide-tutorial-start-from-scratch.html">Building Application from Scratch</a>
<a class="list-group-item" href="./guide-tutorial-console.html">Giao diện dòng lệnh (Console Commands)</a>
<a class="list-group-item" href="./guide-tutorial-core-validators.html">Core Validators</a>
<a class="list-group-item" href="./guide-tutorial-i18n.html">Quốc tế hóa (Internationalization)</a>
<a class="list-group-item" href="./guide-tutorial-mailing.html">Thư (Mailing)</a>
<a class="list-group-item" href="./guide-tutorial-performance-tuning.html">Tối ưu hiệu năng ứng dụng (Performance Tuning)</a>
<a class="list-group-item" href="./guide-tutorial-shared-hosting.html">Shared Hosting Environment</a>
<a class="list-group-item" href="./guide-tutorial-template-engines.html">Template Engines</a>
<a class="list-group-item" href="./guide-tutorial-yii-integration.html">Working with Third-Party Code</a></div>
<a class="list-group-item" href="#navigation-12146" data-toggle="collapse" data-parent="#navigation">Widgets <b class="caret"></b></a><div id="navigation-12146" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-widget-bootstrap.html">Bootstrap Widgets</a>
<a class="list-group-item" href="./guide-widget-jui.html">jQuery UI Widgets</a></div>
<a class="list-group-item" href="#navigation-12147" data-toggle="collapse" data-parent="#navigation">Helpers <b class="caret"></b></a><div id="navigation-12147" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-helper-overview.html">Tổng quan</a>
<a class="list-group-item" href="./guide-helper-array.html">ArrayHelper</a>
<a class="list-group-item" href="./guide-helper-html.html">Html</a>
<a class="list-group-item" href="./guide-helper-url.html">Url</a></div></div>    </div>
    <div class="col-md-9 guide-content" role="main">
        <h1>権限付与 <span id="quan-xian-fu-yu"></span><a href="#quan-xian-fu-yu" class="hashlink">&para;</a></h1>
<div class="toc"><ol><li><a href="#akusesu-zhi-yufiruta-acf">アクセス制御フィルタ (ACF)</a></li>
<li><a href="#rbac">ロールベースアクセス制御 (RBAC)</a></li></ol></div>
<p>権限付与は、ユーザが何かをするのに十分な許可を有しているか否かを確認するプロセスです。
Yii は二つの権限付与の方法を提供しています。すなわち、アクセス制御フィルタ (ACF) と、ロールベースアクセス制御 (RBAC) です。</p>
<h2>アクセス制御フィルタ (ACF) <span id="akusesu-zhi-yufiruta-acf"></span><a href="#akusesu-zhi-yufiruta-acf" class="hashlink">&para;</a></h2><p>アクセス制御フィルタ (ACF) は、<span class="broken-link">yii\filters\AccessControl</span> として実装される単純な権限付与の方法であり、何らかの単純なアクセス制御だけを必要とするアプリケーションで使うのに最も適したものです。
その名前が示すように、ACF は、コントローラまたはモジュールで使用することが出来るアクション <a href="guide-structure-filters.html">フィルタ</a> です。
ACF は、ユーザがアクションの実行をリクエストしたときに、一連の <span class="broken-link">yii\filters\AccessControl::rules</span> をチェックして、現在のユーザがそのアクションにアクセスする許可を持つかどうかを決定します。</p>
<p>下記のコードは、<code>site</code> コントローラで ACF を使う方法を示すものです。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">use</span> <span class="hljs-title">yii</span>\<span class="hljs-title">web</span>\<span class="hljs-title">Controller</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">yii</span>\<span class="hljs-title">filters</span>\<span class="hljs-title">AccessControl</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SiteController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">behaviors</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-keyword">return</span> [
            <span class="hljs-string">'access'</span> =&gt; [
                <span class="hljs-string">'class'</span> =&gt; AccessControl::className(),
                <span class="hljs-string">'only'</span> =&gt; [<span class="hljs-string">'login'</span>, <span class="hljs-string">'logout'</span>, <span class="hljs-string">'signup'</span>],
                <span class="hljs-string">'rules'</span> =&gt; [
                    [
                        <span class="hljs-string">'allow'</span> =&gt; <span class="hljs-keyword">true</span>,
                        <span class="hljs-string">'actions'</span> =&gt; [<span class="hljs-string">'login'</span>, <span class="hljs-string">'signup'</span>],
                        <span class="hljs-string">'roles'</span> =&gt; [<span class="hljs-string">'?'</span>],
                    ],
                    [
                        <span class="hljs-string">'allow'</span> =&gt; <span class="hljs-keyword">true</span>,
                        <span class="hljs-string">'actions'</span> =&gt; [<span class="hljs-string">'logout'</span>],
                        <span class="hljs-string">'roles'</span> =&gt; [<span class="hljs-string">'@'</span>],
                    ],
                ],
            ],
        ];
    }
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>上記のコードにおいて、ACF は <code>site</code> コントローラにビヘイビアとしてアタッチされています。
これがアクションフィルタを使用する典型的な方法です。
<code>only</code> オプションは、ACF が <code>login</code>、<code>logout</code>、<code>signup</code> のアクションにのみ適用されるべきであることを指定しています。
<code>site</code> コントローラの他の全てのアクションには ACF の影響は及びません。
<code>rules</code> オプションは <span class="broken-link">yii\filters\AccessRule</span> を指定するものであり、以下のように読むことが出来ます。</p>
<ul>
<li>全てのゲストユーザ (まだ認証されていないユーザ) に、'login' と 'singup' のアクションにアクセスすることを許可します。
<code>roles</code> オプションに疑問符 <code>?</code> が含まれていますが、これは「ゲスト」を表す特殊なトークンです。</li>
<li>認証されたユーザに、'logout' アクションにアクセスすることを許可します。
<code>@</code> という文字はもう一つの特殊なトークンで、「認証されたユーザ」を表すものです。</li>
</ul>
<p>ACF が権限のチェックを実行するときには、規則を一つずつ上から下へ、適用されるものを見つけるまで調べます。
そして、適用される規則の <code>allow</code> の値が、ユーザが権限を有するか否かを判断するのに使われます。
適用される規則が一つもなかった場合は、ユーザが権限をもたないことを意味し、ACF はアクションの継続を中止します。</p>
<p>ユーザが現在のアクションにアクセスする権限を持っていないと判定した場合は、デフォルトでは、ACF は以下の手段を取ります。</p>
<ul>
<li>ユーザがゲストである場合は、<span class="broken-link">yii\web\User::loginRequired()</span> を呼び出して、ユーザのブラウザをログインページにリダイレクトします。</li>
<li>ユーザが既に認証されている場合は、<span class="broken-link">yii\web\ForbiddenHttpException</span> を投げます。</li>
</ul>
<p>この動作は、次のように、<span class="broken-link">yii\filters\AccessControl::denyCallback</span> プロパティを構成することによって、カスタマイズすることが出来ます。</p>
<pre><code class="hljs php language-php">[
    <span class="hljs-string">'class'</span> =&gt; AccessControl::className(),
    ...
    <span class="hljs-string">'denyCallback'</span> =&gt; <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(<span class="hljs-variable">$rule</span>, <span class="hljs-variable">$action</span>)</span> </span>{
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> \<span class="hljs-keyword">Exception</span>(<span class="hljs-string">'このページにアクセスする権限がありません。'</span>);
    }
]
</code></pre>
<p><span class="broken-link">yii\filters\AccessRule</span> は多くのオプションをサポートしています。
以下はサポートされているオプションの要約です。
<span class="broken-link">yii\filters\AccessRule</span> を拡張して、あなた自身のカスタマイズしたアクセス規則のクラスを作ることも出来ます。</p>
<ul>
<li></li>
<li><p>これはアクション ID の配列でなければなりません。
比較は大文字と小文字を区別します。
このオプションが空であるか指定されていない場合は、規則が全てのアクションに適用されることを意味します。</p>
</li>
<li><p>これはコントローラ ID の配列でなければなりません。
コントローラがモジュールに属する場合は、モジュール ID をコントローラ ID の前に付けます。
比較は大文字と小文字を区別します。
このオプションが空であるか指定されていない場合は、規則が全てのコントローラに適用されることを意味します。</p>
</li>
<li><p>二つの特別なロールが認識されます。
これらは、<span class="broken-link">yii\web\User::isGuest</span> によって判断されます。</p>
<ul>
<li><code>?</code>: ゲストユーザ (まだ認証されていないユーザ) を意味します。</li>
<li><code>@</code>: 認証されたユーザを意味します。</li>
</ul>
<p>その他のロール名を使うと、<span class="broken-link">yii\web\User::can()</span> の呼び出しが惹起されますが、そのためには、RBAC (次の節で説明します) を有効にする必要があります。
このオプションが空であるか指定されていない場合は、規則が全てのロールに適用されることを意味します。</p>
</li>
<li><p><span class="broken-link">yii\filters\AccessRule::ips</span>: どの <span class="broken-link">yii\web\Request::userIP</span> にこの規則が適用されるかを指定します。
IP アドレスは、最後にワイルドカード <code>*</code> を含むことが出来て、同じプレフィクスを持つ IP アドレスに合致させることが出来ます。
例えば、'192.168.*' は、'192.168.' のセグメントに属する全ての IP アドレスに合致します。
このオプションが空であるか指定されていない場合は、規則が全ての IP アドレスに適用されることを意味します。</p>
</li>
<li><p><span class="broken-link">yii\filters\AccessRule::verbs</span>: どのリクエストメソッド (HTTP 動詞、例えば <code>GET</code> や <code>POST</code>) にこの規則が適用されるかを指定します。
比較は大文字と小文字を区別しません。</p>
</li>
<li><p><span class="broken-link">yii\filters\AccessRule::matchCallback</span>: この規則が適用されるべきか否かを決定するために呼び出されるべき PHP コーラブルを指定します。</p>
</li>
<li><p><span class="broken-link">yii\filters\AccessRule::denyCallback</span>: この規則がアクセスを禁止する場合に呼び出されるべき PHP コーラブルを指定します。</p>
</li>
</ul>
<p>下記は、<code>matchCallback</code> オプションを利用する方法を示す例です。
このオプションによって、任意のアクセス制御ロジックを書くことが可能になります。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">use</span> <span class="hljs-title">yii</span>\<span class="hljs-title">filters</span>\<span class="hljs-title">AccessControl</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SiteController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">behaviors</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-keyword">return</span> [
            <span class="hljs-string">'access'</span> =&gt; [
                <span class="hljs-string">'class'</span> =&gt; AccessControl::className(),
                <span class="hljs-string">'only'</span> =&gt; [<span class="hljs-string">'special-callback'</span>],
                <span class="hljs-string">'rules'</span> =&gt; [
                    [
                        <span class="hljs-string">'actions'</span> =&gt; [<span class="hljs-string">'special-callback'</span>],
                        <span class="hljs-string">'allow'</span> =&gt; <span class="hljs-keyword">true</span>,
                        <span class="hljs-string">'matchCallback'</span> =&gt; <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(<span class="hljs-variable">$rule</span>, <span class="hljs-variable">$action</span>)</span> </span>{
                            <span class="hljs-keyword">return</span> date(<span class="hljs-string">'d-m'</span>) === <span class="hljs-string">'31-10'</span>;
                        }
                    ],
                ],
            ],
        ];
    }

    <span class="hljs-comment">// matchCallback が呼ばれる。このページは毎年10月31日だけアクセス出来ます。</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">actionSpecialCallback</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>-&gt;render(<span class="hljs-string">'happy-halloween'</span>);
    }
}
</code></pre>
<h2>ロールベースアクセス制御 (RBAC)  <span id="rbac"></span><a href="#rbac" class="hashlink">&para;</a></h2><p>ロールベースアクセス制御 (RBAC) は、単純でありながら強力な集中型のアクセス制御を提供します。
RBAC と他のもっと伝統的なアクセス制御スキーマとの比較に関する詳細については、<a href="http://ja.wikipedia.org/wiki/%E3%83%AD%E3%83%BC%E3%83%AB%E3%83%99%E3%83%BC%E3%82%B9%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E5%88%B6%E5%BE%A1">Wiki 記事</a> を参照してください。</p>
<p>Yii は、<a href="http://csrc.nist.gov/rbac/sandhu-ferraiolo-kuhn-00.pdf">NIST RBAC モデル</a> に従って、一般的階層型 RBAC を実装しています。
RBAC の機能は、<span class="broken-link">yii\rbac\ManagerInterface</span> <a href="guide-structure-application-components.html">アプリケーションコンポーネント</a> を通じて提供されます。</p>
<p>RBAC を使用することには、二つの作業が含まれます。
最初の作業は、RBAC 権限付与データを作り上げることであり、第二の作業は、権限付与データを使って必要とされる場所でアクセスチェックを実行することです。</p>
<p>説明を容易にするために、まず、いくつかの基本的な RBAC の概念を導入します。</p>
<h3>基本的な概念  <span id="basic-concepts"></span><a href="#basic-concepts" class="hashlink">&para;</a></h3><p>ロール (役割) は、<em>許可</em> (例えば、記事を作成する、記事を更新するなど) のコレクションです。
一つのロールを一人または複数のユーザに割り当てることが出来ます。
ユーザが特定の許可を有しているか否かをチェックするためには、その許可を含むロールがユーザに割り当てられているか否かをチェックすればよいのです。</p>
<p>各ロールまたは許可に関連付けられた <em>規則</em> が存在し得ます。
規則とは、アクセスチェックの際に、対応するロールや許可が現在のユーザに適用されるか否かを決定するために実行されるコード断片のことです。
例えば、「記事更新」の許可は、現在のユーザが記事の作成者であるかどうかをチェックする規則を持つことが出来ます。
そして、アクセスチェックのときに、ユーザが記事の作成者でない場合は、彼/彼女は「記事更新」の許可を持っていないと見なすことが出来ます。</p>
<p>ロールおよび許可は、ともに、階層的に構成することが出来ます。
具体的に言えば、一つのロールは他のロールと許可を含むことが出来、許可は他の許可を含むことが出来ます。
Yii は、一般的な <em>半順序</em> 階層を実装していますが、これはその特殊形として <em>木</em> 階層を含むものです。
ロールは許可を含むことが出来ますが、許可はロールを含むことが出来ません。</p>
<h3>RBAC を構成する  <span id="configuring-rbac"></span><a href="#configuring-rbac" class="hashlink">&para;</a></h3><p>権限付与データを定義してアクセスチェックを実行する前に、<span class="broken-link">yii\base\Application::authManager</span> アプリケーションコンポーネントを構成する必要があります。
Yii は二種類の権限付与マネージャを提供しています。すなわち、<span class="broken-link">yii\rbac\PhpManager</span> と <span class="broken-link">yii\rbac\DbManager</span> です。
前者は権限付与データを保存するのに PHP スクリプトファイルを使いますが、後者は権限付与データをデータベースに保存します。
あなたのアプリケーションが非常に動的なロールと許可の管理を必要とするのでなければ、前者を使うことを考慮するのが良いでしょう。</p>
<h4><code>PhpManager</code> を使用する  <span id="using-php-manager"></span><a href="#using-php-manager" class="hashlink">&para;</a></h4><p>次のコードは、アプリケーションの構成情報で <span class="broken-link">yii\rbac\PhpManager</span> クラスを使って <code>authManager</code> を構成する方法を示すものです。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">return</span> [
    <span class="hljs-comment">// ...</span>
    <span class="hljs-string">'components'</span> =&gt; [
        <span class="hljs-string">'authManager'</span> =&gt; [
            <span class="hljs-string">'class'</span> =&gt; <span class="hljs-string">'yii\rbac\PhpManager'</span>,
        ],
        <span class="hljs-comment">// ...</span>
    ],
];
</code></pre>
<p>これで <code>authManager</code> は <code>\Yii::$app-&gt;authManager</code> によってアクセスすることが出来るようになります。</p>
<p>デフォルトでは、<span class="broken-link">yii\rbac\PhpManager</span> は RBAC データを <code>@app/rbac/</code> ディレクトリの下のファイルに保存します。
権限の階層をオンラインで変更する必要がある場合は、必ず、ウェブサーバのプロセスがこのディレクトリとその中の全てのファイルに対する書き込み権限を有するようにしてください。</p>
<h4><code>DbManager</code> を使用する  <span id="using-db-manager"></span><a href="#using-db-manager" class="hashlink">&para;</a></h4><p>次のコードは、アプリケーションの構成情報で <span class="broken-link">yii\rbac\DbManager</span> クラスを使って <code>authManager</code> を構成する方法を示すものです。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">return</span> [
    <span class="hljs-comment">// ...</span>
    <span class="hljs-string">'components'</span> =&gt; [
        <span class="hljs-string">'authManager'</span> =&gt; [
            <span class="hljs-string">'class'</span> =&gt; <span class="hljs-string">'yii\rbac\DbManager'</span>,
        ],
        <span class="hljs-comment">// ...</span>
    ],
];
</code></pre>
<blockquote class="note"><p><strong>Note: </strong>yii2-basic-app テンプレートを使おうとする場合は、<code>config/web.php</code> に加えて、<code>config/console.php</code> 構成ファイルにおいても <code>uathManager</code> を宣言する必要があります。
yii2-advanced-app の場合は、<code>authManager</code> は <code>common/config/main.php</code> で一度だけ宣言されなければなりません。</p>
</blockquote>
<p><code>DbManager</code> は四つのデータベーステーブルを使ってデータを保存します。</p>
<ul>
<li><span class="broken-link">yii\rbac\DbManager::$itemTable</span>: 権限アイテムを保存するためのテーブル。デフォルトは "auth_item"。</li>
<li><span class="broken-link">yii\rbac\DbManager::$itemChildTable</span>: 権限アイテムの階層を保存するためのテーブル。デフォルトは "auth_item_child"。</li>
<li><span class="broken-link">yii\rbac\DbManager::$assignmentTable</span>: 権限アイテムの割り当てを保存するためのテーブル。デフォルトは "auth_assignment"。</li>
<li><span class="broken-link">yii\rbac\DbManager::$ruleTable</span>: 規則を保存するためのテーブル。デフォルトは "auth_rule"。</li>
</ul>
<p>先に進む前にこれらのテーブルをデータベースに作成する必要があります。
そのためには、<code>@yii/rbac/migrations</code> に保存されているマイグレーションを使うことが出来ます。</p>
<p><code>yii migrate --migrationPath=@yii/rbac/migrations</code></p>
<p>これで <code>authManager</code> は <code>\Yii::$app-&gt;authManager</code> によってアクセスすることが出来るようになります。</p>
<h3>権限付与データを構築する  <span id="generating-rbac-data"></span><a href="#generating-rbac-data" class="hashlink">&para;</a></h3><p>権限付与データを構築する作業は、つまるところ、以下のタスクに他なりません。</p>
<ul>
<li>ロールと許可を定義する</li>
<li>ロールと許可の関係を定義する</li>
<li>規則を定義する</li>
<li>規則をロールと許可に結び付ける</li>
<li>ロールをユーザに割り当てる</li>
</ul>
<p>権限付与に要求される柔軟性の程度によって、上記のタスクのやりかたも異なってきます。</p>
<p>権限の階層が全く変化せず、決った数のユーザしか存在しない場合は、<code>authManager</code> が提供する API によって権限付与データを一回だけ初期設定する <a href="guide-tutorial-console.html#create-command">コンソールコマンド</a> を作ることが出来ます。</p>
<pre><code class="hljs php language-php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">app</span>\<span class="hljs-title">commands</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Yii</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">yii</span>\<span class="hljs-title">console</span>\<span class="hljs-title">Controller</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RbacController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">actionInit</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-variable">$auth</span> = Yii::<span class="hljs-variable">$app</span>-&gt;authManager;

        <span class="hljs-comment">// "createPost" という許可を追加</span>
        <span class="hljs-variable">$createPost</span> = <span class="hljs-variable">$auth</span>-&gt;createPermission(<span class="hljs-string">'createPost'</span>);
        <span class="hljs-variable">$createPost</span>-&gt;description = <span class="hljs-string">'記事を投稿'</span>;
        <span class="hljs-variable">$auth</span>-&gt;add(<span class="hljs-variable">$createPost</span>);

        <span class="hljs-comment">// "updatePost" という許可を追加</span>
        <span class="hljs-variable">$updatePost</span> = <span class="hljs-variable">$auth</span>-&gt;createPermission(<span class="hljs-string">'updatePost'</span>);
        <span class="hljs-variable">$updatePost</span>-&gt;description = <span class="hljs-string">'記事を更新'</span>;
        <span class="hljs-variable">$auth</span>-&gt;add(<span class="hljs-variable">$updatePost</span>);

        <span class="hljs-comment">// "author" というロールを追加し、このロールに "createPost" 許可を与える</span>
        <span class="hljs-variable">$author</span> = <span class="hljs-variable">$auth</span>-&gt;createRole(<span class="hljs-string">'author'</span>);
        <span class="hljs-variable">$auth</span>-&gt;add(<span class="hljs-variable">$author</span>);
        <span class="hljs-variable">$auth</span>-&gt;addChild(<span class="hljs-variable">$author</span>, <span class="hljs-variable">$createPost</span>);

        <span class="hljs-comment">// "admin" というロールを追加し、このロールに "updatePost" 許可を与える</span>
        <span class="hljs-comment">// 同時に、"author" ロールの持つ許可も与える</span>
        <span class="hljs-variable">$admin</span> = <span class="hljs-variable">$auth</span>-&gt;createRole(<span class="hljs-string">'admin'</span>);
        <span class="hljs-variable">$auth</span>-&gt;add(<span class="hljs-variable">$admin</span>);
        <span class="hljs-variable">$auth</span>-&gt;addChild(<span class="hljs-variable">$admin</span>, <span class="hljs-variable">$updatePost</span>);
        <span class="hljs-variable">$auth</span>-&gt;addChild(<span class="hljs-variable">$admin</span>, <span class="hljs-variable">$author</span>);

        <span class="hljs-comment">// ロールをユーザに割り当てる。1 と 2 は IdentityInterface::getId() によって返される ID</span>
        <span class="hljs-comment">// IdentityInterface::getId() は、通常は User モデルの中で実装される</span>
        <span class="hljs-variable">$auth</span>-&gt;assign(<span class="hljs-variable">$author</span>, <span class="hljs-number">2</span>);
        <span class="hljs-variable">$auth</span>-&gt;assign(<span class="hljs-variable">$admin</span>, <span class="hljs-number">1</span>);
    }
}
</code></pre>
<blockquote class="note"><p><strong>Note: </strong>アドバンストテンプレートを使おうとするときは、<code>RbacController</code> を <code>console/controllers</code>
ディレクトリの中に置いて、名前空間を <code>console\controllers</code> に変更する必要があります。</p>
</blockquote>
<p><code>yii rbac/init</code> によってコマンドを実行した後には、次の権限階層が得られます。</p>
<p><img src="images/rbac-hierarchy-1.png" alt="単純な RBAC 階層" title="単純な RBAC 階層" /></p>
<p>投稿者 (author) は記事を投稿することが出来、管理者 (admin) は記事を更新することに加えて投稿者が出来る全てのことが出来ます。</p>
<p>あなたのアプリケーションがユーザ自身によるユーザ登録を許している場合は、新しく登録されたユーザに一度はロールを割り当てる必要があります。
例えば、アドバンストプロジェクトテンプレートにおいては、登録したユーザの全てを「投稿者」にするために、<code>frontend\models\SignupForm::signup()</code> を次のように修正しなければなりません。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">signup</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$this</span>-&gt;validate()) {
        <span class="hljs-variable">$user</span> = <span class="hljs-keyword">new</span> User();
        <span class="hljs-variable">$user</span>-&gt;username = <span class="hljs-variable">$this</span>-&gt;username;
        <span class="hljs-variable">$user</span>-&gt;email = <span class="hljs-variable">$this</span>-&gt;email;
        <span class="hljs-variable">$user</span>-&gt;setPassword(<span class="hljs-variable">$this</span>-&gt;password);
        <span class="hljs-variable">$user</span>-&gt;generateAuthKey();
        <span class="hljs-variable">$user</span>-&gt;save(<span class="hljs-keyword">false</span>);

        <span class="hljs-comment">// 次の三行が追加されたものです</span>
        <span class="hljs-variable">$auth</span> = Yii::<span class="hljs-variable">$app</span>-&gt;authManager;
        <span class="hljs-variable">$authorRole</span> = <span class="hljs-variable">$auth</span>-&gt;getRole(<span class="hljs-string">'author'</span>);
        <span class="hljs-variable">$auth</span>-&gt;assign(<span class="hljs-variable">$authorRole</span>, <span class="hljs-variable">$user</span>-&gt;getId());

        <span class="hljs-keyword">return</span> <span class="hljs-variable">$user</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
}
</code></pre>
<p>動的に更新される権限付与データを持つ複雑なアクセス制御を必要とするアプリケーションについては、<code>authManager</code> が提供する API を使って、特別なユーザインタフェイス (つまり、管理パネル) を開発する必要があるでしょう。</p>
<h3>規則を使う  <span id="using-rules"></span><a href="#using-rules" class="hashlink">&para;</a></h3><p>既に述べたように、規則がロールと許可に制約を追加します。
規則は <span class="broken-link">yii\rbac\Rule</span> を拡張したクラスであり、<span class="broken-link">yii\rbac\Rule::execute()</span> メソッドを実装しなければなりません。
前に作った権限階層においては、投稿者は自分自身の記事を編集することが出来ませんでした。これを修正しましょう。
最初に、ユーザが記事の投稿者であることを確認する規則が必要です。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">namespace</span> <span class="hljs-title">app</span>\<span class="hljs-title">rbac</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">yii</span>\<span class="hljs-title">rbac</span>\<span class="hljs-title">Rule</span>;

<span class="hljs-comment">/**
 * authorID がパラメータで渡されたユーザと一致するかチェックする
 */</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthorRule</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Rule</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span> = <span class="hljs-string">'isAuthor'</span>;

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@param</span> string|int $user ユーザ ID
     * <span class="hljs-doctag">@param</span> Item $item この規則が関連付けられているロールまたは許可
     * <span class="hljs-doctag">@param</span> array $params ManagerInterface::checkAccess() に渡されたパラメータ
     * <span class="hljs-doctag">@return</span> bool 関連付けられたロールまたは許可を認めるか否かを示す値
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execute</span><span class="hljs-params">(<span class="hljs-variable">$user</span>, <span class="hljs-variable">$item</span>, <span class="hljs-variable">$params</span>)</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$params</span>[<span class="hljs-string">'post'</span>]) ? <span class="hljs-variable">$params</span>[<span class="hljs-string">'post'</span>]-&gt;createdBy == <span class="hljs-variable">$user</span> : <span class="hljs-keyword">false</span>;
    }
}
</code></pre>
<p>上の規則は、<code>post</code> が <code>$user</code> によって作成されたかどうかをチェックします。
次に、前に使ったコマンドの中で、<code>updateOwnPost</code> という特別な許可を作成します。</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$auth</span> = Yii::<span class="hljs-variable">$app</span>-&gt;authManager;

<span class="hljs-comment">// 規則を追加する</span>
<span class="hljs-variable">$rule</span> = <span class="hljs-keyword">new</span> \app\rbac\AuthorRule;
<span class="hljs-variable">$auth</span>-&gt;add(<span class="hljs-variable">$rule</span>);

<span class="hljs-comment">// "updateOwnPost" という許可を作成し、それに規則を関連付ける</span>
<span class="hljs-variable">$updateOwnPost</span> = <span class="hljs-variable">$auth</span>-&gt;createPermission(<span class="hljs-string">'updateOwnPost'</span>);
<span class="hljs-variable">$updateOwnPost</span>-&gt;description = <span class="hljs-string">'自分の記事を更新'</span>;
<span class="hljs-variable">$updateOwnPost</span>-&gt;ruleName = <span class="hljs-variable">$rule</span>-&gt;name;
<span class="hljs-variable">$auth</span>-&gt;add(<span class="hljs-variable">$updateOwnPost</span>);

<span class="hljs-comment">// "updateOwnPost" は "updatePost" から使われる</span>
<span class="hljs-variable">$auth</span>-&gt;addChild(<span class="hljs-variable">$updateOwnPost</span>, <span class="hljs-variable">$updatePost</span>);

<span class="hljs-comment">// "author" に自分の記事を更新することを許可する</span>
<span class="hljs-variable">$auth</span>-&gt;addChild(<span class="hljs-variable">$author</span>, <span class="hljs-variable">$updateOwnPost</span>);
</code></pre>
<p>これで、次のような権限階層になります。</p>
<p><img src="images/rbac-hierarchy-2.png" alt="規則を持つ RBAC 階層" title="規則を持つ RBAC 階層" /></p>
<h3>アクセスチェック  <span id="access-check"></span><a href="#access-check" class="hashlink">&para;</a></h3><p>権限付与データが準備できてしまえば、アクセスチェックは <span class="broken-link">yii\rbac\ManagerInterface::checkAccess()</span> メソッドを呼ぶだけの簡単な仕事です。
たいていのアクセスチェックは現在のユーザに関するものですから、Yii は、便利なように、<span class="broken-link">yii\web\User::can()</span> というショートカットメソッドを提供しています。
これは、次のようにして使うことが出来ます。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">if</span> (\Yii::<span class="hljs-variable">$app</span>-&gt;user-&gt;can(<span class="hljs-string">'createPost'</span>)) {
    <span class="hljs-comment">// 記事を作成する</span>
}
</code></pre>
<p>現在のユーザが <code>ID=1</code> である Jane であるとすると、<code>createPost</code> からスタートして <code>Jane</code> まで到達しようと試みます。</p>
<p><img src="images/rbac-access-check-1.png" alt="アクセスチェック" title="アクセスチェック" /></p>
<p>ユーザが記事を更新することが出来るかどうかをチェックするためには、前に説明した <code>AuthorRule</code> によって要求される追加のパラメータを渡す必要があります。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">if</span> (\Yii::<span class="hljs-variable">$app</span>-&gt;user-&gt;can(<span class="hljs-string">'updatePost'</span>, [<span class="hljs-string">'post'</span> =&gt; <span class="hljs-variable">$post</span>])) {
    <span class="hljs-comment">// 記事を更新する</span>
}
</code></pre>
<p>現在のユーザが John であるとすると、次の経路をたどります。</p>
<p><img src="images/rbac-access-check-2.png" alt="アクセスチェック" title="アクセスチェック" /></p>
<p><code>updatePost</code> からスタートして、<code>updateOwnPost</code> を通過します。
通過するためには、<code>AuthorRule</code> が <code>execute</code> メソッドで <code>true</code> を返さなければなりません。
<code>execute</code> メソッドは <code>can</code> メソッドの呼び出しから <code>$params</code> を受け取りますので、その値は <code>['post' =&gt; $post]</code> です。
すべて OK であれば、John に割り当てられている <code>author</code> に到達します。</p>
<p>Jane の場合は、彼女が管理者であるため、少し簡単になります。</p>
<p><img src="images/rbac-access-check-3.png" alt="アクセスチェック" title="アクセスチェック" /></p>
<p>コントローラ内で権限付与を実装するのには、いくつかの方法があります。
追加と削除に対するアクセス権を分離する細分化された許可が必要な場合は、それぞれのアクションに対してアクセス権をチェックする必要があります。
各アクションメソッドの中で上記の条件を使用するか、または <span class="broken-link">yii\filters\AccessControl</span> を使います。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">behaviors</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> [
        <span class="hljs-string">'access'</span> =&gt; [
            <span class="hljs-string">'class'</span> =&gt; AccessControl::className(),
            <span class="hljs-string">'rules'</span> =&gt; [
                [
                    <span class="hljs-string">'allow'</span> =&gt; <span class="hljs-keyword">true</span>,
                    <span class="hljs-string">'actions'</span> =&gt; [<span class="hljs-string">'index'</span>],
                    <span class="hljs-string">'roles'</span> =&gt; [<span class="hljs-string">'managePost'</span>],
                ],
                [
                    <span class="hljs-string">'allow'</span> =&gt; <span class="hljs-keyword">true</span>,
                    <span class="hljs-string">'actions'</span> =&gt; [<span class="hljs-string">'view'</span>],
                    <span class="hljs-string">'roles'</span> =&gt; [<span class="hljs-string">'viewPost'</span>],
                ],
                [
                    <span class="hljs-string">'allow'</span> =&gt; <span class="hljs-keyword">true</span>,
                    <span class="hljs-string">'actions'</span> =&gt; [<span class="hljs-string">'create'</span>],
                    <span class="hljs-string">'roles'</span> =&gt; [<span class="hljs-string">'createPost'</span>],
                ],
                [
                    <span class="hljs-string">'allow'</span> =&gt; <span class="hljs-keyword">true</span>,
                    <span class="hljs-string">'actions'</span> =&gt; [<span class="hljs-string">'update'</span>],
                    <span class="hljs-string">'roles'</span> =&gt; [<span class="hljs-string">'updatePost'</span>],
                ],
                [
                    <span class="hljs-string">'allow'</span> =&gt; <span class="hljs-keyword">true</span>,
                    <span class="hljs-string">'actions'</span> =&gt; [<span class="hljs-string">'delete'</span>],
                    <span class="hljs-string">'roles'</span> =&gt; [<span class="hljs-string">'deletePost'</span>],
                ],
            ],
        ],
    ];
}
</code></pre>
<p>全ての CRUD 操作がまとめて管理される場合は、<code>managePost</code> のような単一の許可を使い、
<span class="broken-link">yii\web\Controller::beforeAction()</span> の中でそれをチェックするのが良いアイデアです。</p>
<h3>デフォルトロールを使う  <span id="using-default-roles"></span><a href="#using-default-roles" class="hashlink">&para;</a></h3><p>デフォルトロールというのは、<em>全て</em> のユーザに <em>黙示的</em> に割り当てられるロールです。
<span class="broken-link">yii\rbac\ManagerInterface::assign()</span> を呼び出す必要はなく、権限付与データはその割り当て情報を含みません。</p>
<p>デフォルトロールは、通常、そのロールが当該ユーザに適用されるかどうかを決定する規則と関連付けられます。</p>
<p>デフォルトロールは、たいていは、何らかのロールの割り当てを既に持っているアプリケーションにおいて使われます。
例えば、アプリケーションによっては、ユーザのテーブルに "group" というカラムを持って、個々のユーザが属する特権グループを表している場合があります。
それぞれの特権グループを RBAC ロールに対応付けることが出来るのであれば、デフォルトロールの機能を使って、それぞれのユーザに RBAC ロールを自動的に割り当てることが出来ます。
どのようにすればこれが出来るのか、例を使って説明しましょう。</p>
<p>ユーザのテーブルに <code>group</code> というカラムがあって、1 は管理者グループ、2 は投稿者グループを示していると仮定しましょう。
これら二つのグループの権限を表すために、それぞれ、<code>admin</code> と <code>author</code> という RBAC ロールを作ることにします。
このとき、次のように RBAC データをセットアップすることが出来ます。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">namespace</span> <span class="hljs-title">app</span>\<span class="hljs-title">rbac</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Yii</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">yii</span>\<span class="hljs-title">rbac</span>\<span class="hljs-title">Rule</span>;

<span class="hljs-comment">/**
 * ユーザのグループが合致するかどうかをチェックする
 */</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserGroupRule</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Rule</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span> = <span class="hljs-string">'userGroup'</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execute</span><span class="hljs-params">(<span class="hljs-variable">$user</span>, <span class="hljs-variable">$item</span>, <span class="hljs-variable">$params</span>)</span>
    </span>{
        <span class="hljs-keyword">if</span> (!Yii::<span class="hljs-variable">$app</span>-&gt;user-&gt;isGuest) {
            <span class="hljs-variable">$group</span> = Yii::<span class="hljs-variable">$app</span>-&gt;user-&gt;identity-&gt;group;
            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$item</span>-&gt;name === <span class="hljs-string">'admin'</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-variable">$group</span> == <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">elseif</span> (<span class="hljs-variable">$item</span>-&gt;name === <span class="hljs-string">'author'</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-variable">$group</span> == <span class="hljs-number">1</span> || <span class="hljs-variable">$group</span> == <span class="hljs-number">2</span>;
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
    }
}

<span class="hljs-variable">$auth</span> = Yii::<span class="hljs-variable">$app</span>-&gt;authManager;

<span class="hljs-variable">$rule</span> = <span class="hljs-keyword">new</span> \app\rbac\UserGroupRule;
<span class="hljs-variable">$auth</span>-&gt;add(<span class="hljs-variable">$rule</span>);

<span class="hljs-variable">$author</span> = <span class="hljs-variable">$auth</span>-&gt;createRole(<span class="hljs-string">'author'</span>);
<span class="hljs-variable">$author</span>-&gt;ruleName = <span class="hljs-variable">$rule</span>-&gt;name;
<span class="hljs-variable">$auth</span>-&gt;add(<span class="hljs-variable">$author</span>);
<span class="hljs-comment">// ... $author の子として許可を追加 ...</span>

<span class="hljs-variable">$admin</span> = <span class="hljs-variable">$auth</span>-&gt;createRole(<span class="hljs-string">'admin'</span>);
<span class="hljs-variable">$admin</span>-&gt;ruleName = <span class="hljs-variable">$rule</span>-&gt;name;
<span class="hljs-variable">$auth</span>-&gt;add(<span class="hljs-variable">$admin</span>);
<span class="hljs-variable">$auth</span>-&gt;addChild(<span class="hljs-variable">$admin</span>, <span class="hljs-variable">$author</span>);
<span class="hljs-comment">// ... $admin の子として許可を追加 ...</span>
</code></pre>
<p>上記において、"author" が "admin" の子として追加されているため、規則クラスの <code>execute()</code> メソッドを実装する時には、この階層関係にも配慮しなければならないことに注意してください。
このために、ロール名が "author" である場合には、<code>execute()</code> メソッドは、ユーザのグループが 1 または 2 である (ユーザが "admin" グループまたは "author" グループに属している) ときに true を返しています。</p>
<p>次に、<code>authManager</code> の構成情報で、この二つのロールを <span class="broken-link">yii\rbac\BaseManager::$defaultRoles</span> としてリストします。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">return</span> [
    <span class="hljs-comment">// ...</span>
    <span class="hljs-string">'components'</span> =&gt; [
        <span class="hljs-string">'authManager'</span> =&gt; [
            <span class="hljs-string">'class'</span> =&gt; <span class="hljs-string">'yii\rbac\PhpManager'</span>,
            <span class="hljs-string">'defaultRoles'</span> =&gt; [<span class="hljs-string">'admin'</span>, <span class="hljs-string">'author'</span>],
        ],
        <span class="hljs-comment">// ...</span>
    ],
];
</code></pre>
<p>このようにすると、アクセスチェックを実行すると、<code>admin</code> と <code>author</code> の両方のロールは、それらと関連付けられた規則を評価することによってチェックされるようになります。
規則が true を返せば、そのロールが現在のユーザに適用されることになります。
上述の規則の実装に基づいて言えば、ユーザの <code>group</code> の値が 1 であれば <code>admin</code> ロールがユーザに適用され、<code>group</code> の値が 2 であれば <code>author</code> ロールが適用されるということを意味します。</p>
        <div class="toplink"><a href="#" class="h1" title="go to top"><span class="glyphicon glyphicon-arrow-up"></a></div>
    </div>
</div>


</div>

<footer class="footer">
        <p class="pull-right"><small>Page generated on Tue, 27 Dec 2016 22:28:43 +0000</small></p>
    Powered by <a href="http://www.yiiframework.com/" rel="external">Yii Framework</a></footer>

<script type="text/javascript">jQuery(document).ready(function () {
    var shiftWindow = function () { scrollBy(0, -50) };
    if (location.hash) setTimeout(shiftWindow, 1);
    window.addEventListener("hashchange", shiftWindow);
var element = document.createElement("script");
element.src = "./jssearch.index.js";
document.body.appendChild(element);

var searchBox = $('#searchbox');

// search when typing in search field
searchBox.on("keyup", function(event) {
    var query = $(this).val();

    if (query == '' || event.which == 27) {
        $('#search-resultbox').hide();
        return;
    } else if (event.which == 13) {
        var selectedLink = $('#search-resultbox a.selected');
        if (selectedLink.length != 0) {
            document.location = selectedLink.attr('href');
            return;
        }
    } else if (event.which == 38 || event.which == 40) {
        $('#search-resultbox').show();

        var selected = $('#search-resultbox a.selected');
        if (selected.length == 0) {
            $('#search-results').find('a').first().addClass('selected');
        } else {
            var next;
            if (event.which == 40) {
                next = selected.parent().next().find('a').first();
            } else {
                next = selected.parent().prev().find('a').first();
            }
            if (next.length != 0) {
                var resultbox = $('#search-results');
                var position = next.position();

//              TODO scrolling is buggy and jumps around
//                resultbox.scrollTop(Math.floor(position.top));
//                console.log(position.top);

                selected.removeClass('selected');
                next.addClass('selected');
            }
        }

        return;
    }
    $('#search-resultbox').show();
    $('#search-results').html('<li><span class="no-results">No results</span></li>');

    var result = jssearch.search(query);

    if (result.length > 0) {
        var i = 0;
        var resHtml = '';

        for (var key in result) {
            if (i++ > 20) {
                break;
            }
            resHtml = resHtml +
            '<li><a href="' + result[key].file.u.substr(3) +'"><span class="title">' + result[key].file.t + '</span>' +
            '<span class="description">' + result[key].file.d + '</span></a></li>';
        }
        $('#search-results').html(resHtml);
    }
});

// hide the search results on ESC
$(document).on("keyup", function(event) { if (event.which == 27) { $('#search-resultbox').hide(); } });
// hide search results on click to document
$(document).bind('click', function (e) { $('#search-resultbox').hide(); });
// except the following:
searchBox.bind('click', function(e) { e.stopPropagation(); });
$('#search-resultbox').bind('click', function(e) { e.stopPropagation(); });

});</script></body>
</html>
