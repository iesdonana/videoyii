<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="language" content="en" />
        <link href="./assets/90d046f2/css/bootstrap.css" rel="stylesheet">
<link href="./assets/c6368d94/solarized_light.css" rel="stylesheet">
<link href="./assets/9f5cdd92/style.css" rel="stylesheet">
<script src="./assets/a6e53573/jquery.js"></script>
<script src="./assets/90d046f2/js/bootstrap.js"></script>
<script src="./assets/218ce2e5/jssearch.js"></script>    <title>Data Access Objects - Làm việc với Databases - The Definitive Guide to Yii 2.0</title>
</head>
<body>

<div class="wrap">
    <nav id="w11482" class="navbar-inverse navbar-fixed-top navbar" role="navigation"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#w11482-collapse"><span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span></button><a class="navbar-brand" href="./guide-index.html">The Definitive Guide to Yii 2.0</a></div><div id="w11482-collapse" class="collapse navbar-collapse"><ul id="w11483" class="navbar-nav nav"><li><a href="./guide-README.html">Guide</a></li></ul><div class="navbar-form navbar-left" role="search">
  <div class="form-group">
    <input id="searchbox" type="text" class="form-control" placeholder="Search">
  </div>
</div>
</div></nav>
    <div id="search-resultbox" style="display: none;" class="modal-content">
        <ul id="search-results">
        </ul>
    </div>

    
<div class="row">
    <div class="col-md-2">
                <div id="navigation" class="list-group"><a class="list-group-item" href="#navigation-11466" data-toggle="collapse" data-parent="#navigation">Giới thiệu <b class="caret"></b></a><div id="navigation-11466" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-intro-yii.html">Về Yii</a>
<a class="list-group-item" href="./guide-intro-upgrade-from-v1.html">Nâng cấp lên từ phiên bản 1.1</a></div>
<a class="list-group-item" href="#navigation-11467" data-toggle="collapse" data-parent="#navigation">Bắt đầu <b class="caret"></b></a><div id="navigation-11467" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-start-installation.html">Cài đặt Yii</a>
<a class="list-group-item" href="./guide-start-workflow.html">Thực hiện chạy ứng dụng</a>
<a class="list-group-item" href="./guide-start-hello.html">Viết lời chào đầu tiên</a>
<a class="list-group-item" href="./guide-start-forms.html">Làm việc với Forms</a>
<a class="list-group-item" href="./guide-start-databases.html">Làm việc với Databases</a>
<a class="list-group-item" href="./guide-start-gii.html">Sử dụng Gii để sinh code</a>
<a class="list-group-item" href="./guide-start-looking-ahead.html">Mức cao hơn</a></div>
<a class="list-group-item" href="#navigation-11468" data-toggle="collapse" data-parent="#navigation">Kiến trúc ứng dụng (Application Structure) <b class="caret"></b></a><div id="navigation-11468" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-structure-overview.html">Tổng quan về kiến trúc ứng dụng</a>
<a class="list-group-item" href="./guide-structure-entry-scripts.html">Mục Scripts</a>
<a class="list-group-item" href="./guide-structure-applications.html">Ứng dụng (Applications)</a>
<a class="list-group-item" href="./guide-structure-application-components.html">Thành phần ứng dụng</a>
<a class="list-group-item" href="./guide-structure-controllers.html">Bộ điều khiển (Controllers)</a>
<a class="list-group-item" href="./guide-structure-models.html">Models</a>
<a class="list-group-item" href="./guide-structure-views.html">Views</a>
<a class="list-group-item" href="./guide-structure-modules.html">Modules</a>
<a class="list-group-item" href="./guide-structure-filters.html">Bộ lọc (Filters)</a>
<a class="list-group-item" href="./guide-structure-widgets.html">Widgets</a>
<a class="list-group-item" href="./guide-structure-assets.html">Assets</a>
<a class="list-group-item" href="./guide-structure-extensions.html">Phần mở rộng (Extensions)</a></div>
<a class="list-group-item" href="#navigation-11469" data-toggle="collapse" data-parent="#navigation">Yêu cầu xử lý (Handling Requests) <b class="caret"></b></a><div id="navigation-11469" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-runtime-overview.html">Tổng quan</a>
<a class="list-group-item" href="./guide-runtime-bootstrapping.html">Bootstrapping</a>
<a class="list-group-item" href="./guide-runtime-routing.html">Routing và URL Creation</a>
<a class="list-group-item" href="./guide-runtime-requests.html">Yêu cầu (Requests)</a>
<a class="list-group-item" href="./guide-runtime-responses.html">Responses</a>
<a class="list-group-item" href="./guide-runtime-sessions-cookies.html">Sessions và Cookies</a>
<a class="list-group-item" href="./guide-runtime-handling-errors.html">Xử lý lỗi (Handling Error)</a>
<a class="list-group-item" href="./guide-runtime-logging.html">Logging</a></div>
<a class="list-group-item" href="#navigation-11470" data-toggle="collapse" data-parent="#navigation">Các khái niệm chính <b class="caret"></b></a><div id="navigation-11470" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-concept-components.html">Thành phần (Components)</a>
<a class="list-group-item" href="./guide-concept-properties.html">Thuộc tính (Properties)</a>
<a class="list-group-item" href="./guide-concept-events.html">Sự kiện (Events)</a>
<a class="list-group-item" href="./guide-concept-behaviors.html">Hành vi (Behaviors)</a>
<a class="list-group-item" href="./guide-concept-configurations.html">Cấu hình (Configurations)</a>
<a class="list-group-item" href="./guide-concept-aliases.html">Bí danh (Aliases)</a>
<a class="list-group-item" href="./guide-concept-autoloading.html">Lớp tự động nạp (Autoloading)</a>
<a class="list-group-item" href="./guide-concept-service-locator.html">Service Locator</a>
<a class="list-group-item" href="./guide-concept-di-container.html">Dependency Injection Container</a></div>
<a class="list-group-item active" href="#navigation-11471" data-toggle="collapse" data-parent="#navigation">Làm việc với Databases <b class="caret"></b></a><div id="navigation-11471" class="submenu panel-collapse collapse in"><a class="list-group-item active" href="./guide-db-dao.html">Data Access Objects</a>
<a class="list-group-item" href="./guide-db-query-builder.html">Query Builder</a>
<a class="list-group-item" href="./guide-db-active-record.html">Active Record</a>
<a class="list-group-item" href="./guide-db-migrations.html">Migrations</a>
<a class="list-group-item" href="./guide-db-sphinx.html">Sphinx</a>
<a class="list-group-item" href="./guide-db-redis.html">Redis</a>
<a class="list-group-item" href="./guide-db-mongodb.html">MongoDB</a>
<a class="list-group-item" href="./guide-db-elasticsearch.html">ElasticSearch</a></div>
<a class="list-group-item" href="#navigation-11472" data-toggle="collapse" data-parent="#navigation">Nhận dữ liệu từ user <b class="caret"></b></a><div id="navigation-11472" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-input-forms.html">Tạo mới Forms</a>
<a class="list-group-item" href="./guide-input-validation.html">Kiểm tra dữ liệu đầu vào (Validating Input)</a>
<a class="list-group-item" href="./guide-input-file-upload.html">File Upload</a>
<a class="list-group-item" href="./guide-input-tabular-input.html">Thu thập dữ liệu từ danh sách đầu vào (Đang phát triển)</a>
<a class="list-group-item" href="./guide-input-multiple-models.html">Lấy dữ liệu cho nhiều Models (Chưa giải quyết)</a></div>
<a class="list-group-item" href="#navigation-11473" data-toggle="collapse" data-parent="#navigation">Hiển thị dữ liệu <b class="caret"></b></a><div id="navigation-11473" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-output-formatter.html">Định dạng dữ liệu (Data Formatting)</a>
<a class="list-group-item" href="./guide-output-pagination.html">Phân trang (Pagination)</a>
<a class="list-group-item" href="./guide-output-sorting.html">Sắp xếp (Sorting)</a>
<a class="list-group-item" href="./guide-output-data-providers.html">Cung cấp dữ liệu ra (Data Providers)</a>
<a class="list-group-item" href="./guide-output-data-widgets.html">Dữ liệu Widgets</a>
<a class="list-group-item" href="./guide-output-client-scripts.html">làm việc với Client Scripts</a>
<a class="list-group-item" href="./guide-output-theming.html">Giao diện (Theming)</a></div>
<a class="list-group-item" href="#navigation-11474" data-toggle="collapse" data-parent="#navigation">Bảo mật (Security) <b class="caret"></b></a><div id="navigation-11474" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-security-authentication.html">Xác thực (Authentication)</a>
<a class="list-group-item" href="./guide-security-authorization.html">Quyền (Authorization)</a>
<a class="list-group-item" href="./guide-security-passwords.html">Các thao tác xử lý với Passwords (Đang phát triển)</a>
<a class="list-group-item" href="./guide-security-auth-clients.html">Auth Clients</a>
<a class="list-group-item" href="./guide-security-best-practices.html">Best Practices</a></div>
<a class="list-group-item" href="#navigation-11475" data-toggle="collapse" data-parent="#navigation">Bộ nhớ Cache <b class="caret"></b></a><div id="navigation-11475" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-caching-overview.html">Tổng quan</a>
<a class="list-group-item" href="./guide-caching-data.html">Cache dữ liệu</a>
<a class="list-group-item" href="./guide-caching-fragment.html">Fragment Caching</a>
<a class="list-group-item" href="./guide-caching-page.html">Page Caching</a>
<a class="list-group-item" href="./guide-caching-http.html">HTTP Caching</a></div>
<a class="list-group-item" href="#navigation-11476" data-toggle="collapse" data-parent="#navigation">RESTful Web Services <b class="caret"></b></a><div id="navigation-11476" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-rest-quick-start.html">Bắt đầu</a>
<a class="list-group-item" href="./guide-rest-resources.html">Tài nguyên (Resources)</a>
<a class="list-group-item" href="./guide-rest-controllers.html">Bộ điều khiển (Controllers)</a>
<a class="list-group-item" href="./guide-rest-routing.html">Routing</a>
<a class="list-group-item" href="./guide-rest-response-formatting.html">Định dạng thông điệp gửi đi (Response Formatting)</a>
<a class="list-group-item" href="./guide-rest-authentication.html">Xác thực (Authentication)</a>
<a class="list-group-item" href="./guide-rest-rate-limiting.html">Rate Limiting</a>
<a class="list-group-item" href="./guide-rest-versioning.html">Phiên bản (Version)</a>
<a class="list-group-item" href="./guide-rest-error-handling.html">Error Handling</a></div>
<a class="list-group-item" href="#navigation-11477" data-toggle="collapse" data-parent="#navigation">Công cụ phát triển (Development Tools) <b class="caret"></b></a><div id="navigation-11477" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-tool-debugger.html">Thanh công cụ gỡ lỗi và sửa lỗi (Debug Toolbar và Debugger)</a>
<a class="list-group-item" href="./guide-tool-gii.html">Sử dụng Gii để tạo code</a>
<a class="list-group-item" href="./guide-tool-api-doc.html">Tạo tài liệu về API </a></div>
<a class="list-group-item" href="#navigation-11478" data-toggle="collapse" data-parent="#navigation">Testing <b class="caret"></b></a><div id="navigation-11478" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-test-overview.html">Tổng quan</a>
<a class="list-group-item" href="./guide-test-environment-setup.html">Thiết lập môi trường</a>
<a class="list-group-item" href="./guide-test-unit.html">Unit Tests</a>
<a class="list-group-item" href="./guide-test-functional.html">Kiểm tra chức năng (Functional Tests)</a>
<a class="list-group-item" href="./guide-test-acceptance.html">Acceptance Tests</a>
<a class="list-group-item" href="./guide-test-fixtures.html">Fixtures</a></div>
<a class="list-group-item" href="#navigation-11479" data-toggle="collapse" data-parent="#navigation">Chủ đề năng cao <b class="caret"></b></a><div id="navigation-11479" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-tutorial-advanced-app.html">Advanced Application Template</a>
<a class="list-group-item" href="./guide-tutorial-start-from-scratch.html">Building Application from Scratch</a>
<a class="list-group-item" href="./guide-tutorial-console.html">Giao diện dòng lệnh (Console Commands)</a>
<a class="list-group-item" href="./guide-tutorial-core-validators.html">Core Validators</a>
<a class="list-group-item" href="./guide-tutorial-i18n.html">Quốc tế hóa (Internationalization)</a>
<a class="list-group-item" href="./guide-tutorial-mailing.html">Thư (Mailing)</a>
<a class="list-group-item" href="./guide-tutorial-performance-tuning.html">Tối ưu hiệu năng ứng dụng (Performance Tuning)</a>
<a class="list-group-item" href="./guide-tutorial-shared-hosting.html">Shared Hosting Environment</a>
<a class="list-group-item" href="./guide-tutorial-template-engines.html">Template Engines</a>
<a class="list-group-item" href="./guide-tutorial-yii-integration.html">Working with Third-Party Code</a></div>
<a class="list-group-item" href="#navigation-11480" data-toggle="collapse" data-parent="#navigation">Widgets <b class="caret"></b></a><div id="navigation-11480" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-widget-bootstrap.html">Bootstrap Widgets</a>
<a class="list-group-item" href="./guide-widget-jui.html">jQuery UI Widgets</a></div>
<a class="list-group-item" href="#navigation-11481" data-toggle="collapse" data-parent="#navigation">Helpers <b class="caret"></b></a><div id="navigation-11481" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-helper-overview.html">Tổng quan</a>
<a class="list-group-item" href="./guide-helper-array.html">ArrayHelper</a>
<a class="list-group-item" href="./guide-helper-html.html">Html</a>
<a class="list-group-item" href="./guide-helper-url.html">Url</a></div></div>    </div>
    <div class="col-md-9 guide-content" role="main">
        <h1>データベースアクセスオブジェクト <span id="detabesuakusesuobujekuto"></span><a href="#detabesuakusesuobujekuto" class="hashlink">&para;</a></h1>
<div class="toc"><ol><li><a href="#creating-db-connections">DB 接続を作成する</a></li>
<li><a href="#executing-sql-queries">SQL クエリを実行する</a></li>
<li><a href="#quoting-table-and-column-names">テーブルとカラムの名前を引用符で囲む</a></li>
<li><a href="#performing-transactions">トランザクションを実行する</a></li>
<li><a href="#read-write-splitting">レプリケーションと読み書きの分離</a></li>
<li><a href="#database-schema">データベーススキーマを扱う</a></li></ol></div>
<p><a href="http://www.php.net/manual/ja/book.pdo.php">PDO</a> の上に構築された Yii DAO (データベースアクセスオブジェクト) は、リレーショナルデータベースにアクセスするためのオブジェクト指向 API を提供するものです。
これは、データベースにアクセスする他のもっと高度な方法、例えば <a href="guide-db-query-builder.html">クエリビルダ</a> や <a href="guide-db-active-record.html">アクティブレコード</a> の基礎でもあります。</p>
<p>Yii DAO を使うときは、主として素の SQL と PHP 配列を扱う必要があります。
結果として、Yii DAO はデータベースにアクセスする方法としては最も効率的なものになります。
しかし、SQL の構文はデータベースによってさまざまに異なる場合がありますので、Yii DAO を使用するということは、特定のデータベースに依存しないアプリケーションを作るためには追加の労力が必要になる、ということをも同時に意味します。</p>
<p>Yii は下記の DBMS のサポートを内蔵しています。</p>
<ul>
<li><a href="http://www.mysql.com/">MySQL</a></li>
<li><a href="https://mariadb.com/">MariaDB</a></li>
<li><a href="http://sqlite.org/">SQLite</a></li>
<li><a href="http://www.postgresql.org/">PostgreSQL</a></li>
<li><a href="http://www.cubrid.org/">CUBRID</a>: バージョン 9.3 以上。</li>
<li><a href="http://www.oracle.com/us/products/database/overview/index.html">Oracle</a></li>
<li><a href="https://www.microsoft.com/en-us/sqlserver/default.aspx">MSSQL</a>: バージョン 2008 以上。</li>
</ul>
<h2>DB 接続を作成する  <span id="creating-db-connections"></span><a href="#creating-db-connections" class="hashlink">&para;</a></h2><p>データベースにアクセスするために、まずは、データベースに接続するために <span class="broken-link">yii\db\Connection</span> のインスタンスを作成する必要があります。</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$db</span> = <span class="hljs-keyword">new</span> yii\db\Connection([
    <span class="hljs-string">'dsn'</span> =&gt; <span class="hljs-string">'mysql:host=localhost;dbname=example'</span>,
    <span class="hljs-string">'username'</span> =&gt; <span class="hljs-string">'root'</span>,
    <span class="hljs-string">'password'</span> =&gt; <span class="hljs-string">''</span>,
    <span class="hljs-string">'charset'</span> =&gt; <span class="hljs-string">'utf8'</span>,
]);
</code></pre>
<p>DB 接続は、たいていは、さまざまな場所でアクセスする必要がありますので、次のように、<a href="guide-structure-application-components.html">アプリケーションコンポーネント</a> の形式で構成するのが通例です。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">return</span> [
    <span class="hljs-comment">// ...</span>
    <span class="hljs-string">'components'</span> =&gt; [
        <span class="hljs-comment">// ...</span>
        <span class="hljs-string">'db'</span> =&gt; [
            <span class="hljs-string">'class'</span> =&gt; <span class="hljs-string">'yii\db\Connection'</span>,
            <span class="hljs-string">'dsn'</span> =&gt; <span class="hljs-string">'mysql:host=localhost;dbname=example'</span>,
            <span class="hljs-string">'username'</span> =&gt; <span class="hljs-string">'root'</span>,
            <span class="hljs-string">'password'</span> =&gt; <span class="hljs-string">''</span>,
            <span class="hljs-string">'charset'</span> =&gt; <span class="hljs-string">'utf8'</span>,
        ],
    ],
    <span class="hljs-comment">// ...</span>
];
</code></pre>
<p>こうすると <code>Yii::$app-&gt;db</code> という式で DB 接続にアクセスすることが出来るようになります。</p>
<blockquote class="tip"><p><strong>Tip: </strong>あなたのアプリケーションが複数のデータベースにアクセスする必要がある場合は、複数の DB アプリケーションコンポーネントを構成することが出来ます。</p>
</blockquote>
<p>DB 接続を構成するときは、つねに <span class="broken-link">yii\db\Connection::dsn</span> プロパティによってデータソース名 (DSN) を指定しなければなりません。
DSN の形式はデータベースによってさまざまに異なります。
詳細は <a href="http://www.php.net/manual/ja/function.PDO-construct.php">PHP マニュアル</a> を参照して下さい。
下記にいくつかの例を挙げます。</p>
<ul>
<li>MySQL, MariaDB: <code>mysql:host=localhost;dbname=mydatabase</code></li>
<li>SQLite: <code>sqlite:/path/to/database/file</code></li>
<li>PostgreSQL: <code>pgsql:host=localhost;port=5432;dbname=mydatabase</code></li>
<li>CUBRID: <code>cubrid:dbname=demodb;host=localhost;port=33000</code></li>
<li>MS SQL Server (sqlsrv ドライバ経由): <code>sqlsrv:Server=localhost;Database=mydatabase</code></li>
<li>MS SQL Server (dblib ドライバ経由): <code>dblib:host=localhost;dbname=mydatabase</code></li>
<li>MS SQL Server (mssql ドライバ経由): <code>mssql:host=localhost;dbname=mydatabase</code></li>
<li>Oracle: <code>oci:dbname=//localhost:1521/mydatabase</code></li>
</ul>
<p>ODBC 経由でデータベースに接続しようとする場合は、<span class="broken-link">yii\db\Connection::driverName</span> プロパティを構成して、Yii に実際のデータベースのタイプを知らせなければならないことに注意してください。
例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-string">'db'</span> =&gt; [
    <span class="hljs-string">'class'</span> =&gt; <span class="hljs-string">'yii\db\Connection'</span>,
    <span class="hljs-string">'driverName'</span> =&gt; <span class="hljs-string">'mysql'</span>,
    <span class="hljs-string">'dsn'</span> =&gt; <span class="hljs-string">'odbc:Driver={MySQL};Server=localhost;Database=test'</span>,
    <span class="hljs-string">'username'</span> =&gt; <span class="hljs-string">'root'</span>,
    <span class="hljs-string">'password'</span> =&gt; <span class="hljs-string">''</span>,
],
</code></pre>
<p><span class="broken-link">yii\db\Connection::dsn</span> プロパティに加えて、たいていは <span class="broken-link">yii\db\Connection::username</span> と <span class="broken-link">yii\db\Connection::password</span> も構成しなければなりません。
構成可能なプロパティの全てのリストは <span class="broken-link">yii\db\Connection</span> を参照して下さい。</p>
<blockquote class="info"><p><strong>Info: </strong>DB 接続のインスタンスを作成するとき、実際のデータベース接続は、最初の SQL を実行するか、<span class="broken-link">yii\db\Connection::open()</span> メソッドを明示的に呼ぶかするまでは確立されません。</p>
</blockquote>
<blockquote class="tip"><p><strong>Tip: </strong>時として、何らかの環境変数を初期化するために、データベース接続を確立した直後に何かクエリを実行したい場合があるでしょう (例えば、タイムゾーンや文字セットを設定するなどです)。
そうするために、データベース接続の <span class="broken-link">yii\db\Connection::EVENT_AFTER_OPEN</span> イベントに対するイベントハンドラを登録することが出来ます。
以下のように、アプリケーションの構成情報に直接にハンドラを登録してください。</p>
<pre><code class="hljs php language-php"><span class="hljs-string">'db'</span> =&gt; [
    <span class="hljs-comment">// ...</span>
    <span class="hljs-string">'on afterOpen'</span> =&gt; <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-variable">$event</span>)</span> </span>{
        <span class="hljs-comment">// $event-&gt;sender は DB 接続を指す</span>
        <span class="hljs-variable">$event</span>-&gt;sender-&gt;createCommand(<span class="hljs-string">"SET time_zone = 'UTC'"</span>)-&gt;execute();
    }
]
</code></pre>
</blockquote>
<h2>SQL クエリを実行する  <span id="executing-sql-queries"></span><a href="#executing-sql-queries" class="hashlink">&para;</a></h2><p>いったんデータベース接続のインスタンスを得てしまえば、次の手順に従って SQL クエリを実行することが出来ます。</p>
<ol>
<li>素の SQL クエリで <span class="broken-link">yii\db\Command</span> を作成する。</li>
<li>パラメータをバインドする (オプション)。</li>
<li><span class="broken-link">yii\db\Command</span> の SQL 実行メソッドの一つを呼ぶ。</li>
</ol>
<p>次に、データベースからデータを読み出すさまざまな方法を例示します。</p>
<pre><code class="hljs php language-php"><span class="hljs-comment">// 行のセットを返す。各行は、カラム名と値の連想配列。</span>
<span class="hljs-comment">// クエリが結果を返さなかった場合は空の配列が返される。</span>
<span class="hljs-variable">$posts</span> = Yii::<span class="hljs-variable">$app</span>-&gt;db-&gt;createCommand(<span class="hljs-string">'SELECT * FROM post'</span>)
            -&gt;queryAll();

<span class="hljs-comment">// 一つの行 (最初の行) を返す。</span>
<span class="hljs-comment">// クエリの結果が無かった場合は false が返される。</span>
<span class="hljs-variable">$post</span> = Yii::<span class="hljs-variable">$app</span>-&gt;db-&gt;createCommand(<span class="hljs-string">'SELECT * FROM post WHERE id=1'</span>)
           -&gt;queryOne();

<span class="hljs-comment">// 一つのカラム (最初のカラム) を返す。</span>
<span class="hljs-comment">// クエリが結果を返さなかった場合は空の配列が返される。</span>
<span class="hljs-variable">$titles</span> = Yii::<span class="hljs-variable">$app</span>-&gt;db-&gt;createCommand(<span class="hljs-string">'SELECT title FROM post'</span>)
             -&gt;queryColumn();

<span class="hljs-comment">// スカラ値を返す。</span>
<span class="hljs-comment">// クエリの結果が無かった場合は false が返される。</span>
<span class="hljs-variable">$count</span> = Yii::<span class="hljs-variable">$app</span>-&gt;db-&gt;createCommand(<span class="hljs-string">'SELECT COUNT(*) FROM post'</span>)
             -&gt;queryScalar();
</code></pre>
<blockquote class="note"><p><strong>Note: </strong>精度を保つために、対応するデータベースカラムの型が数値である場合でも、データベースから取得されたデータは、全て文字列として表現されます。</p>
</blockquote>
<h3>パラメータをバインドする  <span id="binding-parameters"></span><a href="#binding-parameters" class="hashlink">&para;</a></h3><p>パラメータを持つ SQL から DB コマンドを作成するときは、SQL インジェクション攻撃を防止するために、ほとんど全ての場合においてパラメータをバインドする手法を用いるべきです。
例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$post</span> = Yii::<span class="hljs-variable">$app</span>-&gt;db-&gt;createCommand(<span class="hljs-string">'SELECT * FROM post WHERE id=:id AND status=:status'</span>)
           -&gt;bindValue(<span class="hljs-string">':id'</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'id'</span>])
           -&gt;bindValue(<span class="hljs-string">':status'</span>, <span class="hljs-number">1</span>)
           -&gt;queryOne();
</code></pre>
<p>SQL 文において、一つまたは複数のパラメータプレースホルダ (例えば、上記のサンプルにおける <code>:id</code>) を埋め込むことが出来ます。
パラメータプレースホルダは、コロンから始まる文字列でなければなりません。
そして、次に掲げるパラメータをバインドするメソッドの一つを使って、パラメータの値をバインドします。</p>
<ul>
<li></li>
<li></li>
<li><span class="broken-link">yii\db\Command::bindParam()</span>: <span class="broken-link">yii\db\Command::bindValue()</span> と似ていますが、パラメータを参照渡しでバインドすることもサポートしています。</li>
</ul>
<p>次の例はパラメータをバインドする方法の選択肢を示すものです。</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$params</span> = [<span class="hljs-string">':id'</span> =&gt; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'id'</span>], <span class="hljs-string">':status'</span> =&gt; <span class="hljs-number">1</span>];

<span class="hljs-variable">$post</span> = Yii::<span class="hljs-variable">$app</span>-&gt;db-&gt;createCommand(<span class="hljs-string">'SELECT * FROM post WHERE id=:id AND status=:status'</span>)
           -&gt;bindValues(<span class="hljs-variable">$params</span>)
           -&gt;queryOne();
           
<span class="hljs-variable">$post</span> = Yii::<span class="hljs-variable">$app</span>-&gt;db-&gt;createCommand(<span class="hljs-string">'SELECT * FROM post WHERE id=:id AND status=:status'</span>, <span class="hljs-variable">$params</span>)
           -&gt;queryOne();
</code></pre>
<p>パラメータバインディングは <a href="http://php.net/manual/ja/mysqli.quickstart.prepared-statements.php">プリペアドステートメント</a> によって実装されています。
パラメータバインディングには、SQL インジェクション攻撃を防止する以外にも、SQL 文を一度だけ準備して異なるパラメータで複数回実行することにより、パフォーマンスを向上させる効果もあります。
例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$command</span> = Yii::<span class="hljs-variable">$app</span>-&gt;db-&gt;createCommand(<span class="hljs-string">'SELECT * FROM post WHERE id=:id'</span>);

<span class="hljs-variable">$post1</span> = <span class="hljs-variable">$command</span>-&gt;bindValue(<span class="hljs-string">':id'</span>, <span class="hljs-number">1</span>)-&gt;queryOne();
<span class="hljs-variable">$post2</span> = <span class="hljs-variable">$command</span>-&gt;bindValue(<span class="hljs-string">':id'</span>, <span class="hljs-number">2</span>)-&gt;queryOne();
<span class="hljs-comment">// ...</span>
</code></pre>
<p><span class="broken-link">yii\db\Command::bindParam()</span> はパラメータを参照渡しでバインドすることをサポートしていますので、上記のコードは次のように書くことも出来ます。</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$command</span> = Yii::<span class="hljs-variable">$app</span>-&gt;db-&gt;createCommand(<span class="hljs-string">'SELECT * FROM post WHERE id=:id'</span>)
              -&gt;bindParam(<span class="hljs-string">':id'</span>, <span class="hljs-variable">$id</span>);

<span class="hljs-variable">$id</span> = <span class="hljs-number">1</span>;
<span class="hljs-variable">$post1</span> = <span class="hljs-variable">$command</span>-&gt;queryOne();

<span class="hljs-variable">$id</span> = <span class="hljs-number">2</span>;
<span class="hljs-variable">$post2</span> = <span class="hljs-variable">$command</span>-&gt;queryOne();
</code></pre>
<p>クエリの実行の前にプレースホルダを変数 <code>$id</code> にバインドし、そして、後に続く各回の実行の前にその変数の値を変更していること (これは、たいてい、ループで行います) に着目してください。
このやり方でクエリを実行すると、パラメータの値が違うごとに新しいクエリを実行するのに比べて、はるかに効率を良くすることが出来ます。</p>
<h3>SELECT しないクエリを実行する  <span id="non-select-queries"></span><a href="#non-select-queries" class="hashlink">&para;</a></h3><p>今までのセクションで紹介した <code>queryXyz()</code> メソッドは、すべて、データベースからデータを取得する SELECT クエリを扱うものでした。
データを返さないクエリのためには、代りに <span class="broken-link">yii\db\Command::execute()</span> メソッドを呼ばなければなりません。
例えば、</p>
<pre><code class="hljs php language-php">Yii::<span class="hljs-variable">$app</span>-&gt;db-&gt;createCommand(<span class="hljs-string">'UPDATE post SET status=1 WHERE id=1'</span>)
   -&gt;execute();
</code></pre>
<p><span class="broken-link">yii\db\Command::execute()</span> メソッドは SQL の実行によって影響を受けた行の数を返します。</p>
<p>INSERT、UPDATE および DELETE クエリのためには、素の SQL を書く代りに、それぞれ、<span class="broken-link">yii\db\Command::insert()</span>、<span class="broken-link">yii\db\Command::update()</span>、<span class="broken-link">yii\db\Command::delete()</span> を呼んで、対応する SQL を構築することが出来ます。
これらのメソッドは、テーブルとカラムの名前を適切に引用符で囲み、パラメータの値をバインドします。
例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-comment">// INSERT (テーブル名, カラムの値)</span>
Yii::<span class="hljs-variable">$app</span>-&gt;db-&gt;createCommand()-&gt;insert(<span class="hljs-string">'user'</span>, [
    <span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'Sam'</span>,
    <span class="hljs-string">'age'</span> =&gt; <span class="hljs-number">30</span>,
])-&gt;execute();

<span class="hljs-comment">// UPDATE (テーブル名, カラムの値, 条件)</span>
Yii::<span class="hljs-variable">$app</span>-&gt;db-&gt;createCommand()-&gt;update(<span class="hljs-string">'user'</span>, [<span class="hljs-string">'status'</span> =&gt; <span class="hljs-number">1</span>], <span class="hljs-string">'age &gt; 30'</span>)-&gt;execute();

<span class="hljs-comment">// DELETE (テーブル名, 条件)</span>
Yii::<span class="hljs-variable">$app</span>-&gt;db-&gt;createCommand()-&gt;delete(<span class="hljs-string">'user'</span>, <span class="hljs-string">'status = 0'</span>)-&gt;execute();
</code></pre>
<p><span class="broken-link">yii\db\Command::batchInsert()</span> を呼んで複数の行を一気に挿入することも出来ます。
この方法は、一度に一行を挿入するよりはるかに効率的です。</p>
<pre><code class="hljs php language-php"><span class="hljs-comment">// テーブル名, カラム名, カラムの値</span>
Yii::<span class="hljs-variable">$app</span>-&gt;db-&gt;createCommand()-&gt;batchInsert(<span class="hljs-string">'user'</span>, [<span class="hljs-string">'name'</span>, <span class="hljs-string">'age'</span>], [
    [<span class="hljs-string">'Tom'</span>, <span class="hljs-number">30</span>],
    [<span class="hljs-string">'Jane'</span>, <span class="hljs-number">20</span>],
    [<span class="hljs-string">'Linda'</span>, <span class="hljs-number">25</span>],
])-&gt;execute();
</code></pre>
<p>上述のメソッド群はクエリを生成するだけであり、実際にそれを実行するためには、常に <span class="broken-link">yii\db\Command::execute()</span>
を呼び出す必要があることに注意してください。</p>
<h2>テーブルとカラムの名前を引用符で囲む  <span id="quoting-table-and-column-names"></span><a href="#quoting-table-and-column-names" class="hashlink">&para;</a></h2><p>特定のデータベースに依存しないコードを書くときには、テーブルとカラムの名前を適切に引用符で囲むことが、たいてい、頭痛の種になります。
データベースによって名前を引用符で囲む規則がさまざまに異なるからです。
この問題を克服するために、次のように、Yii によって導入された引用符の構文を使用することが出来ます。</p>
<ul>
<li><code>[[カラム名]]</code>: 引用符で囲まれるカラム名を二重角括弧で包む。</li>
<li><code>{{テーブル名}}</code>: 引用符で囲まれるテーブル名を二重波括弧で包む。</li>
</ul>
<p>Yii DAO は、このような構文を、DBMS 固有の文法に従って、適切な引用符で囲まれたカラム名とテーブル名に自動的に変換します。
例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-comment">// MySQL では SELECT COUNT(`id`) FROM `employee` という SQL が実行される</span>
<span class="hljs-variable">$count</span> = Yii::<span class="hljs-variable">$app</span>-&gt;db-&gt;createCommand(<span class="hljs-string">"SELECT COUNT([[id]]) FROM {{employee}}"</span>)
            -&gt;queryScalar();
</code></pre>
<h3>テーブル接頭辞を使う  <span id="using-table-prefix"></span><a href="#using-table-prefix" class="hashlink">&para;</a></h3><p>あなたの DB テーブル名のほとんどが何か共通の接頭辞を持っている場合は、Yii DAO によってサポートされているテーブル接頭辞の機能を使うことが出来ます。</p>
<p>最初に、アプリケーションの構成情報で、<span class="broken-link">yii\db\Connection::tablePrefix</span> プロパティによって、テーブル接頭辞を指定します。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">return</span> [
    <span class="hljs-comment">// ...</span>
    <span class="hljs-string">'components'</span> =&gt; [
        <span class="hljs-comment">// ...</span>
        <span class="hljs-string">'db'</span> =&gt; [
            <span class="hljs-comment">// ...</span>
            <span class="hljs-string">'tablePrefix'</span> =&gt; <span class="hljs-string">'tbl_'</span>,
        ],
    ],
];
</code></pre>
<p>そして、あなたのコードの中で、そのテーブル接頭辞を名前に持つテーブルを参照しなければならないときには、いつでも <code>{{%テーブル名}}</code> という構文を使います。
パーセント記号は DB 接続を構成したときに指定したテーブル接頭辞に自動的に置き換えられます。
例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-comment">// MySQL では SELECT COUNT(`id`) FROM `tbl_employee` という SQL が実行される</span>
<span class="hljs-variable">$count</span> = Yii::<span class="hljs-variable">$app</span>-&gt;db-&gt;createCommand(<span class="hljs-string">"SELECT COUNT([[id]]) FROM {{%employee}}"</span>)
            -&gt;queryScalar();
</code></pre>
<h2>トランザクションを実行する  <span id="performing-transactions"></span><a href="#performing-transactions" class="hashlink">&para;</a></h2><p>一続きになった複数の関連するクエリを実行するときは、データの整合性と一貫性を保証するために、一連のクエリをトランザクションで囲む必要がある場合があります。
一連のクエリのどの一つが失敗した場合でも、データベースは、何一つクエリが実行されなかったかのような状態へとロールバックされます。</p>
<p>次のコードはトランザクションの典型的な使用方法を示すものです。</p>
<pre><code class="hljs php language-php">Yii::<span class="hljs-variable">$app</span>-&gt;db-&gt;transaction(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-variable">$db</span>)</span> </span>{
    <span class="hljs-variable">$db</span>-&gt;createCommand(<span class="hljs-variable">$sql1</span>)-&gt;execute();
    <span class="hljs-variable">$db</span>-&gt;createCommand(<span class="hljs-variable">$sql2</span>)-&gt;execute();
    <span class="hljs-comment">// ... その他の SQL 文を実行 ...</span>
});
</code></pre>
<p>上記のコードは、次のものと等価です。こちらの方が、エラー処理のコードをより細かく制御することが出来ます。</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$db</span> = Yii::<span class="hljs-variable">$app</span>-&gt;db;
<span class="hljs-variable">$transaction</span> = <span class="hljs-variable">$db</span>-&gt;beginTransaction();

<span class="hljs-keyword">try</span> {
    <span class="hljs-variable">$db</span>-&gt;createCommand(<span class="hljs-variable">$sql1</span>)-&gt;execute();
    <span class="hljs-variable">$db</span>-&gt;createCommand(<span class="hljs-variable">$sql2</span>)-&gt;execute();
    <span class="hljs-comment">// ... その他の SQL 文を実行 ...</span>

    <span class="hljs-variable">$transaction</span>-&gt;commit();

} <span class="hljs-keyword">catch</span>(\<span class="hljs-keyword">Exception</span> <span class="hljs-variable">$e</span>) {

    <span class="hljs-variable">$transaction</span>-&gt;rollBack();

    <span class="hljs-keyword">throw</span> <span class="hljs-variable">$e</span>;
}
</code></pre>
<p><span class="broken-link">yii\db\Connection::beginTransaction()</span> メソッドを呼ぶことによって、新しいトランザクションが開始されます。
トランザクションは、変数 <code>$transaction</code> に保存された <span class="broken-link">yii\db\Transaction</span> オブジェクトとして表現されます。
そして、実行されるクエリが <code>try...catch...</code> ブロックで囲まれます。
全てのクエリの実行が成功した場合には、トランザクションをコミットするために <span class="broken-link">yii\db\Transaction::commit()</span> が呼ばれます。
そうでなく、例外がトリガされてキャッチされた場合は、<span class="broken-link">yii\db\Transaction::rollBack()</span>
が呼ばれて、トランザクションの中で失敗したクエリに先行するクエリによって行なわれた変更が、ロールバックされます。
そして、<code>throw $e</code> が、まるでそれをキャッチしなかったかのように、例外を再スローしますので、通常のエラー処理プロセスがその例外の面倒を見ることになります。</p>
<h3>分離レベルを指定する  <span id="specifying-isolation-levels"></span><a href="#specifying-isolation-levels" class="hashlink">&para;</a></h3><p>Yii は、トランザクションの <a href="http://ja.wikipedia.org/wiki/%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E5%88%86%E9%9B%A2%E3%83%AC%E3%83%99%E3%83%AB">分離レベル</a> の設定もサポートしています。
デフォルトでは、新しいトランザクションを開始したときは、データベースシステムによって設定された分離レベルを使用します。
デフォルトの分離レベルは、次のようにしてオーバーライドすることが出来ます。</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$isolationLevel</span> = \yii\db\Transaction::REPEATABLE_READ;

Yii::<span class="hljs-variable">$app</span>-&gt;db-&gt;transaction(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(<span class="hljs-variable">$db</span>)</span> </span>{
    ....
}, <span class="hljs-variable">$isolationLevel</span>);
 
<span class="hljs-comment">// あるいは</span>

<span class="hljs-variable">$transaction</span> = Yii::<span class="hljs-variable">$app</span>-&gt;db-&gt;beginTransaction(<span class="hljs-variable">$isolationLevel</span>);
</code></pre>
<p>Yii は、最もよく使われる分離レベルのために、四つの定数を提供しています。</p>
<ul>
<li><span class="broken-link">\yii\db\Transaction::READ_UNCOMMITTED</span> - 最も弱いレベル。ダーティーリード、非再現リード、ファントムが発生しうる。</li>
<li><span class="broken-link">\yii\db\Transaction::READ_COMMITTED</span> - ダーティーリードを回避。</li>
<li><span class="broken-link">\yii\db\Transaction::REPEATABLE_READ</span> - ダーティーリードと非再現リードを回避。</li>
<li><span class="broken-link">\yii\db\Transaction::SERIALIZABLE</span> - 最も強いレベル。上記の問題を全て回避。</li>
</ul>
<p>分離レベルを指定するためには、上記の定数を使う以外に、あなたが使っている DBMS によってサポートされている有効な構文の文字列を使うことも出来ます。
例えば、PostreSQL では、<code>SERIALIZABLE READ ONLY DEFERRABLE</code> を使うことが出来ます。</p>
<p>DBMS によっては、接続全体に対してのみ分離レベルの設定を許容しているものがあることに注意してください。
その場合、すべての後続のトランザクションは、指定しなくても、それと同じ分離レベルで実行されます。
従って、この機能を使用するときは、矛盾する設定を避けるために、全てのトランザクションについて分離レベルを明示的に指定しなければなりません。
このチュートリアルを書いている時点では、この制約の影響を受ける DBMS は MSSQL と SQLite だけです。</p>
<blockquote class="note"><p><strong>Note: </strong>SQLite は、二つの分離レベルしかサポートしていません。すなわち、<code>READ UNCOMMITTED</code> と <code>SERIALIZABLE</code> しか使えません。
他のレベルを使おうとすると、例外が投げられます。</p>
</blockquote>
<blockquote class="note"><p><strong>Note: </strong>PostgreSQL は、トランザクションを開始する前に分離レベルを指定することを許容していません。
すなわち、トランザクションを開始するときに、分離レベルを直接に指定することは出来ません。
この場合、トランザクションを開始した後に <span class="broken-link">yii\db\Transaction::setIsolationLevel()</span> を呼び出す必要があります。</p>
</blockquote>
<h3>トランザクションを入れ子にする  <span id="nesting-transactions"></span><a href="#nesting-transactions" class="hashlink">&para;</a></h3><p>あなたの DBMS が Savepoint をサポートしている場合は、次のように、複数のトランザクションを入れ子にすることが出来ます。</p>
<pre><code class="hljs php language-php">Yii::<span class="hljs-variable">$app</span>-&gt;db-&gt;transaction(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(<span class="hljs-variable">$db</span>)</span> </span>{
    <span class="hljs-comment">// 外側のトランザクション</span>
    
    <span class="hljs-variable">$db</span>-&gt;transaction(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(<span class="hljs-variable">$db</span>)</span> </span>{
        <span class="hljs-comment">// 内側のトランザクション</span>
    });
});
</code></pre>
<p>あるいは、</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$db</span> = Yii::<span class="hljs-variable">$app</span>-&gt;db;
<span class="hljs-variable">$outerTransaction</span> = <span class="hljs-variable">$db</span>-&gt;beginTransaction();
<span class="hljs-keyword">try</span> {
    <span class="hljs-variable">$db</span>-&gt;createCommand(<span class="hljs-variable">$sql1</span>)-&gt;execute();

    <span class="hljs-variable">$innerTransaction</span> = <span class="hljs-variable">$db</span>-&gt;beginTransaction();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-variable">$db</span>-&gt;createCommand(<span class="hljs-variable">$sql2</span>)-&gt;execute();
        <span class="hljs-variable">$innerTransaction</span>-&gt;commit();
    } <span class="hljs-keyword">catch</span> (\<span class="hljs-keyword">Exception</span> <span class="hljs-variable">$e</span>) {
        <span class="hljs-variable">$innerTransaction</span>-&gt;rollBack();
        <span class="hljs-keyword">throw</span> <span class="hljs-variable">$e</span>;
    }

    <span class="hljs-variable">$outerTransaction</span>-&gt;commit();
} <span class="hljs-keyword">catch</span> (\<span class="hljs-keyword">Exception</span> <span class="hljs-variable">$e</span>) {
    <span class="hljs-variable">$outerTransaction</span>-&gt;rollBack();
    <span class="hljs-keyword">throw</span> <span class="hljs-variable">$e</span>;
}
</code></pre>
<h2>レプリケーションと読み書きの分離  <span id="read-write-splitting"></span><a href="#read-write-splitting" class="hashlink">&para;</a></h2><p>多くの DBMS は、データベースの可用性とサーバのレスポンスタイムを向上させるために、<a href="http://ja.wikipedia.org/wiki/%E3%83%AC%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3#.E3.83.87.E3.83.BC.E3.82.BF.E3.83.99.E3.83.BC.E3.82.B9">データベースレプリケーション</a> をサポートしています。
データベースレプリケーションによって、データはいわゆる <em>マスタサーバ</em> から <em>スレーブサーバ</em> に複製されます。
データの書き込みと更新はすべてマスタサーバ上で実行されなければなりませんが、データの読み出しはスレーブサーバ上でも可能です。</p>
<p>データベースレプリケーションを活用して読み書きの分離を達成するために、<span class="broken-link">yii\db\Connection</span> コンポーネントを下記のように構成することが出来ます。</p>
<pre><code class="hljs php language-php">[
    <span class="hljs-string">'class'</span> =&gt; <span class="hljs-string">'yii\db\Connection'</span>,

    <span class="hljs-comment">// マスタの構成</span>
    <span class="hljs-string">'dsn'</span> =&gt; <span class="hljs-string">'マスタサーバの DSN'</span>,
    <span class="hljs-string">'username'</span> =&gt; <span class="hljs-string">'master'</span>,
    <span class="hljs-string">'password'</span> =&gt; <span class="hljs-string">''</span>,

    <span class="hljs-comment">// スレーブの共通の構成</span>
    <span class="hljs-string">'slaveConfig'</span> =&gt; [
        <span class="hljs-string">'username'</span> =&gt; <span class="hljs-string">'slave'</span>,
        <span class="hljs-string">'password'</span> =&gt; <span class="hljs-string">''</span>,
        <span class="hljs-string">'attributes'</span> =&gt; [
            <span class="hljs-comment">// 短かめの接続タイムアウトを使う</span>
            PDO::ATTR_TIMEOUT =&gt; <span class="hljs-number">10</span>,
        ],
    ],

    <span class="hljs-comment">// スレーブの構成のリスト</span>
    <span class="hljs-string">'slaves'</span> =&gt; [
        [<span class="hljs-string">'dsn'</span> =&gt; <span class="hljs-string">'スレーブサーバ 1 の DSN'</span>],
        [<span class="hljs-string">'dsn'</span> =&gt; <span class="hljs-string">'スレーブサーバ 2 の DSN'</span>],
        [<span class="hljs-string">'dsn'</span> =&gt; <span class="hljs-string">'スレーブサーバ 3 の DSN'</span>],
        [<span class="hljs-string">'dsn'</span> =&gt; <span class="hljs-string">'スレーブサーバ 4 の DSN'</span>],
    ],
]
</code></pre>
<p>上記の構成は、一つのマスタと複数のスレーブを指定するものです。
読み出しのクエリを実行するためには、スレーブの一つが接続されて使用され、書き込みのクエリを実行するためには、マスタが使われます。
そのような読み書きの分離が、この構成によって、自動的に達成されます。例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-comment">// 上記の構成を使って Connection のインスタンスを作成する</span>
<span class="hljs-variable">$db</span> = Yii::createObject(<span class="hljs-variable">$config</span>);

<span class="hljs-comment">// スレーブの一つに対してクエリを実行する</span>
<span class="hljs-variable">$rows</span> = Yii::<span class="hljs-variable">$app</span>-&gt;db-&gt;createCommand(<span class="hljs-string">'SELECT * FROM user LIMIT 10'</span>)-&gt;queryAll();

<span class="hljs-comment">// マスタに対してクエリを実行する</span>
Yii::<span class="hljs-variable">$app</span>-&gt;db-&gt;createCommand(<span class="hljs-string">"UPDATE user SET username='demo' WHERE id=1"</span>)-&gt;execute();
</code></pre>
<blockquote class="info"><p><strong>Info: </strong><span class="broken-link">yii\db\Command::execute()</span> を呼ぶことで実行されるクエリは、書き込みのクエリと見なされ、<span class="broken-link">yii\db\Command</span> の "query" メソッドのうちの一つによって実行されるその他すべてのクエリは、読み出しクエリと見なされます。
  現在アクティブなスレーブ接続は <code>Yii::$app-&gt;db-&gt;slave</code> によって取得することが出来ます。</p>
</blockquote>
<p><code>Connection</code> コンポーネントは、スレーブ間のロードバランス調整とフェイルオーバーをサポートしています。
読み出しクエリを最初に実行するときに、<code>Connection</code> コンポーネントはランダムにスレーブを選んで接続を試みます。
そのスレーブが「死んでいる」ことが分かったときは、他のスレーブを試します。
スレーブが一つも使用できないときは、マスタに接続します。
<span class="broken-link">yii\db\Connection::serverStatusCache</span> を構成することによって、「死んでいる」サーバを記憶し、<span class="broken-link">yii\db\Connection::serverRetryInterval</span> はそのサーバへの接続を再試行しないようにすることが出来ます。</p>
<blockquote class="info"><p><strong>Info: </strong>上記の構成では、すべてのスレーブに対して 10 秒の接続タイムアウトが指定されています。
  これは、10 秒以内に接続できなければ、そのスレーブは「死んでいる」と見なされることを意味します。
  このパラメータは、実際の環境に基づいて調整することが出来ます。</p>
</blockquote>
<p>複数のマスタと複数のスレーブという構成にすることも可能です。例えば、</p>
<pre><code class="hljs php language-php">[
    <span class="hljs-string">'class'</span> =&gt; <span class="hljs-string">'yii\db\Connection'</span>,

    <span class="hljs-comment">// マスタの共通の構成</span>
    <span class="hljs-string">'masterConfig'</span> =&gt; [
        <span class="hljs-string">'username'</span> =&gt; <span class="hljs-string">'master'</span>,
        <span class="hljs-string">'password'</span> =&gt; <span class="hljs-string">''</span>,
        <span class="hljs-string">'attributes'</span> =&gt; [
            <span class="hljs-comment">// 短かめの接続タイムアウトを使う</span>
            PDO::ATTR_TIMEOUT =&gt; <span class="hljs-number">10</span>,
        ],
    ],

    <span class="hljs-comment">// マスタの構成のリスト</span>
    <span class="hljs-string">'masters'</span> =&gt; [
        [<span class="hljs-string">'dsn'</span> =&gt; <span class="hljs-string">'マスタサーバ 1 の DSN'</span>],
        [<span class="hljs-string">'dsn'</span> =&gt; <span class="hljs-string">'マスタサーバ 2 の DSN'</span>],
    ],

    <span class="hljs-comment">// スレーブの共通の構成</span>
    <span class="hljs-string">'slaveConfig'</span> =&gt; [
        <span class="hljs-string">'username'</span> =&gt; <span class="hljs-string">'slave'</span>,
        <span class="hljs-string">'password'</span> =&gt; <span class="hljs-string">''</span>,
        <span class="hljs-string">'attributes'</span> =&gt; [
            <span class="hljs-comment">// 短かめの接続タイムアウトを使う</span>
            PDO::ATTR_TIMEOUT =&gt; <span class="hljs-number">10</span>,
        ],
    ],

    <span class="hljs-comment">// スレーブの構成のリスト</span>
    <span class="hljs-string">'slaves'</span> =&gt; [
        [<span class="hljs-string">'dsn'</span> =&gt; <span class="hljs-string">'スレーブサーバ 1 の DSN'</span>],
        [<span class="hljs-string">'dsn'</span> =&gt; <span class="hljs-string">'スレーブサーバ 2 の DSN'</span>],
        [<span class="hljs-string">'dsn'</span> =&gt; <span class="hljs-string">'スレーブサーバ 3 の DSN'</span>],
        [<span class="hljs-string">'dsn'</span> =&gt; <span class="hljs-string">'スレーブサーバ 4 の DSN'</span>],
    ],
]
</code></pre>
<p>上記の構成は、二つのマスタと四つのスレーブを指定しています。
<code>Connection</code> コンポーネントは、スレーブ間での場合と同じように、マスタ間でのロードバランス調整とフェイルオーバーをサポートしています。
一つ違うのは、マスタが一つも利用できないときは例外が投げられる、という点です。</p>
<blockquote class="note"><p><strong>Note: </strong><span class="broken-link">yii\db\Connection::masters</span> プロパティを使って一つまたは複数のマスタを構成する場合は、データベース接続を定義する <code>Connection</code> オブジェクト自体のその他のプロパティ (例えば、<code>dsn</code>、<code>username</code>、<code>password</code>) は全て無視されます。</p>
</blockquote>
<p>デフォルトでは、トランザクションはマスタ接続を使用します。そして、トランザクション内では、全ての DB 操作はマスタ接続を使用します。
例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$db</span> = Yii::<span class="hljs-variable">$app</span>-&gt;db;
<span class="hljs-comment">// トランザクションはマスタ接続で開始される</span>
<span class="hljs-variable">$transaction</span> = <span class="hljs-variable">$db</span>-&gt;beginTransaction();

<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// クエリは両方ともマスタに対して実行される</span>
    <span class="hljs-variable">$rows</span> = <span class="hljs-variable">$db</span>-&gt;createCommand(<span class="hljs-string">'SELECT * FROM user LIMIT 10'</span>)-&gt;queryAll();
    <span class="hljs-variable">$db</span>-&gt;createCommand(<span class="hljs-string">"UPDATE user SET username='demo' WHERE id=1"</span>)-&gt;execute();

    <span class="hljs-variable">$transaction</span>-&gt;commit();
} <span class="hljs-keyword">catch</span>(\<span class="hljs-keyword">Exception</span> <span class="hljs-variable">$e</span>) {
    <span class="hljs-variable">$transaction</span>-&gt;rollBack();
    <span class="hljs-keyword">throw</span> <span class="hljs-variable">$e</span>;
}
</code></pre>
<p>スレーブ接続を使ってトランザクションを開始したいときは、次のように、明示的にそうする必要があります。</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$transaction</span> = Yii::<span class="hljs-variable">$app</span>-&gt;db-&gt;slave-&gt;beginTransaction();
</code></pre>
<p>時として、読み出しクエリの実行にマスタ接続を使うことを強制したい場合があります。
これは、<code>useMaster()</code> メソッドを使うによって達成できます。</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$rows</span> = Yii::<span class="hljs-variable">$app</span>-&gt;db-&gt;useMaster(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(<span class="hljs-variable">$db</span>)</span> </span>{
    <span class="hljs-keyword">return</span> Yii::<span class="hljs-variable">$app</span>-&gt;db-&gt;createCommand(<span class="hljs-string">'SELECT * FROM user LIMIT 10'</span>)-&gt;queryAll();
});
</code></pre>
<p>直接に <code>Yii::$app-&gt;db-&gt;enableSlaves</code> を false に設定して、全てのクエリをマスタ接続に向けることも出来ます。</p>
<h2>データベーススキーマを扱う  <span id="database-schema"></span><a href="#database-schema" class="hashlink">&para;</a></h2><p>Yii DAO は、新しいテーブルを作ったり、テーブルからカラムを削除したりなど、データベーススキーマを操作することを可能にする一揃いのメソッドを提供しています。
以下がそのソッドのリストです。</p>
<ul>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
</ul>
<p>これらのメソッドは次のようにして使うことが出来ます。</p>
<pre><code class="hljs php language-php"><span class="hljs-comment">// CREATE TABLE</span>
Yii::<span class="hljs-variable">$app</span>-&gt;db-&gt;createCommand()-&gt;createTable(<span class="hljs-string">'post'</span>, [
    <span class="hljs-string">'id'</span> =&gt; <span class="hljs-string">'pk'</span>,
    <span class="hljs-string">'title'</span> =&gt; <span class="hljs-string">'string'</span>,
    <span class="hljs-string">'text'</span> =&gt; <span class="hljs-string">'text'</span>,
]);
</code></pre>
<p>上記の配列は、生成されるカラムの名前と型を記述しています。
Yii はカラムの型のために一連の抽象データ型を提供しているため、データベースの違いを意識せずにスキーマを定義することが可能です。
これらの抽象データ型は、テーブルが作成されるデータベースに依存する DBMS 固有の型定義に変換されます。
詳しい情報は <span class="broken-link">yii\db\Command::createTable()</span> メソッドの API ドキュメントを参照してください。</p>
<p>データベースのスキーマを変更するだけでなく、テーブルに関する定義情報を DB 接続の <span class="broken-link">yii\db\Connection::getTableSchema()</span> メソッドによって取得することも出来ます。
例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$table</span> = Yii::<span class="hljs-variable">$app</span>-&gt;db-&gt;getTableSchema(<span class="hljs-string">'post'</span>);
</code></pre>
<p>このメソッドは、テーブルのカラム、プライマリキー、外部キーなどの情報を含む <span class="broken-link">yii\db\TableSchema</span> オブジェクトを返します。
これらの情報は、主として <a href="guide-db-query-builder.html">クエリビルダ</a> や <a href="guide-db-active-record.html">アクティブレコード</a> によって利用されて、特定のデータベースに依存しないコードを書くことを助けてくれています。</p>
        <div class="toplink"><a href="#" class="h1" title="go to top"><span class="glyphicon glyphicon-arrow-up"></a></div>
    </div>
</div>


</div>

<footer class="footer">
        <p class="pull-right"><small>Page generated on Tue, 27 Dec 2016 22:28:43 +0000</small></p>
    Powered by <a href="http://www.yiiframework.com/" rel="external">Yii Framework</a></footer>

<script type="text/javascript">jQuery(document).ready(function () {
    var shiftWindow = function () { scrollBy(0, -50) };
    if (location.hash) setTimeout(shiftWindow, 1);
    window.addEventListener("hashchange", shiftWindow);
var element = document.createElement("script");
element.src = "./jssearch.index.js";
document.body.appendChild(element);

var searchBox = $('#searchbox');

// search when typing in search field
searchBox.on("keyup", function(event) {
    var query = $(this).val();

    if (query == '' || event.which == 27) {
        $('#search-resultbox').hide();
        return;
    } else if (event.which == 13) {
        var selectedLink = $('#search-resultbox a.selected');
        if (selectedLink.length != 0) {
            document.location = selectedLink.attr('href');
            return;
        }
    } else if (event.which == 38 || event.which == 40) {
        $('#search-resultbox').show();

        var selected = $('#search-resultbox a.selected');
        if (selected.length == 0) {
            $('#search-results').find('a').first().addClass('selected');
        } else {
            var next;
            if (event.which == 40) {
                next = selected.parent().next().find('a').first();
            } else {
                next = selected.parent().prev().find('a').first();
            }
            if (next.length != 0) {
                var resultbox = $('#search-results');
                var position = next.position();

//              TODO scrolling is buggy and jumps around
//                resultbox.scrollTop(Math.floor(position.top));
//                console.log(position.top);

                selected.removeClass('selected');
                next.addClass('selected');
            }
        }

        return;
    }
    $('#search-resultbox').show();
    $('#search-results').html('<li><span class="no-results">No results</span></li>');

    var result = jssearch.search(query);

    if (result.length > 0) {
        var i = 0;
        var resHtml = '';

        for (var key in result) {
            if (i++ > 20) {
                break;
            }
            resHtml = resHtml +
            '<li><a href="' + result[key].file.u.substr(3) +'"><span class="title">' + result[key].file.t + '</span>' +
            '<span class="description">' + result[key].file.d + '</span></a></li>';
        }
        $('#search-results').html(resHtml);
    }
});

// hide the search results on ESC
$(document).on("keyup", function(event) { if (event.which == 27) { $('#search-resultbox').hide(); } });
// hide search results on click to document
$(document).bind('click', function (e) { $('#search-resultbox').hide(); });
// except the following:
searchBox.bind('click', function(e) { e.stopPropagation(); });
$('#search-resultbox').bind('click', function(e) { e.stopPropagation(); });

});</script></body>
</html>
