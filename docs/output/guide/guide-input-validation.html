<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="language" content="en" />
        <link href="./assets/90d046f2/css/bootstrap.css" rel="stylesheet">
<link href="./assets/c6368d94/solarized_light.css" rel="stylesheet">
<link href="./assets/9f5cdd92/style.css" rel="stylesheet">
<script src="./assets/a6e53573/jquery.js"></script>
<script src="./assets/90d046f2/js/bootstrap.js"></script>
<script src="./assets/218ce2e5/jssearch.js"></script>    <title>Kiểm tra dữ liệu đầu vào (Validating Input) - Nhận dữ liệu từ user - The Definitive Guide to Yii 2.0</title>
</head>
<body>

<div class="wrap">
    <nav id="w11536" class="navbar-inverse navbar-fixed-top navbar" role="navigation"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#w11536-collapse"><span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span></button><a class="navbar-brand" href="./guide-index.html">The Definitive Guide to Yii 2.0</a></div><div id="w11536-collapse" class="collapse navbar-collapse"><ul id="w11537" class="navbar-nav nav"><li><a href="./guide-README.html">Guide</a></li></ul><div class="navbar-form navbar-left" role="search">
  <div class="form-group">
    <input id="searchbox" type="text" class="form-control" placeholder="Search">
  </div>
</div>
</div></nav>
    <div id="search-resultbox" style="display: none;" class="modal-content">
        <ul id="search-results">
        </ul>
    </div>

    
<div class="row">
    <div class="col-md-2">
                <div id="navigation" class="list-group"><a class="list-group-item" href="#navigation-11520" data-toggle="collapse" data-parent="#navigation">Giới thiệu <b class="caret"></b></a><div id="navigation-11520" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-intro-yii.html">Về Yii</a>
<a class="list-group-item" href="./guide-intro-upgrade-from-v1.html">Nâng cấp lên từ phiên bản 1.1</a></div>
<a class="list-group-item" href="#navigation-11521" data-toggle="collapse" data-parent="#navigation">Bắt đầu <b class="caret"></b></a><div id="navigation-11521" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-start-installation.html">Cài đặt Yii</a>
<a class="list-group-item" href="./guide-start-workflow.html">Thực hiện chạy ứng dụng</a>
<a class="list-group-item" href="./guide-start-hello.html">Viết lời chào đầu tiên</a>
<a class="list-group-item" href="./guide-start-forms.html">Làm việc với Forms</a>
<a class="list-group-item" href="./guide-start-databases.html">Làm việc với Databases</a>
<a class="list-group-item" href="./guide-start-gii.html">Sử dụng Gii để sinh code</a>
<a class="list-group-item" href="./guide-start-looking-ahead.html">Mức cao hơn</a></div>
<a class="list-group-item" href="#navigation-11522" data-toggle="collapse" data-parent="#navigation">Kiến trúc ứng dụng (Application Structure) <b class="caret"></b></a><div id="navigation-11522" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-structure-overview.html">Tổng quan về kiến trúc ứng dụng</a>
<a class="list-group-item" href="./guide-structure-entry-scripts.html">Mục Scripts</a>
<a class="list-group-item" href="./guide-structure-applications.html">Ứng dụng (Applications)</a>
<a class="list-group-item" href="./guide-structure-application-components.html">Thành phần ứng dụng</a>
<a class="list-group-item" href="./guide-structure-controllers.html">Bộ điều khiển (Controllers)</a>
<a class="list-group-item" href="./guide-structure-models.html">Models</a>
<a class="list-group-item" href="./guide-structure-views.html">Views</a>
<a class="list-group-item" href="./guide-structure-modules.html">Modules</a>
<a class="list-group-item" href="./guide-structure-filters.html">Bộ lọc (Filters)</a>
<a class="list-group-item" href="./guide-structure-widgets.html">Widgets</a>
<a class="list-group-item" href="./guide-structure-assets.html">Assets</a>
<a class="list-group-item" href="./guide-structure-extensions.html">Phần mở rộng (Extensions)</a></div>
<a class="list-group-item" href="#navigation-11523" data-toggle="collapse" data-parent="#navigation">Yêu cầu xử lý (Handling Requests) <b class="caret"></b></a><div id="navigation-11523" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-runtime-overview.html">Tổng quan</a>
<a class="list-group-item" href="./guide-runtime-bootstrapping.html">Bootstrapping</a>
<a class="list-group-item" href="./guide-runtime-routing.html">Routing và URL Creation</a>
<a class="list-group-item" href="./guide-runtime-requests.html">Yêu cầu (Requests)</a>
<a class="list-group-item" href="./guide-runtime-responses.html">Responses</a>
<a class="list-group-item" href="./guide-runtime-sessions-cookies.html">Sessions và Cookies</a>
<a class="list-group-item" href="./guide-runtime-handling-errors.html">Xử lý lỗi (Handling Error)</a>
<a class="list-group-item" href="./guide-runtime-logging.html">Logging</a></div>
<a class="list-group-item" href="#navigation-11524" data-toggle="collapse" data-parent="#navigation">Các khái niệm chính <b class="caret"></b></a><div id="navigation-11524" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-concept-components.html">Thành phần (Components)</a>
<a class="list-group-item" href="./guide-concept-properties.html">Thuộc tính (Properties)</a>
<a class="list-group-item" href="./guide-concept-events.html">Sự kiện (Events)</a>
<a class="list-group-item" href="./guide-concept-behaviors.html">Hành vi (Behaviors)</a>
<a class="list-group-item" href="./guide-concept-configurations.html">Cấu hình (Configurations)</a>
<a class="list-group-item" href="./guide-concept-aliases.html">Bí danh (Aliases)</a>
<a class="list-group-item" href="./guide-concept-autoloading.html">Lớp tự động nạp (Autoloading)</a>
<a class="list-group-item" href="./guide-concept-service-locator.html">Service Locator</a>
<a class="list-group-item" href="./guide-concept-di-container.html">Dependency Injection Container</a></div>
<a class="list-group-item" href="#navigation-11525" data-toggle="collapse" data-parent="#navigation">Làm việc với Databases <b class="caret"></b></a><div id="navigation-11525" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-db-dao.html">Data Access Objects</a>
<a class="list-group-item" href="./guide-db-query-builder.html">Query Builder</a>
<a class="list-group-item" href="./guide-db-active-record.html">Active Record</a>
<a class="list-group-item" href="./guide-db-migrations.html">Migrations</a>
<a class="list-group-item" href="./guide-db-sphinx.html">Sphinx</a>
<a class="list-group-item" href="./guide-db-redis.html">Redis</a>
<a class="list-group-item" href="./guide-db-mongodb.html">MongoDB</a>
<a class="list-group-item" href="./guide-db-elasticsearch.html">ElasticSearch</a></div>
<a class="list-group-item active" href="#navigation-11526" data-toggle="collapse" data-parent="#navigation">Nhận dữ liệu từ user <b class="caret"></b></a><div id="navigation-11526" class="submenu panel-collapse collapse in"><a class="list-group-item" href="./guide-input-forms.html">Tạo mới Forms</a>
<a class="list-group-item active" href="./guide-input-validation.html">Kiểm tra dữ liệu đầu vào (Validating Input)</a>
<a class="list-group-item" href="./guide-input-file-upload.html">File Upload</a>
<a class="list-group-item" href="./guide-input-tabular-input.html">Thu thập dữ liệu từ danh sách đầu vào (Đang phát triển)</a>
<a class="list-group-item" href="./guide-input-multiple-models.html">Lấy dữ liệu cho nhiều Models (Chưa giải quyết)</a></div>
<a class="list-group-item" href="#navigation-11527" data-toggle="collapse" data-parent="#navigation">Hiển thị dữ liệu <b class="caret"></b></a><div id="navigation-11527" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-output-formatter.html">Định dạng dữ liệu (Data Formatting)</a>
<a class="list-group-item" href="./guide-output-pagination.html">Phân trang (Pagination)</a>
<a class="list-group-item" href="./guide-output-sorting.html">Sắp xếp (Sorting)</a>
<a class="list-group-item" href="./guide-output-data-providers.html">Cung cấp dữ liệu ra (Data Providers)</a>
<a class="list-group-item" href="./guide-output-data-widgets.html">Dữ liệu Widgets</a>
<a class="list-group-item" href="./guide-output-client-scripts.html">làm việc với Client Scripts</a>
<a class="list-group-item" href="./guide-output-theming.html">Giao diện (Theming)</a></div>
<a class="list-group-item" href="#navigation-11528" data-toggle="collapse" data-parent="#navigation">Bảo mật (Security) <b class="caret"></b></a><div id="navigation-11528" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-security-authentication.html">Xác thực (Authentication)</a>
<a class="list-group-item" href="./guide-security-authorization.html">Quyền (Authorization)</a>
<a class="list-group-item" href="./guide-security-passwords.html">Các thao tác xử lý với Passwords (Đang phát triển)</a>
<a class="list-group-item" href="./guide-security-auth-clients.html">Auth Clients</a>
<a class="list-group-item" href="./guide-security-best-practices.html">Best Practices</a></div>
<a class="list-group-item" href="#navigation-11529" data-toggle="collapse" data-parent="#navigation">Bộ nhớ Cache <b class="caret"></b></a><div id="navigation-11529" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-caching-overview.html">Tổng quan</a>
<a class="list-group-item" href="./guide-caching-data.html">Cache dữ liệu</a>
<a class="list-group-item" href="./guide-caching-fragment.html">Fragment Caching</a>
<a class="list-group-item" href="./guide-caching-page.html">Page Caching</a>
<a class="list-group-item" href="./guide-caching-http.html">HTTP Caching</a></div>
<a class="list-group-item" href="#navigation-11530" data-toggle="collapse" data-parent="#navigation">RESTful Web Services <b class="caret"></b></a><div id="navigation-11530" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-rest-quick-start.html">Bắt đầu</a>
<a class="list-group-item" href="./guide-rest-resources.html">Tài nguyên (Resources)</a>
<a class="list-group-item" href="./guide-rest-controllers.html">Bộ điều khiển (Controllers)</a>
<a class="list-group-item" href="./guide-rest-routing.html">Routing</a>
<a class="list-group-item" href="./guide-rest-response-formatting.html">Định dạng thông điệp gửi đi (Response Formatting)</a>
<a class="list-group-item" href="./guide-rest-authentication.html">Xác thực (Authentication)</a>
<a class="list-group-item" href="./guide-rest-rate-limiting.html">Rate Limiting</a>
<a class="list-group-item" href="./guide-rest-versioning.html">Phiên bản (Version)</a>
<a class="list-group-item" href="./guide-rest-error-handling.html">Error Handling</a></div>
<a class="list-group-item" href="#navigation-11531" data-toggle="collapse" data-parent="#navigation">Công cụ phát triển (Development Tools) <b class="caret"></b></a><div id="navigation-11531" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-tool-debugger.html">Thanh công cụ gỡ lỗi và sửa lỗi (Debug Toolbar và Debugger)</a>
<a class="list-group-item" href="./guide-tool-gii.html">Sử dụng Gii để tạo code</a>
<a class="list-group-item" href="./guide-tool-api-doc.html">Tạo tài liệu về API </a></div>
<a class="list-group-item" href="#navigation-11532" data-toggle="collapse" data-parent="#navigation">Testing <b class="caret"></b></a><div id="navigation-11532" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-test-overview.html">Tổng quan</a>
<a class="list-group-item" href="./guide-test-environment-setup.html">Thiết lập môi trường</a>
<a class="list-group-item" href="./guide-test-unit.html">Unit Tests</a>
<a class="list-group-item" href="./guide-test-functional.html">Kiểm tra chức năng (Functional Tests)</a>
<a class="list-group-item" href="./guide-test-acceptance.html">Acceptance Tests</a>
<a class="list-group-item" href="./guide-test-fixtures.html">Fixtures</a></div>
<a class="list-group-item" href="#navigation-11533" data-toggle="collapse" data-parent="#navigation">Chủ đề năng cao <b class="caret"></b></a><div id="navigation-11533" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-tutorial-advanced-app.html">Advanced Application Template</a>
<a class="list-group-item" href="./guide-tutorial-start-from-scratch.html">Building Application from Scratch</a>
<a class="list-group-item" href="./guide-tutorial-console.html">Giao diện dòng lệnh (Console Commands)</a>
<a class="list-group-item" href="./guide-tutorial-core-validators.html">Core Validators</a>
<a class="list-group-item" href="./guide-tutorial-i18n.html">Quốc tế hóa (Internationalization)</a>
<a class="list-group-item" href="./guide-tutorial-mailing.html">Thư (Mailing)</a>
<a class="list-group-item" href="./guide-tutorial-performance-tuning.html">Tối ưu hiệu năng ứng dụng (Performance Tuning)</a>
<a class="list-group-item" href="./guide-tutorial-shared-hosting.html">Shared Hosting Environment</a>
<a class="list-group-item" href="./guide-tutorial-template-engines.html">Template Engines</a>
<a class="list-group-item" href="./guide-tutorial-yii-integration.html">Working with Third-Party Code</a></div>
<a class="list-group-item" href="#navigation-11534" data-toggle="collapse" data-parent="#navigation">Widgets <b class="caret"></b></a><div id="navigation-11534" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-widget-bootstrap.html">Bootstrap Widgets</a>
<a class="list-group-item" href="./guide-widget-jui.html">jQuery UI Widgets</a></div>
<a class="list-group-item" href="#navigation-11535" data-toggle="collapse" data-parent="#navigation">Helpers <b class="caret"></b></a><div id="navigation-11535" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-helper-overview.html">Tổng quan</a>
<a class="list-group-item" href="./guide-helper-array.html">ArrayHelper</a>
<a class="list-group-item" href="./guide-helper-html.html">Html</a>
<a class="list-group-item" href="./guide-helper-url.html">Url</a></div></div>    </div>
    <div class="col-md-9 guide-content" role="main">
        <h1>入力を検証する <span id="ru-liwo-jian-zhengsuru"></span><a href="#ru-liwo-jian-zhengsuru" class="hashlink">&para;</a></h1>
<div class="toc"><ol><li><a href="#declaring-rules">規則を宣言する</a></li>
<li><a href="#ad-hoc-validation">その場限りの検証</a></li>
<li><a href="#creating-validators">バリデータを作成する</a></li>
<li><a href="#client-side-validation">クライアント側での検証</a></li></ol></div>
<p>経験則として言えることは、エンドユーザから受信したデータは決して信用せず、利用する前に検証しなければならない、ということです。</p>
<p><a href="guide-structure-models.html">モデル</a> にユーザの入力が投入されたら、モデルの <span class="broken-link">yii\base\Model::validate()</span> メソッドを呼んで入力を検証することが出来ます。
このメソッドは検証が成功したか否かを示す真偽値を返します。
検証が失敗した場合は、<span class="broken-link">yii\base\Model::errors</span> プロパティからエラーメッセージを取得することが出来ます。
例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$model</span> = <span class="hljs-keyword">new</span> \app\models\ContactForm();

<span class="hljs-comment">// モデルの属性にユーザ入力を投入する</span>
<span class="hljs-variable">$model</span>-&gt;load(\Yii::<span class="hljs-variable">$app</span>-&gt;request-&gt;post());
<span class="hljs-comment">// これは次と等価</span>
<span class="hljs-comment">// $model-&gt;attributes = \Yii::$app-&gt;request-&gt;post('ContactForm');</span>

<span class="hljs-keyword">if</span> (<span class="hljs-variable">$model</span>-&gt;validate()) {
    <span class="hljs-comment">// 全ての入力が有効</span>
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 検証が失敗。$errors はエラーメッセージを含む配列</span>
    <span class="hljs-variable">$errors</span> = <span class="hljs-variable">$model</span>-&gt;errors;
}
</code></pre>
<h2>規則を宣言する  <span id="declaring-rules"></span><a href="#declaring-rules" class="hashlink">&para;</a></h2><p><code>validate()</code> を現実に動作させるためには、検証する予定の属性に対して検証規則を宣言しなければなりません。
規則は <span class="broken-link">yii\base\Model::rules()</span> メソッドをオーバーライドすることで宣言します。
次の例は、<code>ContactForm</code> モデルに対して検証規則を宣言する方法を示すものです。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rules</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> [
        <span class="hljs-comment">// 名前、メールアドレス、主題、本文が必須項目</span>
        [[<span class="hljs-string">'name'</span>, <span class="hljs-string">'email'</span>, <span class="hljs-string">'subject'</span>, <span class="hljs-string">'body'</span>], <span class="hljs-string">'required'</span>],

        <span class="hljs-comment">// email 属性は有効なメールアドレスでなければならない</span>
        [<span class="hljs-string">'email'</span>, <span class="hljs-string">'email'</span>],
    ];
}
</code></pre>
<p><span class="broken-link">yii\base\Model::rules()</span> メソッドは規則の配列を返すべきものですが、その配列の各要素は次の形式の配列でなければなりません。</p>
<pre><code class="hljs php language-php">[
    <span class="hljs-comment">// 必須。この規則によって検証されるべき属性を指定する。</span>
    <span class="hljs-comment">// 属性が一つだけの場合は、配列の中に入れずに、属性の名前を直接に書いてもよい。</span>
    [<span class="hljs-string">'属性1'</span>, <span class="hljs-string">'属性2'</span>, ...],

    <span class="hljs-comment">// 必須。この規則のタイプを指定する。</span>
    <span class="hljs-comment">// クラス名、バリデータのエイリアス、または、バリデーションメソッドの名前。</span>
    <span class="hljs-string">'バリデータ'</span>,

    <span class="hljs-comment">// オプション。この規則が適用されるべき一つまたは複数のシナリオを指定する。</span>
    <span class="hljs-comment">// 指定しない場合は、この規則が全てのシナリオに適用されることを意味する。</span>
    <span class="hljs-comment">// "except" オプションを構成して、列挙したシナリオを除く全てのシナリオに</span>
    <span class="hljs-comment">// この規則が適用されるべきことを指定してもよい。</span>
    <span class="hljs-string">'on'</span> =&gt; [<span class="hljs-string">'シナリオ1'</span>, <span class="hljs-string">'シナリオ2'</span>, ...],

    <span class="hljs-comment">// オプション。バリデータオブジェクトに対する追加の構成情報を指定する。</span>
    <span class="hljs-string">'プロパティ1'</span> =&gt; <span class="hljs-string">'値1'</span>, <span class="hljs-string">'プロパティ2'</span> =&gt; <span class="hljs-string">'値2'</span>, ...
]
</code></pre>
<p>各規則について、最低限、規則がどの属性に適用されるか、そして、規則がどのタイプであるかを指定しなければなりません。
規則のタイプは、次に挙げる形式のどれか一つを選ぶことが出来ます。</p>
<ul>
<li>コアバリデータのエイリアス。例えば、<code>required</code>、<code>in</code>、<code>date</code>、等々。
コアバリデータの完全なリストは <a href="guide-tutorial-core-validators.html">コアバリデータ</a> を参照してください。</li>
<li>モデルクラス内のバリデーションメソッドの名前、または無名関数。詳細は、<a href="#inline-validators">インラインバリデータ</a> の項を参照してください。</li>
<li>完全修飾のバリデータクラス名。詳細は <a href="#standalone-validators">スタンドアロンバリデータ</a> の項を参照してください。</li>
</ul>
<p>一つの規則は、一つまたは複数の属性を検証するために使用することが出来ます。
そして、一つの属性は、一つまたは複数の規則によって検証され得ます。
<code>on</code> オプションを指定することで、規則を特定の <a href="guide-structure-models.html#scenarios">シナリオ</a> においてのみ適用することが出来ます。
<code>on</code> オプションを指定しない場合は、規則が全てのシナリオに適用されることになります。</p>
<p><code>validate()</code> メソッドが呼ばれると、次のステップを踏んで検証が実行されます。</p>
<ol>
<li>現在の <span class="broken-link">yii\base\Model::scenario</span> を使って <span class="broken-link">yii\base\Model::scenarios()</span> から属性のリストを取得し、どの属性が検証されるべきかを決定します。
検証されるべき属性が <em>アクティブな属性</em> と呼ばれます。</li>
<li>現在の <span class="broken-link">yii\base\Model::scenario</span> を使って <span class="broken-link">yii\base\Model::rules()</span> から規則のリストを取得し、どの検証規則が使用されるべきかを決定します。
使用されるべき規則が <em>アクティブな規則</em> と呼ばれます。</li>
<li>全てのアクティブな規則を一つずつ使って、その規則に関連付けられた全てのアクティブな属性を一つずつ検証します。
検証規則はリストに挙げられている順に評価されます。</li>
</ol>
<p>属性は、上記の検証のステップに従って、<code>scenarios()</code> でアクティブな属性であると宣言されており、かつ、<code>rules()</code> で宣言された一つまたは複数のアクティブな規則と関連付けられている場合に、また、その場合に限って、検証されます。</p>
<blockquote class="note"><p><strong>Note: </strong>規則に名前を付けると便利です。すなわち、</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rules</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> [
        <span class="hljs-comment">// ...</span>
        <span class="hljs-string">'password'</span> =&gt; [[<span class="hljs-string">'password'</span>], <span class="hljs-string">'string'</span>, <span class="hljs-string">'max'</span> =&gt; <span class="hljs-number">60</span>],
    ];
}
</code></pre>
<p>これを子のモデルで使うことが出来ます。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rules</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-variable">$rules</span> = <span class="hljs-keyword">parent</span>::rules();
    <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$rules</span>[<span class="hljs-string">'password'</span>]);
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$rules</span>;
}
</code></pre>
</blockquote>
<h3>エラーメッセージをカスタマイズする  <span id="customizing-error-messages"></span><a href="#customizing-error-messages" class="hashlink">&para;</a></h3><p>たいていのバリデータはデフォルトのエラーメッセージを持っていて、属性の検証が失敗した場合にそれを検証の対象であるモデルに追加します。
例えば、<span class="broken-link">yii\validators\RequiredValidator</span> バリデータは、このバリデータを使って <code>username</code> 属性を検証したとき、規則に合致しない場合は「ユーザ名は空ではいけません。」というエラーメッセージをモデルに追加します。</p>
<p>規則のエラーメッセージは、次に示すように、規則を宣言するときに <code>message</code> プロパティを指定することによってカスタマイズすることが出来ます。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rules</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> [
        [<span class="hljs-string">'username'</span>, <span class="hljs-string">'required'</span>, <span class="hljs-string">'message'</span> =&gt; <span class="hljs-string">'ユーザ名を選んでください。'</span>],
    ];
}
</code></pre>
<p>バリデータの中には、検証を失敗させたさまざまな原因をより詳しく説明するための追加のエラーメッセージをサポートしているものがあります。
例えば、<span class="broken-link">yii\validators\NumberValidator</span> バリデータは、検証される値が大きすぎたり小さすぎたりしたときに、検証の失敗を説明するために、それぞれ、<span class="broken-link">yii\validators\NumberValidator::tooBig</span> および <span class="broken-link">yii\validators\NumberValidator::tooSmall</span> のメッセージをサポートしています。
これらのエラーメッセージも、バリデータの他のプロパティと同様、検証規則の中で構成することが出来ます。</p>
<h3>検証のイベント  <span id="validation-events"></span><a href="#validation-events" class="hashlink">&para;</a></h3><p><span class="broken-link">yii\base\Model::validate()</span> は、呼び出されると、検証のプロセスをカスタマイズするためにオーバーライドできる二つのメソッドを呼び出します。</p>
<ul>
<li><span class="broken-link">yii\base\Model::beforeValidate()</span>: デフォルトの実装は <span class="broken-link">yii\base\Model::EVENT_BEFORE_VALIDATE</span> イベントをトリガするものです。
このメソッドをオーバーライドするか、または、イベントに反応して、検証が実行される前に、何らかの前処理 (例えば入力されたデータの正規化) をすることが出来ます。
このメソッドは、検証を続行すべきか否かを示す真偽値を返さなくてはなりません。</li>
<li><span class="broken-link">yii\base\Model::afterValidate()</span>: デフォルトの実装は <span class="broken-link">yii\base\Model::EVENT_AFTER_VALIDATE</span> イベントをトリガするものです。
このメソッドをオーバーライドするか、または、イベントに反応して、検証が完了した後に、何らかの後処理をすることが出来ます。</li>
</ul>
<h3>条件付きの検証  <span id="conditional-validation"></span><a href="#conditional-validation" class="hashlink">&para;</a></h3><p>特定の条件が満たされる場合に限って属性を検証したい場合、例えば、ある属性の検証が他の属性の値に依存する場合には、<span class="broken-link">yii\validators\Validator::when</span> プロパティを使って、そのような条件を定義することが出来ます。
例えば、</p>
<pre><code class="hljs php language-php">    [<span class="hljs-string">'state'</span>, <span class="hljs-string">'required'</span>, <span class="hljs-string">'when'</span> =&gt; <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-variable">$model</span>)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$model</span>-&gt;country == <span class="hljs-string">'USA'</span>;
    }],
</code></pre>
<p><span class="broken-link">yii\validators\Validator::when</span> プロパティは、次のシグニチャを持つ PHP コーラブルを値として取ります。</p>
<pre><code class="hljs php language-php"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> Model $model 検証されるモデル
 * <span class="hljs-doctag">@param</span> string $attribute 検証される属性
 * <span class="hljs-doctag">@return</span> bool 規則が適用されるか否か
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(<span class="hljs-variable">$model</span>, <span class="hljs-variable">$attribute</span>)</span>
</span></code></pre>
<p>クライアント側でも条件付きの検証をサポートする必要がある場合は、<span class="broken-link">yii\validators\Validator::whenClient</span> プロパティを構成しなければなりません。
このプロパティは、規則を適用すべきか否かを返す JavaScript 関数を表す文字列を値として取ります。
例えば、</p>
<pre><code class="hljs php language-php">    [<span class="hljs-string">'state'</span>, <span class="hljs-string">'required'</span>, <span class="hljs-string">'when'</span> =&gt; <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(<span class="hljs-variable">$model</span>)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$model</span>-&gt;country == <span class="hljs-string">'USA'</span>;
    }, <span class="hljs-string">'whenClient'</span> =&gt; <span class="hljs-string">"function (attribute, value) {
        return $('#country').val() == 'USA';
    }"</span>]
</code></pre>
<h3>データのフィルタリング  <span id="data-filtering"></span><a href="#data-filtering" class="hashlink">&para;</a></h3><p>ユーザ入力をフィルタまたは前処理する必要があることがよくあります。
例えば、<code>username</code> の入力値の前後にある空白を除去したいというような場合です。
この目的を達するために検証規則を使うことが出来ます。</p>
<p>次の例では、入力値の前後にある空白を除去して、空の入力値を null に変換することを、<a href="guide-tutorial-core-validators.html#trim">trim</a> および <a href="tutorial-core-validators.md#default">default</a> のコアバリデータで行っています。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">return</span> [
    [[<span class="hljs-string">'username'</span>, <span class="hljs-string">'email'</span>], <span class="hljs-string">'trim'</span>],
    [[<span class="hljs-string">'username'</span>, <span class="hljs-string">'email'</span>], <span class="hljs-string">'default'</span>],
];
</code></pre>
<p>もっと汎用的な <a href="guide-tutorial-core-validators.html#filter">filter</a> バリデータを使って、もっと複雑なデータフィルタリングをすることも出来ます。</p>
<p>お分かりのように、これらの検証規則は実際には入力を検証しません。そうではなくて、検証される属性の値を処理して書き戻すのです。</p>
<h3>空の入力値を扱う  <span id="handling-empty-inputs"></span><a href="#handling-empty-inputs" class="hashlink">&para;</a></h3><p>HTML フォームから入力データが送信されたとき、入力値が空である場合には何らかのデフォルト値を割り当てなければならないことがよくあります。
<a href="guide-tutorial-core-validators.html#default">default</a> バリデータを使ってそうすることが出来ます。
例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">return</span> [
    <span class="hljs-comment">// 空の時は "username" と "email" を null にする</span>
    [[<span class="hljs-string">'username'</span>, <span class="hljs-string">'email'</span>], <span class="hljs-string">'default'</span>],

    <span class="hljs-comment">// 空の時は "level" を 1 にする</span>
    [<span class="hljs-string">'level'</span>, <span class="hljs-string">'default'</span>, <span class="hljs-string">'value'</span> =&gt; <span class="hljs-number">1</span>],
];
</code></pre>
<p>デフォルトでは、入力値が空であると見なされるのは、それが、空文字列であるか、空配列であるか、null であるときです。
空を検知するこのデフォルトのロジックは、<span class="broken-link">yii\validators\Validator::isEmpty</span> プロパティを PHP コーラブルで構成することによって、カスタマイズすることが出来ます。
例えば、</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">return</span> [
    [<span class="hljs-string">'agree'</span>, <span class="hljs-string">'required'</span>, <span class="hljs-string">'isEmpty'</span> =&gt; <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(<span class="hljs-variable">$value</span>)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">empty</span>(<span class="hljs-variable">$value</span>);
    }],
];
</code></pre>
<blockquote class="note"><p><strong>Note: </strong>たいていのバリデータは、<span class="broken-link">yii\validators\Validator::skipOnEmpty</span> プロパティがデフォルト値 <code>true</code> を取っている場合は、空の入力値を処理しません。
  そのようなバリデータは、関連付けられた属性が空の入力値を受け取ったときは、検証の過程ではスキップされるだけになります。
  <a href="guide-tutorial-core-validators.html">コアバリデータ</a> の中では、<code>captcha</code>、<code>default</code>、<code>filter</code>、<code>required</code>、そして <code>trim</code> だけが空の入力値を処理します。</p>
</blockquote>
<h2>その場限りの検証  <span id="ad-hoc-validation"></span><a href="#ad-hoc-validation" class="hashlink">&para;</a></h2><p>時として、何らかのモデルに結び付けられていない値に対する <em>その場限りの検証</em> を実行しなければならない場合があります。</p>
<p>実行する必要がある検証が一種類 (例えば、メールアドレスの検証) だけである場合は、使いたいバリデータの <span class="broken-link">yii\validators\Validator::validate()</span> メソッドを次のように呼び出すことが出来ます。</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$email</span> = <span class="hljs-string">'test@example.com'</span>;
<span class="hljs-variable">$validator</span> = <span class="hljs-keyword">new</span> yii\validators\EmailValidator();

<span class="hljs-keyword">if</span> (<span class="hljs-variable">$validator</span>-&gt;validate(<span class="hljs-variable">$email</span>, <span class="hljs-variable">$error</span>)) {
    <span class="hljs-keyword">echo</span> <span class="hljs-string">'メールアドレスは有効。'</span>;
} <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$error</span>;
}
</code></pre>
<blockquote class="note"><p><strong>Note: </strong>全てのバリデータがこの種の検証をサポートしている訳ではありません。
  その一例が <a href="guide-tutorial-core-validators.html#unique">unique</a> コアバリデータであり、これはモデルとともに使用されることだけを前提にして設計されています。</p>
</blockquote>
<p>いくつかの値に対して複数の検証を実行する必要がある場合は、属性と規則の両方をその場で宣言することが出来る <span class="broken-link">yii\base\DynamicModel</span> を使うことが出来ます。
これは、次のような使い方をします。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">actionSearch</span><span class="hljs-params">(<span class="hljs-variable">$name</span>, <span class="hljs-variable">$email</span>)</span>
</span>{
    <span class="hljs-variable">$model</span> = DynamicModel::validateData(compact(<span class="hljs-string">'name'</span>, <span class="hljs-string">'email'</span>), [
        [[<span class="hljs-string">'name'</span>, <span class="hljs-string">'email'</span>], <span class="hljs-string">'string'</span>, <span class="hljs-string">'max'</span> =&gt; <span class="hljs-number">128</span>],
        [<span class="hljs-string">'email'</span>, <span class="hljs-string">'email'</span>],
    ]);

    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$model</span>-&gt;hasErrors()) {
        <span class="hljs-comment">// 検証が失敗</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 検証が成功</span>
    }
}
</code></pre>
<p><span class="broken-link">yii\base\DynamicModel::validateData()</span> メソッドは <code>DynamicModel</code> のインスタンスを作成し、与えられた値 (この例では <code>name</code> と <code>email</code>) を使って属性を定義し、そして、与えられた規則で <span class="broken-link">yii\base\Model::validate()</span> を呼び出します。</p>
<p>別の選択肢として、次のように、もっと「クラシック」な構文を使って、その場限りのデータ検証を実行することも出来ます。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">actionSearch</span><span class="hljs-params">(<span class="hljs-variable">$name</span>, <span class="hljs-variable">$email</span>)</span>
</span>{
    <span class="hljs-variable">$model</span> = <span class="hljs-keyword">new</span> DynamicModel(compact(<span class="hljs-string">'name'</span>, <span class="hljs-string">'email'</span>));
    <span class="hljs-variable">$model</span>-&gt;addRule([<span class="hljs-string">'name'</span>, <span class="hljs-string">'email'</span>], <span class="hljs-string">'string'</span>, [<span class="hljs-string">'max'</span> =&gt; <span class="hljs-number">128</span>])
        -&gt;addRule(<span class="hljs-string">'email'</span>, <span class="hljs-string">'email'</span>)
        -&gt;validate();

    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$model</span>-&gt;hasErrors()) {
        <span class="hljs-comment">// 検証が失敗</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 検証が成功</span>
    }
}
</code></pre>
<p>検証を実行した後は、通常のモデルで行うのと同様に、検証が成功したか否かを <span class="broken-link">yii\base\DynamicModel::hasErrors()</span> メソッドを呼んでチェックして、<span class="broken-link">yii\base\DynamicModel::errors</span> プロパティから検証エラーを取得することが出来ます。
また、このモデルのインスタンスによって定義された動的な属性に対しても、例えば <code>$model-&gt;name</code> や <code>$model-&gt;email</code> のようにして、アクセスすることが出来ます。</p>
<h2>バリデータを作成する  <span id="creating-validators"></span><a href="#creating-validators" class="hashlink">&para;</a></h2><p>Yii のリリースに含まれている <a href="guide-tutorial-core-validators.html">コアバリデータ</a> を使う以外に、あなた自身のバリデータを作成することも出来ます。
インラインバリデータとスタンドアロンバリデータを作ることが出来ます。</p>
<h3>インラインバリデータ  <span id="inline-validators"></span><a href="#inline-validators" class="hashlink">&para;</a></h3><p>インラインバリデータは、モデルのメソッドまたは無名関数として定義されるバリデータです。
メソッド/関数 のシグニチャは、</p>
<pre><code class="hljs php language-php"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> string $attribute 現在検証されている属性
 * <span class="hljs-doctag">@param</span> mixed $params 規則に与えられる "params" の値
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(<span class="hljs-variable">$attribute</span>, <span class="hljs-variable">$params</span>)</span>
</span></code></pre>
<p>属性が検証に失敗した場合は、メソッド/関数 は <span class="broken-link">yii\base\Model::addError()</span> を呼んでエラーメッセージをモデルに保存し、後で読み出してエンドユーザに表示することが出来るようにしなければなりません。</p>
<p>下記にいくつかの例を示します。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">use</span> <span class="hljs-title">yii</span>\<span class="hljs-title">base</span>\<span class="hljs-title">Model</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyForm</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Model</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$country</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$token</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rules</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-keyword">return</span> [
            <span class="hljs-comment">// モデルメソッド validateCountry() として定義されるインラインバリデータ</span>
            [<span class="hljs-string">'country'</span>, <span class="hljs-string">'validateCountry'</span>],

            <span class="hljs-comment">// 無名関数として定義されるインラインバリデータ</span>
            [<span class="hljs-string">'token'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(<span class="hljs-variable">$attribute</span>, <span class="hljs-variable">$params</span>)</span> </span>{
                <span class="hljs-keyword">if</span> (!ctype_alnum(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-variable">$attribute</span>)) {
                    <span class="hljs-variable">$this</span>-&gt;addError(<span class="hljs-variable">$attribute</span>, <span class="hljs-string">'トークンは英数字で構成しなければなりません。'</span>);
                }
            }],
        ];
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validateCountry</span><span class="hljs-params">(<span class="hljs-variable">$attribute</span>, <span class="hljs-variable">$params</span>)</span>
    </span>{
        <span class="hljs-keyword">if</span> (!in_array(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-variable">$attribute</span>, [<span class="hljs-string">'USA'</span>, <span class="hljs-string">'Web'</span>])) {
            <span class="hljs-variable">$this</span>-&gt;addError(<span class="hljs-variable">$attribute</span>, <span class="hljs-string">'国は "USA" または "Web" でなければなりません。'</span>);
        }
    }
}
</code></pre>
<blockquote class="note"><p><strong>Note: </strong>デフォルトでは、インラインバリデータは、関連付けられている属性が空の入力値を受け取ったり、既に何らかの検証規則に失敗したりしている場合には、適用されません。
規則が常に適用されることを保証したい場合は、規則の宣言において <span class="broken-link">yii\validators\Validator::skipOnEmpty</span> および/または <span class="broken-link">yii\validators\Validator::skipOnError</span> のプロパティを false に設定することが出来ます。
例えば、</p>
<pre><code class="hljs php language-php">[
    [<span class="hljs-string">'country'</span>, <span class="hljs-string">'validateCountry'</span>, <span class="hljs-string">'skipOnEmpty'</span> =&gt; <span class="hljs-keyword">false</span>, <span class="hljs-string">'skipOnError'</span> =&gt; <span class="hljs-keyword">false</span>],
]
</code></pre>
</blockquote>
<h3>スタンドアロンバリデータ  <span id="standalone-validators"></span><a href="#standalone-validators" class="hashlink">&para;</a></h3><p>スタンドアロンバリデータは、<span class="broken-link">yii\validators\Validator</span> またはその子クラスを拡張するクラスです。
<span class="broken-link">yii\validators\Validator::validateAttribute()</span> メソッドをオーバーライドすることによって、その検証ロジックを実装することが出来ます。
<a href="#inline-validators">インラインバリデータ</a> でするのと同じように、属性が検証に失敗した場合は、<span class="broken-link">yii\base\Model::addError()</span> を呼んでエラーメッセージをモデルに保存します。</p>
<p>例えば、上記のインラインバリデータは、新しい [[components/validators/CountryValidator]] クラスに作りかえることが出来ます。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">namespace</span> <span class="hljs-title">app</span>\<span class="hljs-title">components</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">yii</span>\<span class="hljs-title">validators</span>\<span class="hljs-title">Validator</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CountryValidator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Validator</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validateAttribute</span><span class="hljs-params">(<span class="hljs-variable">$model</span>, <span class="hljs-variable">$attribute</span>)</span>
    </span>{
        <span class="hljs-keyword">if</span> (!in_array(<span class="hljs-variable">$model</span>-&gt;<span class="hljs-variable">$attribute</span>, [<span class="hljs-string">'USA'</span>, <span class="hljs-string">'Web'</span>])) {
            <span class="hljs-variable">$this</span>-&gt;addError(<span class="hljs-variable">$model</span>, <span class="hljs-variable">$attribute</span>, <span class="hljs-string">'国は "USA" または "Web" でなければなりません。'</span>);
        }
    }
}
</code></pre>
<p>あなたのバリデータで、モデルを使わない値の検証をサポートしたい場合は、<span class="broken-link">yii\validators\Validator::validate()</span> もオーバーライドしなければなりません。
または、<code>validateAttribute()</code> と <code>validate()</code> の代りに、<span class="broken-link">yii\validators\Validator::validateValue()</span> をオーバーライドしても構いません。
と言うのは、前の二つは、デフォルトでは、<code>validateValue()</code> を呼び出すことによって実装されているからです。</p>
<p>次の例は、上記のバリデータクラスをあなたのモデルの中でどのように使用することが出来るかを示すものです。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">namespace</span> <span class="hljs-title">app</span>\<span class="hljs-title">models</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Yii</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">yii</span>\<span class="hljs-title">base</span>\<span class="hljs-title">Model</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">app</span>\<span class="hljs-title">components</span>\<span class="hljs-title">validators</span>\<span class="hljs-title">CountryValidator</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EntryForm</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Model</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$email</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$country</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rules</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-keyword">return</span> [
            [[<span class="hljs-string">'name'</span>, <span class="hljs-string">'email'</span>], <span class="hljs-string">'required'</span>],
            [<span class="hljs-string">'country'</span>, CountryValidator::className()],
            [<span class="hljs-string">'email'</span>, <span class="hljs-string">'email'</span>],
        ];
    }
}
</code></pre>
<h2>クライアント側での検証  <span id="client-side-validation"></span><a href="#client-side-validation" class="hashlink">&para;</a></h2><p>エンドユーザが HTML フォームで値を入力する際には、JavaScript に基づくクライアント側での検証を提供することが望まれます。
というのは、クライアント側での検証は、ユーザが入力のエラーを早く見つけることが出来るようにすることによって、より良いユーザ体験を提供するものだからです。
あなたも、サーバ側での検証 <em>に加えて</em> クライアント側での検証をサポートするバリデータを使用したり実装したりすることが出来ます。</p>
<blockquote class="info"><p><strong>Info: </strong>クライアント側での検証は望ましいものですが、不可欠なものではありません。
  その主たる目的は、ユーザにより良い体験を提供することにあります。
  エンドユーザから来る入力値と同じように、クライアント側での検証を決して信用してはいけません。
  この理由により、これまでの項で説明したように、常に <span class="broken-link">yii\base\Model::validate()</span> を呼び出してサーバ側での検証を実行しなければなりません。</p>
</blockquote>
<h3>クライアント側での検証を使う  <span id="using-client-side-validation"></span><a href="#using-client-side-validation" class="hashlink">&para;</a></h3><p>多くの <a href="guide-tutorial-core-validators.html">コアバリデータ</a> は、そのままで、クライアント側での検証をサポートしています。
あなたがする必要があるのは、<span class="broken-link">yii\widgets\ActiveForm</span> を使って HTML フォームを作るということだけです。
例えば、下の <code>LoginForm</code> は二つの規則を宣言しています。
一つは、<a href="guide-tutorial-core-validators.html#required">required</a> コアバリデータを使っていますが、これはクライアント側とサーバ側の両方でサポートされています。
もう一つは <code>validatePassword</code> インラインバリデータを使っていますが、こちらはサーバ側でのみサポートされています。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">namespace</span> <span class="hljs-title">app</span>\<span class="hljs-title">models</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">yii</span>\<span class="hljs-title">base</span>\<span class="hljs-title">Model</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">app</span>\<span class="hljs-title">models</span>\<span class="hljs-title">User</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoginForm</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Model</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$password</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rules</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-keyword">return</span> [
            <span class="hljs-comment">// username と password はともに必須</span>
            [[<span class="hljs-string">'username'</span>, <span class="hljs-string">'password'</span>], <span class="hljs-string">'required'</span>],

            <span class="hljs-comment">// password は validatePassword() によって検証される</span>
            [<span class="hljs-string">'password'</span>, <span class="hljs-string">'validatePassword'</span>],
        ];
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validatePassword</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-variable">$user</span> = User::findByUsername(<span class="hljs-variable">$this</span>-&gt;username);

        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$user</span> || !<span class="hljs-variable">$user</span>-&gt;validatePassword(<span class="hljs-variable">$this</span>-&gt;password)) {
            <span class="hljs-variable">$this</span>-&gt;addError(<span class="hljs-string">'password'</span>, <span class="hljs-string">'ユーザ名またはパスワードが違います。'</span>);
        }
    }
}
</code></pre>
<p>次のコードによって構築される HTML フォームは、<code>username</code> と <code>password</code> の二つの入力フィールドを含みます。
何も入力せずにこのフォームを送信すると、何かを入力するように要求するエラーメッセージが、サーバと少しも交信することなく、ただちに表示されることに気付くでしょう。</p>
<pre><code class="hljs php language-php"><span class="hljs-preprocessor">&lt;?php</span> <span class="hljs-variable">$form</span> = yii\widgets\ActiveForm::begin(); <span class="hljs-preprocessor">?&gt;</span>
    <span class="hljs-preprocessor">&lt;?</span>= <span class="hljs-variable">$form</span>-&gt;field(<span class="hljs-variable">$model</span>, <span class="hljs-string">'username'</span>) <span class="hljs-preprocessor">?&gt;</span>
    <span class="hljs-preprocessor">&lt;?</span>= <span class="hljs-variable">$form</span>-&gt;field(<span class="hljs-variable">$model</span>, <span class="hljs-string">'password'</span>)-&gt;passwordInput() <span class="hljs-preprocessor">?&gt;</span>
    <span class="hljs-preprocessor">&lt;?</span>= Html::submitButton(<span class="hljs-string">'ログイン'</span>) <span class="hljs-preprocessor">?&gt;</span>
<span class="hljs-preprocessor">&lt;?php</span> yii\widgets\ActiveForm::end(); <span class="hljs-preprocessor">?&gt;</span>
</code></pre>
<p>舞台裏では、<span class="broken-link">yii\widgets\ActiveForm</span> がモデルで宣言されている検証規則を読んで、クライアント側の検証をサポートするバリデータのために、適切な JavaScript コードを生成します。
ユーザが入力フィールドの値を変更したりフォームを送信したりすると、クライアント側の検証の JavaScript が起動されます。</p>
<p>クライアント側の検証を完全に無効にしたい場合は、<span class="broken-link">yii\widgets\ActiveForm::enableClientValidation</span> プロパティを false に設定することが出来ます。
また、個々の入力フィールドごとにクライアント側の検証を無効にしたい場合には、入力フィールドの <span class="broken-link">yii\widgets\ActiveField::enableClientValidation</span> プロパティを false に設定することが出来ます。
<code>eanbleClientValidation</code> が入力フィールドのレベルとフォームのレベルの両方で構成されている場合は前者が優先されます。</p>
<h3>クライアント側の検証を実装する  <span id="implementing-client-side-validation"></span><a href="#implementing-client-side-validation" class="hashlink">&para;</a></h3><p>クライアント側の検証をサポートするバリデータを作成するためには、クライアント側での検証を実行する JavaScript コードを返す <span class="broken-link">yii\validators\Validator::clientValidateAttribute()</span> メソッドを実装しなければなりません。
その JavaScript の中では、次の事前定義された変数を使用することが出来ます。</p>
<ul>
<li><code>attribute</code>: 検証される属性の名前。</li>
<li><code>value</code>: 検証される値。</li>
<li><code>messages</code>: 属性に対する検証のエラーメッセージを保持するために使用される配列。</li>
<li><code>deferred</code>: Deferred オブジェクトをプッシュして入れることが出来る配列 (次の項で説明します)。</li>
</ul>
<p>次の例では、入力された値が既存のステータスのデータに含まれる有効なステータス値であるかどうかを検証する <code>StatusValidator</code> を作成します。
このバリデータは、サーバ側とクライアント側の両方の検証をサポートします。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">namespace</span> <span class="hljs-title">app</span>\<span class="hljs-title">components</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">yii</span>\<span class="hljs-title">validators</span>\<span class="hljs-title">Validator</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">app</span>\<span class="hljs-title">models</span>\<span class="hljs-title">Status</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StatusValidator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Validator</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-keyword">parent</span>::init();
        <span class="hljs-variable">$this</span>-&gt;message = <span class="hljs-string">'無効なステータスが入力されました。'</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validateAttribute</span><span class="hljs-params">(<span class="hljs-variable">$model</span>, <span class="hljs-variable">$attribute</span>)</span>
    </span>{
        <span class="hljs-variable">$value</span> = <span class="hljs-variable">$model</span>-&gt;<span class="hljs-variable">$attribute</span>;
        <span class="hljs-keyword">if</span> (!Status::find()-&gt;where([<span class="hljs-string">'id'</span> =&gt; <span class="hljs-variable">$value</span>])-&gt;exists()) {
            <span class="hljs-variable">$model</span>-&gt;addError(<span class="hljs-variable">$attribute</span>, <span class="hljs-variable">$this</span>-&gt;message);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clientValidateAttribute</span><span class="hljs-params">(<span class="hljs-variable">$model</span>, <span class="hljs-variable">$attribute</span>, <span class="hljs-variable">$view</span>)</span>
    </span>{
        <span class="hljs-variable">$statuses</span> = json_encode(Status::find()-&gt;select(<span class="hljs-string">'id'</span>)-&gt;asArray()-&gt;column());
        <span class="hljs-variable">$message</span> = json_encode(<span class="hljs-variable">$this</span>-&gt;message, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE);
        <span class="hljs-keyword">return</span> <span class="hljs-string">&lt;&lt;&lt;JS
if ($.inArray(value, <span class="hljs-subst">$statuses</span>) === -1) {
    messages.push(<span class="hljs-subst">$message</span>);
}
JS;</span>
    }
}
</code></pre>
<blockquote class="tip"><p><strong>Tip: </strong>上記のコード例の主たる目的は、クライアント側の検証をサポートする方法を説明することにあります。
実際の仕事では、<a href="guide-tutorial-core-validators.html#in">in</a> コアバリデータを使って、同じ目的を達することが出来ます。
次のように検証規則を書けばよいのです。</p>
<pre><code class="hljs php language-php">[
    [<span class="hljs-string">'status'</span>, <span class="hljs-string">'in'</span>, <span class="hljs-string">'range'</span> =&gt; Status::find()-&gt;select(<span class="hljs-string">'id'</span>)-&gt;asArray()-&gt;column()],
]
</code></pre>
</blockquote>
<blockquote class="tip"><p><strong>Tip: </strong>クライアント側の検証を手動で操作する必要がある場合、すなわち、動的にフィールドを追加したり、何か特殊な UI ロジックを実装する場合は、
Yii 2.0 Cookbook の <a href="https://github.com/samdark/yii2-cookbook/blob/master/book/forms-activeform-js.md">Working with ActiveForm via JavaScript</a> を参照してください。</p>
</blockquote>
<h3>Deferred 検証  <span id="deferred-validation"></span><a href="#deferred-validation" class="hashlink">&para;</a></h3><p>非同期のクライアント側の検証をサポートする必要がある場合は、<a href="http://api.jquery.com/category/deferred-object/">Defered オブジェクト</a> を作成することが出来ます。
例えば、AJAX によるカスタム検証を実行するために、次のコードを使うことが出来ます。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clientValidateAttribute</span><span class="hljs-params">(<span class="hljs-variable">$model</span>, <span class="hljs-variable">$attribute</span>, <span class="hljs-variable">$view</span>)</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-string">&lt;&lt;&lt;JS
        deferred.push($.get("/check", {value: value}).done(function(data) {
            if ('' !== data) {
                messages.push(data);
            }
        }));
JS;</span>
}
</code></pre>
<p>上のコードにおいて、<code>deferred</code> は Yii が提供する変数で、Deferred オブジェクトの配列です。
jQuery の <code>$.get()</code> メソッドによって作成された Deferred オブジェクトが <code>deferred</code> 配列にプッシュされています。</p>
<p>Deferred オブジェクトを明示的に作成して、非同期のコールバックが呼ばれたときに、Deferred オブジェクトの <code>resolve()</code> メソッドを呼ぶことも出来ます。
次の例は、アップロードされる画像ファイルの大きさをクライアント側で検証する方法を示すものです。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clientValidateAttribute</span><span class="hljs-params">(<span class="hljs-variable">$model</span>, <span class="hljs-variable">$attribute</span>, <span class="hljs-variable">$view</span>)</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-string">&lt;&lt;&lt;JS
        var def = $.Deferred();
        var img = new Image();
        img.onload = function() {
            if (this.width &gt; 150) {
                messages.push('画像の幅が大きすぎます。');
            }
            def.resolve();
        }
        var reader = new FileReader();
        reader.onloadend = function() {
            img.src = reader.result;
        }
        reader.readAsDataURL(file);

        deferred.push(def);
JS;</span>
}
</code></pre>
<blockquote class="note"><p><strong>Note: </strong>属性が検証された後に、<code>resolve()</code> メソッドを呼び出さなければなりません。
  そうしないと、主たるフォームの検証が完了しません。</p>
</blockquote>
<p>簡潔に記述できるように、<code>deferred</code> 配列はショートカットメソッド <code>add()</code> を装備しており、このメソッドを使うと、自動的に Deferred オブジェクトを作成して <code>deferred</code> 配列に追加することが出来ます。
このメソッドを使えば、上記の例は次のように簡潔に記すことが出来ます。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clientValidateAttribute</span><span class="hljs-params">(<span class="hljs-variable">$model</span>, <span class="hljs-variable">$attribute</span>, <span class="hljs-variable">$view</span>)</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-string">&lt;&lt;&lt;JS
        deferred.add(function(def) {
            var img = new Image();
            img.onload = function() {
                if (this.width &gt; 150) {
	                messages.push('画像の幅が大きすぎます。');
                }
                def.resolve();
            }
            var reader = new FileReader();
            reader.onloadend = function() {
                img.src = reader.result;
            }
            reader.readAsDataURL(file);
        });
JS;</span>
}
</code></pre>
<h3>AJAX 検証  <span id="ajax-validation"></span><a href="#ajax-validation" class="hashlink">&para;</a></h3><p>場合によっては、サーバだけが必要な情報を持っているために、サーバ側でしか検証が実行できないことがあります。
例えば、ユーザ名がユニークであるか否かを検証するためには、サーバ側で user テーブルを調べることが必要になります。
このような場合には、AJAX ベースの検証を使うことが出来ます。
AJAX 検証は、通常のクライアント側での検証と同じユーザ体験を保ちながら、入力値を検証するためにバックグラウンドで AJAX リクエストを発行します。</p>
<p>単一のインプットフィールドに対して AJAX 検証を有効にするためには、そのフィールドの <span class="broken-link">yii\widgets\ActiveField::enableAjaxValidation</span> プロパティを true に設定し、フォームに一意の <code>id</code> を指定します。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">use</span> <span class="hljs-title">yii</span>\<span class="hljs-title">widgets</span>\<span class="hljs-title">ActiveForm</span>;

<span class="hljs-variable">$form</span> = ActiveForm::begin([
    <span class="hljs-string">'id'</span> =&gt; <span class="hljs-string">'registration-form'</span>,
]);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$form</span>-&gt;field(<span class="hljs-variable">$model</span>, <span class="hljs-string">'username'</span>, [<span class="hljs-string">'enableAjaxValidation'</span> =&gt; <span class="hljs-keyword">true</span>]);

<span class="hljs-comment">// ...</span>

ActiveForm::end();
</code></pre>
<p>フォーム全体に対して AJAX 検証を有効にするためには、フォームのレベルで <span class="broken-link">yii\widgets\ActiveForm::enableAjaxValidation</span> を true に設定します。</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$form</span> = ActiveForm::begin([
    <span class="hljs-string">'id'</span> =&gt; <span class="hljs-string">'contact-form'</span>,
    <span class="hljs-string">'enableAjaxValidation'</span> =&gt; <span class="hljs-keyword">true</span>,
]);
</code></pre>
<blockquote class="note"><p><strong>Note: </strong><code>enableAjaxValidation</code> プロパティがインプットフィールドのレベルとフォームのレベルの両方で構成された場合は、前者が優先されます。</p>
</blockquote>
<p>また、サーバ側では、AJAX 検証のリクエストを処理できるように準備しておく必要があります。
これは、コントローラのアクションにおいて、次のようなコード断片を使用することで達成できます。</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">if</span> (Yii::<span class="hljs-variable">$app</span>-&gt;request-&gt;isAjax &amp;&amp; <span class="hljs-variable">$model</span>-&gt;load(Yii::<span class="hljs-variable">$app</span>-&gt;request-&gt;post())) {
    Yii::<span class="hljs-variable">$app</span>-&gt;response-&gt;format = Response::FORMAT_JSON;
    <span class="hljs-keyword">return</span> ActiveForm::validate(<span class="hljs-variable">$model</span>);
}
</code></pre>
<p>上記のコードは、現在のリクエストが AJAX であるかどうかをチェックします。
もし AJAX であるなら、リクエストに応えて検証を実行し、エラーを JSON 形式で返します。</p>
<blockquote class="info"><p><strong>Info: </strong>AJAX 検証を実行するためには、<a href="#deferred-validation">Deferred 検証</a> を使うことも出来ます。
  しかし、ここで説明された AJAX 検証の機能の方がより体系化されており、コーディングの労力も少なくて済みます。</p>
</blockquote>
<p><code>enableClientValidation</code> と <code>enableAjaxValidation</code> が両方とも真に設定されているときは、クライアント検証が成功した後でだけ AJAX 検証が起動されます。</p>
        <div class="toplink"><a href="#" class="h1" title="go to top"><span class="glyphicon glyphicon-arrow-up"></a></div>
    </div>
</div>


</div>

<footer class="footer">
        <p class="pull-right"><small>Page generated on Tue, 27 Dec 2016 22:28:43 +0000</small></p>
    Powered by <a href="http://www.yiiframework.com/" rel="external">Yii Framework</a></footer>

<script type="text/javascript">jQuery(document).ready(function () {
    var shiftWindow = function () { scrollBy(0, -50) };
    if (location.hash) setTimeout(shiftWindow, 1);
    window.addEventListener("hashchange", shiftWindow);
var element = document.createElement("script");
element.src = "./jssearch.index.js";
document.body.appendChild(element);

var searchBox = $('#searchbox');

// search when typing in search field
searchBox.on("keyup", function(event) {
    var query = $(this).val();

    if (query == '' || event.which == 27) {
        $('#search-resultbox').hide();
        return;
    } else if (event.which == 13) {
        var selectedLink = $('#search-resultbox a.selected');
        if (selectedLink.length != 0) {
            document.location = selectedLink.attr('href');
            return;
        }
    } else if (event.which == 38 || event.which == 40) {
        $('#search-resultbox').show();

        var selected = $('#search-resultbox a.selected');
        if (selected.length == 0) {
            $('#search-results').find('a').first().addClass('selected');
        } else {
            var next;
            if (event.which == 40) {
                next = selected.parent().next().find('a').first();
            } else {
                next = selected.parent().prev().find('a').first();
            }
            if (next.length != 0) {
                var resultbox = $('#search-results');
                var position = next.position();

//              TODO scrolling is buggy and jumps around
//                resultbox.scrollTop(Math.floor(position.top));
//                console.log(position.top);

                selected.removeClass('selected');
                next.addClass('selected');
            }
        }

        return;
    }
    $('#search-resultbox').show();
    $('#search-results').html('<li><span class="no-results">No results</span></li>');

    var result = jssearch.search(query);

    if (result.length > 0) {
        var i = 0;
        var resHtml = '';

        for (var key in result) {
            if (i++ > 20) {
                break;
            }
            resHtml = resHtml +
            '<li><a href="' + result[key].file.u.substr(3) +'"><span class="title">' + result[key].file.t + '</span>' +
            '<span class="description">' + result[key].file.d + '</span></a></li>';
        }
        $('#search-results').html(resHtml);
    }
});

// hide the search results on ESC
$(document).on("keyup", function(event) { if (event.which == 27) { $('#search-resultbox').hide(); } });
// hide search results on click to document
$(document).bind('click', function (e) { $('#search-resultbox').hide(); });
// except the following:
searchBox.bind('click', function(e) { e.stopPropagation(); });
$('#search-resultbox').bind('click', function(e) { e.stopPropagation(); });

});</script></body>
</html>
